<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE project>

<project name="AMIWebApp" default="compile_prod">

	<!-- ************************************************************ -->

	<tstamp>
		<format property="year" pattern="yyyy" />
	</tstamp>

	<!-- ************************************************************ -->

	<target name="compile_prod" description="Compile the project (prod mode).">

		<!-- **************************************************** -->
		<!-- MERGE FILES                                          -->
		<!-- **************************************************** -->

		<merge-files />

		<!-- **************************************************** -->
		<!-- GENERATE MINIMIZED FILES                             -->
		<!-- **************************************************** -->

		<java classname="net.hep.ami.awf.CssCompressor" failonerror="true" fork="true">
			<classpath location="tools/awf.jar" />
			<arg value="css/AMI/framework.min.css" />
			<arg value="css/AMI/framework.css" />
		</java>

		<java classname="net.hep.ami.awf.JsCompressor" failonerror="true" fork="true">
			<classpath location="tools/awf.jar" />
			<arg value="js/AMI/framework.min.js" />
			<arg value="js/AMI/framework.js" />
		</java>

		<!-- **************************************************** -->

	</target>

	<!-- ************************************************************ -->

	<target name="compile_debug" description="Compile the project (debug mode).">

		<!-- **************************************************** -->
		<!-- MERGE FILES                                          -->
		<!-- **************************************************** -->

		<merge-files />

		<!-- **************************************************** -->
		<!-- GENERATE MINIMIZED FILES                             -->
		<!-- **************************************************** -->

		<copy file="css/AMI/framework.css" tofile="css/AMI/framework.min.css" overwrite="true" />

		<copy file="js/AMI/framework.js" tofile="js/AMI/framework.min.js" overwrite="true" />

		<!-- **************************************************** -->

	</target>

	<!-- ************************************************************ -->

	<target name="clean" description="Clean the project.">

		<delete file="css/AMI/AMIWebApp.min.css" />

		<delete file="js/AMI/framework.min.js" />

	</target>

	<!-- ************************************************************ -->

	<target name="make-home-page" description="New home page.">

		<java classname="net.hep.ami.awf.NewHomePage" failonerror="true" fork="true">
			<classpath location="tools/awf.jar" />
		</java>

	</target>

	<!-- ************************************************************ -->

	<target name="make-control" description="New control.">

		<java classname="net.hep.ami.awf.NewControl" failonerror="true" fork="true">
			<classpath location="tools/awf.jar" />
		</java>

	</target>

	<!-- ************************************************************ -->

	<target name="make-subapp" description="New sub app.">

		<java classname="net.hep.ami.awf.NewSubApp" failonerror="true" fork="true">
			<classpath location="tools/awf.jar" />
		</java>

	</target>

	<!-- ************************************************************ -->

	<target name="lint_framework" description="Code quality.">

		<!-- npm install -g eslint -->
		<!-- http://eslint.org/ -->

		<exec executable="bash">
			<env key="PATH" value="/usr/local/bin:/usr/bin" />
			<arg value="-c" />
			<arg value="eslint js/AMI/framework.js" />
		</exec>

	</target>

	<!-- ************************************************************ -->

	<target name="lint_subapp" description="Code quality.">

		<!-- npm install -g eslint -->
		<!-- http://eslint.org/ -->

		<exec executable="bash">
			<env key="PATH" value="/usr/local/bin:/usr/bin" />
			<arg value="-c" />
			<arg value="eslint subapps/**/js/*.js" />
		</exec>

	</target>

	<!-- ************************************************************ -->

	<target name="doc" description="Generate doc.">

		<!-- npm install -g jsdoc -->
		<!-- http://usejsdoc.org/ -->

		<exec executable="bash">
			<env key="PATH" value="/usr/local/bin:/usr/bin" />
			<arg value="-c" />
			<arg value="jsdoc --template tools/jsdoc -d console js/AMI/AMIWebApp.js js/AMI/AMIInterface.js js/AMI/AMICommand.js js/AMI/AMILogin.js > js/AMI/api.min.json" />
		</exec>

	</target>

	<!-- ************************************************************ -->

	<macrodef name="merge-files">

		<sequential>

			<!-- ******************************************** -->

			<concat destfile="js/AMI/framework.js" fixlastline="true" encoding="UTF-8" outputencoding="UTF-8">

				<header>{{USE_STRICT}}</header>

				<filelist dir="js/AMI">
					<file name="external/ami-twig.js" />
					<file name="external/jspath.js" />
					<file name="AMIObject.js" />
					<file name="AMIWebApp.js" />
					<file name="AMIInterface.js" />
					<file name="AMICommand.js" />
					<file name="AMILogin.js" />
				</filelist>

			</concat>

			<!-- ******************************************** -->

			<replace file="js/AMI/framework.js" token="'use strict';${line.separator}${line.separator}" value="" />

			<replace file="js/AMI/framework.js" token="'use strict';${line.separator}" value="" />

			<replace file="js/AMI/framework.js" token="'use strict';" value="" />

			<!-- ******************************************** -->

			<replace file="js/AMI/framework.js" token="{{USE_STRICT}}" value="'use strict';${line.separator}" />

			<!-- ******************************************** -->

			<replace file="js/AMI/framework.js" token="JSPath = decl;" value="window.JSPath = decl;" />

			<!-- ******************************************** -->

			<replace file="js/AMI/framework.js" token="{{YEAR}}" value="${year}" />

			<!-- ******************************************** -->

		</sequential>

	</macrodef>

	<!-- ************************************************************ -->

</project>
