/*-------------------------------------------------------------------------*/

function _my_rounded_rect(x, y, w, h, r, tl, tr, bl, br) {

	var retval = "M" + (x + r) + "," + y;

	retval += "h" + (w - 2 * r);
	if(tr) {
		retval += "a" + r + "," + r + " 0 0 1 " + (+r) + "," + (+r);
	} else {
		retval += "h" + (+r);
		retval += "v" + (+r);
	}

	retval += "v" + (h - 2 * r);
	if(br) {
		retval += "a" + r + "," + r + " 0 0 1 " + (-r) + "," + (+r);
	}
	else {
		retval += "v" + (+r);
		retval += "h" + (-r);
	}

	retval += "h" + (2 * r - w);
	if(bl) {
		retval += "a" + r + "," + r + " 0 0 1 " + (-r) + "," + (-r);
	}
	else {
		retval += "h" + (-r);
		retval += "v" + (-r);
	}

	retval += "v" + (2 * r - h);
	if(tl) {
		retval += "a" + r + "," + r + " 0 0 1 " + (+r) + "," + (-r);
	} else {
		retval += "v" + (-r);
		retval += "h" + (+r);
	}

	return retval + "z";
}

/*-------------------------------------------------------------------------*/

function _get_l(color)
{
	var r = parseInt('0x' + color.substring(1, 3));
	var g = parseInt('0x' + color.substring(3, 5));
	var b = parseInt('0x' + color.substring(5, 7));

	return (Math.min(r, g, b) + Math.max(r, g, b)) / (2.0 * 255);
}

/*-------------------------------------------------------------------------*/

joint.shapes.sql = {}

/*-------------------------------------------------------------------------*/

joint.shapes.sql.Table = joint.shapes.basic.Generic.extend({
	/*-----------------------------------------------------------------*/

	markup: [
		'<g>',
		  '<path class="sql-table-top" />',
		  '<path class="sql-table-body" />',
		  '<text class="sql-table-name" />',
		  '<text class="sql-table-fields" />',
		'</g>'
	].join(''),

	/*-----------------------------------------------------------------*/

	defaults: joint.util.deepSupplement({

		type: 'sql.Table',

		size: {
			width: 228,
			height: 14,
		},

		attrs: {
			'.sql-table-top': {
				'stroke-width': 2,
			},

			'.sql-table-body': {
				'stroke-width': 2,
			},
			'.sql-table-name': {
				'ref': '.sql-table-top',
				'ref-y': 0.55,
				'ref-x': 0.5,
				'x-alignment': 'middle',
				'y-alignment': 'middle',
				'fill': 'white',
				'font-family': 'Courier New',
				'font-weight': 'bold',
				'font-size': 14,
			},
			'.sql-table-fields': {
				'ref': '.sql-table-body',
				'ref-y': 7.5,
				'ref-x': 10,
				'fill': 'black',
				'font-family': 'Courier New',
				'font-weight': 'normal',
				'font-size': 14,
			},
		},

		name: '',
		encoding: '',
		topColor: '#0066CC',
		bodyColor: '#FFFFFF',
		strokeColor: '#0057AD',
		fields: [],
		fekeys: [],
		indices: [],

	}, joint.shapes.basic.Generic.prototype.defaults),

	/*-----------------------------------------------------------------*/

	initialize: function() {

		this.on({
			'change:name': this.updateName,
			'change:topColor': this.updateColors,
			'change:bodyColor': this.updateColors,
			'change:strokeColor': this.updateColors,
			'change:fields': this.updateFields,

		}, this);

		this.updateName();
		this.updateColors();
		this.updateFields();

		joint.shapes.basic.Generic.prototype.initialize.apply(this, arguments);
	},

	/*-----------------------------------------------------------------*/

	getName: function() {
		return this.get('name');
	},

	setName: function(name) {
		this.set('name', name);
		this.updateName();
	},

	/*-----------------------------------------------------------------*/

	getEncoding: function() {
		return this.get('encoding');
	},

	setEncoding: function(encoding) {
		this.set('encoding', encoding);
		this.updateEncoding();
	},

	/*-----------------------------------------------------------------*/

	getTopColor: function() {
		return this.get('topColor');
	},

	setTopColor: function(color) {
		this.attr('.sql-table-name/fill', _get_l(color) > 0.5 ? '#000000' : '#FFFFFF');
		this.set('topColor', color);
		this.updateColors();
	},

	/*-----------------------------------------------------------------*/

	getBodyColor: function() {
		return this.get('bodyColor');
	},

	setBodyColor: function(color) {
		this.attr('sql-table-fields/fill', _get_l(color) > 0.5 ? '#000000' : '#FFFFFF');
		this.set('bodyColor', color);
		this.updateColors();
	},

	/*-----------------------------------------------------------------*/

	getStrokeColor: function() {
		return this.get('strokeColor');
	},

	setStrokeColor: function(color) {
		this.set('strokeColor', color);
		this.updateColors();
	},

	/*-----------------------------------------------------------------*/

	getFields: function() {
		return this.get('fields');
	},

	setFields: function(fields) {
		this.set('fields', fields);
		this.updateFields();
	},

	/*-----------------------------------------------------------------*/

	appendField: function(item) {
		var fields = this.get('fields');
		fields.push(item);
		this.set('fields', fields);

		this.updateFields();
	},

	removeField: function(index) {
		var fields = this.get('fields');
		fields.splice(index, 1);
		this.set('fields', fields);

		this.updateFields();
	},

	getField: function(index) {
		return this.get('fields')[index];
	},

	setField: function(index, item) {
		var fields = this.get('fields');
		fields[index] = item;
		this.set('fields', fields);

		this.updateFields();
	},

	/*-----------------------------------------------------------------*/

	getFeKeys: function() {
		return this.get('fekeys');
	},

	setFeKeys: function(fekeys) {
		this.set('fekeys', fekeys);
	},

	/*-----------------------------------------------------------------*/

	appendFeKey: function(item) {
		var fekeys = this.get('fekeys');
		fekeys.push(item);
		this.set('fekeys', fekeys);
	},

	removeFeKey: function(index) {
		var fekeys = this.get('fekeys');
		fekeys.splice(index, 1);
		this.set('fekeys', fekeys);
	},

	getFeKey: function(index) {
		return this.get('fekeys')[index];
	},

	setFeKey: function(index, item) {
		var fekeys = this.get('fekeys');
		fekeys[index] = item;
		this.set('fekeys', fekeys);
	},

	/*-----------------------------------------------------------------*/

	getIndices: function() {
		return this.get('indices');
	},

	setIndices: function(indices) {
		this.set('indices', indices);
	},

	/*-----------------------------------------------------------------*/

	appendIndex: function(item) {
		var indices = this.get('indices');
		indices.push(item);
		this.set('indices', indices);
	},

	removeIndex: function(index) {
		var indices = this.get('indices');
		indices.splice(index, 1);
		this.set('indices', indices);
	},

	getIndex: function(index) {
		return this.get('indices')[index];
	},

	setIndex: function(index, item) {
		var indices = this.get('indices');
		indices[index] = item;
		this.set('indices', indices);
	},

	/*-----------------------------------------------------------------*/

	updateName: function() {

		this.attr('.sql-table-name/text', this.get('name').toUpperCase());
	},

	/*-----------------------------------------------------------------*/

	updateEncoding: function() {

		/* TODO */
	},

	/*-----------------------------------------------------------------*/

	updateColors: function() {

		this.attr('.sql-table-top/fill', this.get('topColor'));
		this.attr('.sql-table-top/stroke', this.get('strokeColor'));

		this.attr('.sql-table-body/fill', this.get('bodyColor'));
		this.attr('.sql-table-body/stroke', this.get('strokeColor'));
	},

	/*-----------------------------------------------------------------*/

	updateFields: function() {

		var nr = 0
		var text = '';

		_.each(this.get('fields'), function(field) {

			nr++;

			var line = field.name + ': ' + field.type;

			if(line.length > 26) {
				line = line.substring(0, 24) + 'â€¦';
			}

			text += line + '\n';
		});

		var width = this.get('size').width;
		var height = Math.ceil((nr * 14 + 20) / 10.0) * 10 - 2;

		this.resize(width, height);

		width += 1; // For nice overlap
		height += 1; // For nice overlap

		this.attr('.sql-table-top/d', _my_rounded_rect(0, 0, width, 20, 8, true, true, false, false));
		this.attr('.sql-table-body/d', _my_rounded_rect(0, 20, width, height, 2, false, false, true, true));

		this.attr('.sql-table-fields/text', text);
	}

	/*-----------------------------------------------------------------*/
});

/*-------------------------------------------------------------------------*/

joint.dia.Graph.prototype.newTable = function(table) {

	var result = new joint.shapes.sql.Table(table);

	result.set('fields', []);
	result.set('fekeys', []);
	result.set('indices', []);

	this.addCell(result);

	return result;
};

/*-------------------------------------------------------------------------*/
