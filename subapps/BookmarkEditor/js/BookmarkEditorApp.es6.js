/*!
 * AMI Web Framework
 *
 * Copyright (c) 2014-XXXX The AMI Team / LPSC / CNRS
 *
 * This file must be used under the terms of the CeCILL-C:
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-fr.html
 *
 */

/*--------------------------------------------------------------------------------------------------------------------*/

$AMIClass('BookmarkEditorApp', {
	/*----------------------------------------------------------------------------------------------------------------*/

	$extends: ami.SubApp,

	/*----------------------------------------------------------------------------------------------------------------*/

	onReady: function(userdata)
	{
		const result = $.Deferred();

		amiWebApp.loadResources([
			'subapps/BookmarkEditor/twig/BookmarkEditorApp.twig',
			'subapps/BookmarkEditor/twig/bookmarks.twig',
			'js/3rd-party/ace/ace.min.js',
		]).done((data) => {

			amiWebApp.replaceHTML('#ami_main_content', data[0]).done(() => {

				amiWebApp.loadResources([
					'subapps/UserDashboard/js/jquery-ui.min.js',
				]).done(() => {

					/*------------------------------------------------------------------------------------------------*/

					$('#ACFE5A3E_2548_59BF_7EBB_32821C900AB1').sortable({

						start: (e, ui) => {

							/*----------------------------------------------------------------------------------------*/

							ui.item.ranks1 = {};

							$('#ACFE5A3E_2548_59BF_7EBB_32821C900AB1 > div[data-id]').each((indx, item) => {

								ui.item.ranks1[$(item).attr('data-id')] = indx;
							});

							/*----------------------------------------------------------------------------------------*/
						},
						update: (e, ui) => {

							/*----------------------------------------------------------------------------------------*/

							ui.item.ranks2 = {};

							$('#ACFE5A3E_2548_59BF_7EBB_32821C900AB1 > div[data-id]').each((indx, item) => {

								ui.item.ranks2[$(item).attr('data-id')] = indx;
							});

							/*----------------------------------------------------------------------------------------*/

							this.ranks = ui.item.ranks2;

							/*----------------------------------------------------------------------------------------*/

							this.swap(
								ui.item.ranks1,
								ui.item.ranks2
							);

							/*----------------------------------------------------------------------------------------*/
						},

						/*--------------------------------------------------------------------------------------------*/
					});

					/*------------------------------------------------------------------------------------------------*/
				});

				this.fragmentBookmarks = data[1];

				this.setUpdateMode(false);

				this.bookmarks = {};

				result.resolve();
			});

		}).fail(function(data) {

			result.reject(data);
		});

		return result;
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	onLogin: function()
	{
		this.showBookmarkList();
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	onLogout: function()
	{
		this.showBookmarkList();
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	_trim: function(s)
	{
		if(s) {
			return s.trim();
		}
		else {
			return '';
		}
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	setUpdateMode: function(updateMode)
	{
		if(updateMode)
		{
			$('#FF60636A_49EE_1C5D_BB59_AC077A8999E2').prop('disabled', false);

			$('#F1814093_A84F_0FC4_4581_699ACA53782F').text('Update');
		}
		else
		{
			$('#FF60636A_49EE_1C5D_BB59_AC077A8999E2').prop('disabled', true);

			$('#F1814093_A84F_0FC4_4581_699ACA53782F').text('Add');
        }
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	showBookmarkList: function()
    {
    	/*------------------------------------------------------------------------------------------------------------*/

		let this_bookmarks = [];

		this.bookmarks = {};

		for(const x of Object.values(amiLogin.getBookmarkInfo()))
		{
			this_bookmarks.push(x);

			this.bookmarks[x.id] = x;
        }

    	/*------------------------------------------------------------------------------------------------------------*/

		amiWebApp.replaceHTML('#ACFE5A3E_2548_59BF_7EBB_32821C900AB1', this.fragmentBookmarks, {dict: {bookmarks: this_bookmarks}});

    	/*------------------------------------------------------------------------------------------------------------*/
    },

	/*----------------------------------------------------------------------------------------------------------------*/

	_swapNb: 0,

	/*----------------------------------------------------------------------------------------------------------------*/

	swap: function(ranks1, ranks2)
	{
		/*------------------------------------------------------------------------------------------------------------*/

		this._swapNb = Object.keys(this.bookmarks).length;

		/*------------------------------------------------------------------------------------------------------------*/

		for(const id in this.bookmarks)
		{
			if(ranks1[id] !== ranks2[id])
			{
				amiWebApp.lock();

				amiCommand.execute('UpdateHash -id="' + amiWebApp.textToString(id) + '" -rank="' + ranks2[id].toString() + '"').done(() => {

					amiWebApp.unlock();

				}).fail((data, message) => {

					amiWebApp.error(message, true);

				}).always(() => {

					if(--this._swapNb === 0)
					{
						amiLogin.update();
					}
				});
			}
			else
			{
				if(--this._swapNb === 0)
				{
					amiLogin.update();
				}
			}
		}

		/*------------------------------------------------------------------------------------------------------------*/
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	select: function(id)
	{
		if(!(id = id.trim()))
		{
			return;
		}

		/*------------------------------------------------------------------------------------------------------------*/

		this.selected = id;

		/*------------------------------------------------------------------------------------------------------------*/

		$('#CA130E29_BDD4_CC8C_C71C_9472725DFE5A').val(this.bookmarks[id].name);

		$('#B0ECE244_6128_4BB1_569C_18225330963A').prop('checked', this.bookmarks[id].shared !== '0');

		$('#CC458B68_FE2E_2EDB_D49E_4EC9C9F8AD17').val(this.bookmarks[id].json);

		/*------------------------------------------------------------------------------------------------------------*/

		this.setUpdateMode(true);

		/*------------------------------------------------------------------------------------------------------------*/
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	clear: function(checked = true)
	{
		if(checked && !confirm('Please confirm...'))
		{
			return;
		}

		/*------------------------------------------------------------------------------------------------------------*/

		this.selected = null;

		/*------------------------------------------------------------------------------------------------------------*/

		$('#CA130E29_BDD4_CC8C_C71C_9472725DFE5A').val('');

		$('#B0ECE244_6128_4BB1_569C_18225330963A').prop('checked', false);

		$('#CC458B68_FE2E_2EDB_D49E_4EC9C9F8AD17').val('{}');

		/*------------------------------------------------------------------------------------------------------------*/

		this.setUpdateMode(false);

		/*------------------------------------------------------------------------------------------------------------*/
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	save: function()
	{
		if(!confirm('Please confirm...'))
		{
			return;
		}

		/*------------------------------------------------------------------------------------------------------------*/

		const id = this.selected;

		/*------------------------------------------------------------------------------------------------------------*/

		const name = this._trim($('#CA130E29_BDD4_CC8C_C71C_9472725DFE5A').val());

		const shared = $('#B0ECE244_6128_4BB1_569C_18225330963A').prop('checked') ? '1' : '0';

		const json = this._trim($('#CC458B68_FE2E_2EDB_D49E_4EC9C9F8AD17').val());

		/*------------------------------------------------------------------------------------------------------------*/

		if(name && json)
		{
			/*--------------------------------------------------------------------------------------------------------*/

			const command = (id ? 'UpdateHash -id="' + amiWebApp.textToString(id) + '"' : 'AddHash') + ' -name="' + amiWebApp.textToString(name) + '" -shared="' + amiWebApp.textToString(shared) + '" -json="' + amiWebApp.textToString(json) + '"';

			/*--------------------------------------------------------------------------------------------------------*/

			amiWebApp.lock();

			amiCommand.execute(command).done((data, message) => {

				amiLogin.update().done(() => {

					this.clear(false);

					this.showBookmarkList();

					amiWebApp.success(message, true);

				}).fail((data, message) => {

					this.showBookmarkList();

					amiWebApp.error(message, true);
				});

			}).fail((data, message) => {

				this.showBookmarkList();

				amiWebApp.error(message, true);
			});

			/*--------------------------------------------------------------------------------------------------------*/
		}

		/*------------------------------------------------------------------------------------------------------------*/
	},

	/*----------------------------------------------------------------------------------------------------------------*/

	remove: function()
	{
		if(!confirm('Please confirm...'))
		{
			return;
		}

		/*------------------------------------------------------------------------------------------------------------*/

		const id = this.selected;

		/*------------------------------------------------------------------------------------------------------------*/

		if(id)
		{
			/*--------------------------------------------------------------------------------------------------------*/

			const command = 'RemoveHash -id="' + amiWebApp.textToString(id) + '"';

			/*--------------------------------------------------------------------------------------------------------*/

			amiWebApp.lock();

			amiCommand.execute(command).done((data, message) => {

				amiLogin.update().done(() => {

					this.clear(false);

					this.showBookmarkList();

					amiWebApp.success(message, true);

				}).fail((data, message) => {

					this.showBookmarkList();

					amiWebApp.error(message, true);
				});

			}).fail((data, message) => {

				this.showBookmarkList();

				amiWebApp.error(message, true);
			});

			/*--------------------------------------------------------------------------------------------------------*/
		}

		/*------------------------------------------------------------------------------------------------------------*/
	},

	/*----------------------------------------------------------------------------------------------------------------*/
});

/*--------------------------------------------------------------------------------------------------------------------*/
/* GLOBAL INSTANCE                                                                                                    */
/*--------------------------------------------------------------------------------------------------------------------*/

const bookmarkEditorApp = new BookmarkEditorApp();

/*--------------------------------------------------------------------------------------------------------------------*/
