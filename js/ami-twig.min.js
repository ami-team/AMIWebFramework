/*!
 * AMI TWIG Engine
 *
 * Version: 0.1.0
 *
 * Copyright (c) 2014-2015 The AMI Team
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 *
 */
;"use strict";var ami=(typeof ami==="Object")?ami:{};ami.twig={};if(typeof exports!=="undefined"){ami.fs=require("fs");exports.ami=ami}ami.twig.tokenizer={tokenize:function(d,t,k,j,h,p){if(j.length!==h.length){throw"`tokenDefs.length != tokenTypes.length`"}var r=[];var m=[];var b=[];var g=0;var f=d.length;var a="",o;var s;var e;var n;var q;while(g<f){o=d.charAt(0);if(o==="\n"){t++}if(k.indexOf(o)>=0){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}d=d.substring(1);g+=1;continue}s=false;for(q in j){e=this._match(d,j[q]);if(e){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}n=h[q];r.push(e);m.push(n);b.push(t);d=d.substring(e.length);g+=e.length;s=true;break}}if(s){continue}a+=o;d=d.substring(1);g+=1}if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}return{tokens:r,types:m,lines:b}},_match:function(b,c){var a;if(c instanceof RegExp){a=b.match(c);return a!==null&&this._checkNextChar(b,(((((a[0]))))))?(((((a[0]))))):null}else{a=b.indexOf(c);return a===0&&this._checkNextChar(b,c)?c:null}},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(b,a){var c=a.length;var d=b.charCodeAt(c-0);var e=b.charCodeAt(c-1);return isNaN(d)||this._alnum[d]===0||this._alnum[e]===0}};ami.twig.expr={};ami.twig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD];this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH];this.PLUS_MINUS=[this.PLUS,this.MINUS];this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD];this.NOT_PLUS_MINUS=[this.NOT,this.PLUS,this.MINUS];this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,IS:105,DEFINED:106,NULL:107,EMPTY:108,ITERABLE:109,EVEN:110,ODD:111,CMP_OP:112,STARTS_WITH:113,ENDS_WITH:114,MATCHES:115,IN:116,RANGE:117,PLUS:118,MINUS:119,POWER:120,MUL:121,FLDIV:122,DIV:123,MOD:124,NOT:125,COLON:126,DOT:127,COMMA:128,PIPE:129,LP:130,RP:131,LB1:132,RB1:133,LB2:134,RB2:135,TERMINAL:136,SID:137,LST:200,DIC:201,FUN:202,VAR:203};ami.twig.expr.tokens.$init();ami.twig.expr.Tokenizer=function(b,a){this._spaces=[" ","\t","\n","\r"];this._tokenDefs=["or","and","b-or","b-xor","b-and","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","+","-","**","*","//","/","%","not",":",".",",","|","(",")","[","]","{","}",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^\'])*'/,/^"(\\"|[^\"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/];this._tokenTypes=[ami.twig.expr.tokens.LOGICAL_OR,ami.twig.expr.tokens.LOGICAL_AND,ami.twig.expr.tokens.BITWISE_OR,ami.twig.expr.tokens.BITWISE_XOR,ami.twig.expr.tokens.BITWISE_AND,ami.twig.expr.tokens.IS,ami.twig.expr.tokens.DEFINED,ami.twig.expr.tokens.NULL,ami.twig.expr.tokens.EMPTY,ami.twig.expr.tokens.ITERABLE,ami.twig.expr.tokens.EVEN,ami.twig.expr.tokens.ODD,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.CMP_OP,ami.twig.expr.tokens.STARTS_WITH,ami.twig.expr.tokens.ENDS_WITH,ami.twig.expr.tokens.MATCHES,ami.twig.expr.tokens.IN,ami.twig.expr.tokens.RANGE,ami.twig.expr.tokens.PLUS,ami.twig.expr.tokens.MINUS,ami.twig.expr.tokens.POWER,ami.twig.expr.tokens.MUL,ami.twig.expr.tokens.FLDIV,ami.twig.expr.tokens.DIV,ami.twig.expr.tokens.MOD,ami.twig.expr.tokens.NOT,ami.twig.expr.tokens.COLON,ami.twig.expr.tokens.DOT,ami.twig.expr.tokens.COMMA,ami.twig.expr.tokens.PIPE,ami.twig.expr.tokens.LP,ami.twig.expr.tokens.RP,ami.twig.expr.tokens.LB1,ami.twig.expr.tokens.RB1,ami.twig.expr.tokens.LB2,ami.twig.expr.tokens.RB2,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.TERMINAL,ami.twig.expr.tokens.SID];this.$init=function(e,d){var c=ami.twig.tokenizer.tokenize(e,d,this._spaces,this._tokenDefs,this._tokenTypes,true);this.tokens=c.tokens;this.types=c.types;this.i=0};this.next=function(c){this.i+=c||1};this.isEmpty=function(){return this.i>=this.tokens.length};this.peekToken=function(){return this.tokens[this.i]};this.peekType=function(){return this.types[this.i]};this.checkType=function(c){if(this.i<this.tokens.length){var d=this.types[this.i];return(c instanceof Array)?(c.indexOf(d)>=0):(c===d)}return false};this.$init(b,a)};ami.twig.expr.Compiler=function(b,a){this.$init=function(d,c){this.tokenizer=new ami.twig.expr.Tokenizer(this.code=d,this.line=c);this.rootNode=this.parseFilter();if(!this.tokenizer.isEmpty()){throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"}};this.dump=function(){return this.rootNode.dump()};this.parseFilter=function(){var e=this.parseLogicalOr(),d,c;while(this.tokenizer.checkType(ami.twig.expr.tokens.PIPE)){this.tokenizer.next();d=this.parseFunVar(true);for(c=d;c.nodeType===ami.twig.expr.tokens.DOT;c=c.nodeRight){}c.list.unshift(e);e=d}return e},this.parseLogicalOr=function(){var e=this.parseLogicalAnd(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_OR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseLogicalOr();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseLogicalAnd=function(){var e=this.parseBitwiseOr(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_AND)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseLogicalAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseOr=function(){var e=this.parseBitwiseXor(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_OR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseOr();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseXor=function(){var e=this.parseBitwiseAnd(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_XOR)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseXor();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseAnd=function(){var e=this.parseComp(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_AND)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseComp=function(){var f=this.parseAddSub(),c,d,e;if(this.tokenizer.checkType(ami.twig.expr.tokens.IS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e=d;if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=null;d.nodeRight=e}if(this.tokenizer.checkType(ami.twig.expr.tokens.IS_XXX)){c=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e.nodeLeft=f;e.nodeRight=c}else{throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected"}f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.CMP_OP)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.XXX_WITH)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.MATCHES)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.IN)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseX();d.nodeLeft=f;d.nodeRight=c;f=d}}}}}return f};this.parseAddSub=function(){var e=this.parseMulDiv(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.PLUS_MINUS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseMulDiv=function(){var e=this.parsePower(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.MUL_FLDIV_DIV_MOD)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseMulDiv();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parsePower=function(){var e=this.parseNotPlusMinus(),c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.POWER)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parsePower();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseNotPlusMinus=function(){var e=null,c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT_PLUS_MINUS)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseY();d.nodeLeft=e;d.nodeRight=c;return d}return this.parseY()};this.parseX=function(){var c;if((c=this.parseArray())){return c}if((c=this.parseObject())){return c}if((c=this.parseFunVar())){return c}if((c=this.parseTerminal())){return c}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"};this.parseY=function(){var c;if((c=this.parseGroup())){return c}if((c=this.parseArray())){return c}if((c=this.parseObject())){return c}if((c=this.parseFunVar())){return c}if((c=this.parseTerminal())){return c}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"};this.parseGroup=function(){var c;if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();c=this.parseFilter();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next();return c}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}return null};this.parseArray=function(){var d,c;if(this.tokenizer.checkType(ami.twig.expr.tokens.LB1)){this.tokenizer.next();c=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB1)){this.tokenizer.next();d=new ami.twig.expr.Node(ami.twig.expr.tokens.LST,"Array");d.list=c;return d}else{throw"syntax error, line `"+this.line+"`, `]` expected"}}return null};this.parseObject=function(){var c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.LB2)){this.tokenizer.next();d=this._parseDoublets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB2)){this.tokenizer.next();c=new ami.twig.expr.Node(ami.twig.expr.tokens.DIC,"Object");c.dict=d;return c}else{throw"syntax error, line `"+this.line+"`, `}` expected"}}return null};this.parseFunVar=function(d){var e=this._parseFunVar(d);if(e){var c=(e.nodeType===ami.twig.expr.tokens.DOT)?e.nodeLeft:e;if(c.nodeValue in ami.twig.stdlib){c.nodeValue="ami.twig.stdlib."+c.nodeValue}else{c.nodeValue=((((((("_.")))))))+c.nodeValue}}return e},this._parseFunVar=function(c){var f=this.parseFoo(c),d,e;if(this.tokenizer.checkType(ami.twig.expr.tokens.DOT)){e=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d=this._parseFunVar(c);e.nodeLeft=f;e.nodeRight=d;f=e}return f};this.parseFoo=function(c){var d;if(this.tokenizer.checkType(ami.twig.expr.tokens.SID)){d=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(d.nodeValue==="true"||d.nodeValue==="false"){d.nodeType=ami.twig.expr.tokens.TERMINAL;return d}if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();d.list=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next();d.nodeType=ami.twig.expr.tokens.FUN}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.LB1)){this.tokenizer.next();d.list=this._parseSinglets();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB1)){this.tokenizer.next();d.nodeType=ami.twig.expr.tokens.VAR}else{throw"syntax error, line `"+this.line+"`, `]` expected"}}else{d.nodeType=c?ami.twig.expr.tokens.FUN:ami.twig.expr.tokens.VAR;d.list=[]}}return d}return null},this._parseSinglets=function(){var c=[];while(this.tokenizer.checkType(ami.twig.expr.tokens.RX)===false){this._parseSinglet(c);if(this.tokenizer.checkType(ami.twig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{break}}return c};this._parseDoublets=function(){var c={};while(this.tokenizer.checkType(ami.twig.expr.tokens.RB2)===false){this._parseDoublet(c);if(this.tokenizer.checkType(ami.twig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{break}}return c};this._parseSinglet=function(c){c.push(this.parseFilter())},this._parseDoublet=function(c){if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){var d=this.tokenizer.peekToken();this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.COLON)){this.tokenizer.next();c[d]=this.parseFilter()}else{throw"syntax error, line `"+this.line+"`, `:` expected"}}else{throw"syntax error, line `"+this.line+"`, terminal expected"}},this.parseTerminal=function(){var e,c,d;if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){e=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.RANGE)){d=new ami.twig.expr.Node(((ami.twig.expr.tokens.RANGE)),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){c=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=e;d.nodeRight=c;return d}}else{return e}}return null};this.$init(b,a)};ami.twig.expr.Node=function(a,b){this.$init=function(c,d){this.nodeType=c;this.nodeValue=d;this.nodeLeft=null;this.nodeRight=null;this.list=null;this.dict=null};this._dump=function(e,d,h){var g,f=h[0],c;e.push("\tnode"+f+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];');if(this.nodeLeft){c=++h[0];d.push("\tnode"+f+" -> node"+c+";");this.nodeLeft._dump(e,d,h)}if(this.nodeRight){c=++h[0];d.push("\tnode"+f+" -> node"+c+";");this.nodeRight._dump(e,d,h)}if(this.list){for(g in this.list){c=++h[0];d.push("\tnode"+f+" -> node"+c+' [label="['+g.replace(/"/g,'\\"')+']"];');this.list[g]._dump(e,d,h)}}if(this.dict){for(g in this.dict){c=++h[0];d.push("\tnode"+f+" -> node"+c+' [label="['+g.replace(/"/g,'\\"')+']"];');this.dict[g]._dump(e,d,h)}}};this.dump=function(){var d=[];var c=[];this._dump(d,c,[0]);return"digraph ast {\n\trankdir=TB;\n"+d.join("\n")+"\n"+c.join("\n")+"\n}"};this.$init(a,b)};ami.twig.ajax={get:function(f,c,b){if(typeof exports!=="undefined"){try{var a=ami.fs.readFileSync(f,"utf8");if(c){c(a)}}catch(d){if(b){b(d)}}}else{var e=new XMLHttpRequest();e.open("GET",f,false);e.send();if(e.status===200){if(c){c(e.responseText)}}else{if(b){b(e.responseText)}}}}};ami.twig.engine={STATEMENT_RE:/\{\%\s*([a-zA-Z]+)\s*(.*?)\s*\%\}/m,VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,parse:function(j){var g={line:h,keyword:"if",expression:"",blocks:[{expression:"@else",list:[]}],value:""};var e=[g];var d=[0];var r;var l=0;var a=0;var h=1;var p;for(;;j=j.substr(a)){var q=e[e.length-1];var u=d[d.length-1];var o=j.match(this.STATEMENT_RE);if(o===null){for(p in j){if(j[p]==="\n"){h++}}q.blocks[u].list.push({line:h,keyword:"@text",expression:"",blocks:(([])),value:j});var c=[];for(p=e.length-1;p>0;p--){if(e[p].keyword==="if"){c.push("missing keyword `endif`")}else{if(e[p].keyword==="for"){c.push("missing keyword `endfor`")}}}if(c.length>0){throw"syntax error, line `"+h+"`, "+c.join(", ")}return g}var f=o[0];var t=o[1];var k=o[2];l=o.index+0;a=o.index+f.length;var n=j.substr(0,l);var b=j.substr(0,a);for(p in b){if(b[p]==="\n"){h++}}if(n){r={line:h,keyword:"@text",expression:(("")),blocks:(([])),value:n};q.blocks[u].list.push(r)}if(t==="set"||t==="include"){r={line:h,keyword:t,expression:k,blocks:(([])),value:((""))};q.blocks[u].list.push(r)}else{if(t==="if"||t==="for"){r={line:h,keyword:t,blocks:[{expression:k,list:[]}],value:""};q.blocks[u].list.push(r);e.push(r);d.push(0)}else{if(t==="elseif"){if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, missing keyword `if`"}u=q.blocks.length;q.blocks.push({expression:k,list:[]});d[d.length-1]=u}else{if(t==="else"){if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, missing keyword `if`"}u=q.blocks.length;q.blocks.push({expression:"@else",list:[]});d[d.length-1]=u}else{if(t==="endif"){if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, missing keyword `if`"}e.pop();d.pop()}else{if(t==="endfor"){if(q.keyword!=="for"){throw"syntax error, line `"+h+"`, missing keyword `for`"}e.pop();d.pop()}else{throw"syntax error, line `"+h+"`, unknown keyword `"+t+"`"}}}}}}}},_render:function(result,item,dict){var i,j,k,l;var expression,list;var m,symb,expr,DICT;if(item.keyword==="set"){m=item.expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+=\s+(.+)/);if(!m){throw"syntax error, line `"+item.line+"`, invalid `set` statement"}symb=m[1].trim();expr=m[2].trim();var value=ami.twig.expr.cache.eval(expr,item.line,dict);dict[symb]=value}else{if(item.keyword==="@text"){result[0]+=item.value.replace(this.VARIABLE_RE,function(match,expression){return ami.twig.expr.cache.eval(expression,item.line,dict)})}else{if(item.keyword==="if"){for(i in item.blocks){expression=item.blocks[i].expression;if(expression==="@else"||ami.twig.expr.cache.eval(expression,item.line,dict)===true){list=item.blocks[i].list;for(j in list){this._render(result,list[j],dict)}break}}}else{if(item.keyword==="for"){m=item.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/);if(!m){throw"syntax error, line `"+item.line+"`, invalid `for` statement"}symb=m[1].trim();expr=m[2].trim();var iter=ami.twig.expr.cache.eval(expr,item.line,dict);if(Object.prototype.toString.call(iter)==="[object Object]"){iter=Object.keys(iter)}if(Object.prototype.toString.call(iter)!=="[object Array]"&&Object.prototype.toString.call(iter)!=="[object String]"){throw"syntax error, line `"+item.line+"`, right operande not iterable"}DICT={loop:{}};for(i in dict){DICT[i]=dict[i]}k=0;l=iter.length;list=item.blocks[0].list;for(i in iter){DICT[symb]=iter[i];DICT.loop.first=(k===(0-0));DICT.loop.last=(k===(l-1));DICT.loop.index=k;DICT.loop.length=l;k++;for(j in list){this._render(result,list[j],DICT)}}}else{if(item.keyword==="include"){expression=item.expression;var only_subexpr;expression=expression.trim();if((m=expression.match(/(only)$/))){expression=expression.substr(expression,expression.length-m[0].length-1);only_subexpr=m[1]}else{only_subexpr=null}var with_subexpr;expression=expression.trim();if((m=expression.match(/with\s+(([a-zA-Z_$]|{).*)$/))){expression=expression.substr(expression,expression.length-m[0].length-1);with_subexpr=m[1]}else{with_subexpr=null}var FILENAME=ami.twig.expr.cache.eval(expression,item.line,dict);if(with_subexpr){DICT=ami.twig.expr.cache.eval(with_subexpr,item.line,dict);if(!(DICT instanceof Object)){throw"runtime error, line `"+item.line+"`, dictionary expected"}}else{DICT={}}if(!only_subexpr){for(i in dict){DICT[i]=dict[i]}}ami.twig.ajax.get(FILENAME,function(data){result[0]+=ami.twig.engine.render(data,DICT)},function(){throw"runtime error, line `"+item.line+"`, could not open `"+FILENAME+"`"})}}}}}},render:function(b,c){var a=[""];this._render(a,this.parse(b),c);return a[0]}};
/*!
 * AMI TWIG Engine
 *
 * Version: 0.1.0
 *
 * Copyright (c) 2014-2015 The AMI Team
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 *
 */
;"use strict";ami.twig.expr.cache={dict:{},eval:function(expression,line,_){var js;if(expression in this.dict){js=this.dict[expression]}else{js=this.dict[expression]=ami.twig.expr.interpreter.getJS(new ami.twig.expr.Compiler(expression,line))}if(!_){_={}}return eval(js)}};ami.twig.stdlib={isDefined:function(a){return typeof a!=="undefined"},isNull:function(a){return a===null},isEmpty:function(a){return(a===null||a===false)||(a===""||a===[]||a==={})},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return Object.prototype.toString.call(a)==="[object Object]"},isString:function(a){return Object.prototype.toString.call(a)==="[object String]"},isNumber:function(a){return Object.prototype.toString.call(a)==="[object Number]"},isIterable:function(a){return Object.prototype.toString.call(a)==="[object Array]"||Object.prototype.toString.call(a)==="[object Object]"||Object.prototype.toString.call(a)==="[object String]"},isEven:function(a){return this.isNumber(a)&&(a&1)===0},isOdd:function(a){return this.isNumber(a)&&(a&1)===1},isInObject:function(a,b){if(this.isArray(b)||this.isString(b)){return b.indexOf(a)>=0}if(this.isObject(b)){return a in b}return false},isInRange:function(a,c,b){if(this.isNumber(c)&&this.isNumber(b)){return((((((((a)))))))>=(((((((c))))))))&&((((((((a)))))))<=(((((((b))))))))}else{if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){return(a.charCodeAt(0)>=c.charCodeAt(0))&&(a.charCodeAt(0)<=b.charCodeAt(0))}}return false},range:function(c,b,e){var d;var a=[];if(!e){e=1}if(this.isNumber(c)&&this.isNumber(b)){for(d=(((((((c)))))));d<=(((((((b)))))));d+=e){a.push((d))}}else{if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){for(d=c.charCodeAt(0);d<=b.charCodeAt(0);d+=e){a.push(String.fromCharCode(d))}}}return a},length:function(a){if(this.isArray(a)||this.isString(a)){return a.length}if(this.isObject(a)){return Object.keys(a).length}return 0},first:function(a){return this.isIterable(a)&&a.length>0?a[0]:""},last:function(a){return this.isIterable(a)&&a.length>0?a[a.length-1]:""},keys:function(a){return this.isObject(a)?Object.keys(a):[]},"default":function(b,a){if(b){return b}else{if(a){return a}}return""},startsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=0;return b.indexOf(a,c)===c}return false},endsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=b.length-a.length;return b.indexOf(a,c)===c}return false},match:function(c,d){if(this.isString(c)&&this.isString(d)){var b=d.length;var a=d.lastIndexOf("/");if(b<2||a<0||d.charAt(0)!=="/"){throw"invalid regular expression `"+d+"`"}return new RegExp(d.substring(1,a+0),d.substring(a+1,b)).test(c)}return false},lower:function(a){return this.isString(a)?a.toLowerCase():""},upper:function(a){return this.isString(a)?a.toUpperCase():""},capitalize:function(a){if(this.isString(a)){if(a.length>0){a[0]=a[0].toUpperCase()}return a}return""},trim:function(a){return this.isString(a)?a.trim():""},escape:function(a,b){if(this.isString(a)){if(!b||b==="html"||b==="html_attr"){a=a.replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}else{if(b==="js"){a=a.replace(/\\/g,"\\\\").replace(/\n/g,"\\n").replace(/"/g,'\\"').replace(/'/g,"\\'")}else{if(b==="url"){a=encodeURIComponent(a)}}}}return a},raw:function(a){return a},replace:function(e,f){if(this.isString(e)&&this.isObject(f)){var d="";var c=0;var a=e.length;while(c<a){for(var b in f){if(e.substring(c).indexOf(b)===0){d+=f[b];c+=b.length;continue}}d+=e.charAt(c++)}return d}return e},abs:function(a){return Math.abs(a)},min:function(){var c=(arguments.length===1)&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;var b=Number.POSITIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b>a){b=a}}return b},max:function(){var c=(arguments.length===1)&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;var b=Number.NEGATIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b<a){b=a}}return b}};ami.twig.expr.interpreter={_getJS:function(f){var d;var a;var e;var g;var c;var b;if(f.nodeType===ami.twig.expr.tokens.LST){e="";for(d in f.list){e+=","+this._getJS(f.list[d])}if(e){e=e.substr(1)}return"["+e+"]"}if(f.nodeType===ami.twig.expr.tokens.DIC){e="";for(d in f.dict){e+=","+d+":"+this._getJS(f.dict[d])}if(e){e=e.substr(1)}return"{"+e+"}"}if(f.nodeType===ami.twig.expr.tokens.FUN){e="";for(d in f.list){e+=","+this._getJS(f.list[d])}if(e){e=e.substr(1)}return f.nodeValue+"("+e+")"}if(f.nodeType===ami.twig.expr.tokens.VAR){e="";for(d in f.list){e+=","+this._getJS(f.list[d])}if(e){e=e.substr(1)}if(e){return f.nodeValue+"["+e+"]"}else{return f.nodeValue}}if(f.nodeType===ami.twig.expr.tokens.TERMINAL){return f.nodeValue}if(f.nodeLeft!==null&&f.nodeRight===null){b=(f.nodeType!==ami.twig.expr.tokens.NOT)?f.nodeValue:"!";return b+"("+this._getJS(f.nodeLeft)+")"}if(f.nodeLeft===null&&f.nodeRight!==null){b=(f.nodeType!==ami.twig.expr.tokens.NOT)?f.nodeValue:"!";return b+"("+this._getJS(f.nodeRight)+")"}if(f.nodeLeft!==null&&f.nodeRight!==null){switch(f.nodeType){case ami.twig.expr.tokens.DOT:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return g+"."+c;case ami.twig.expr.tokens.IS:g=this._getJS(f.nodeLeft);switch(f.nodeRight.nodeType){case ami.twig.expr.tokens.DEFINED:return"ami.twig.stdlib.isDefined("+g+")";case ami.twig.expr.tokens.NULL:return"ami.twig.stdlib.isNull("+g+")";case ami.twig.expr.tokens.EMPTY:return"ami.twig.stdlib.isEmpty("+g+")";case ami.twig.expr.tokens.ITERABLE:return"ami.twig.stdlib.isIterable("+g+")";case ami.twig.expr.tokens.EVEN:return"ami.twig.stdlib.isEven("+g+")";case ami.twig.expr.tokens.ODD:return"ami.twig.stdlib.isOdd("+g+")"}throw"internal error";case ami.twig.expr.tokens.IN:if(f.nodeRight.nodeType!==ami.twig.expr.tokens.RANGE){g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.isInObject("+g+","+c+")"}else{a=this._getJS(f.nodeLeft);g=f.nodeRight.nodeLeft.nodeValue;c=f.nodeRight.nodeRight.nodeValue;return"ami.twig.stdlib.isInRange("+a+","+g+","+c+")"}case ami.twig.expr.tokens.STARTS_WITH:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.startsWith("+g+","+c+")";case ami.twig.expr.tokens.ENDS_WITH:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.endsWith("+g+","+c+")";case ami.twig.expr.tokens.MATCHES:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.match("+g+","+c+")";case ami.twig.expr.tokens.RANGE:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"ami.twig.stdlib.range("+g+","+c+")";case ami.twig.expr.tokens.FLDIV:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"Math.floor("+g+"/"+c+")";case ami.twig.expr.tokens.POWER:g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"Math.pow("+g+","+c+")";case ami.twig.expr.tokens.LOGICAL_OR:b="||";break;case ami.twig.expr.tokens.LOGICAL_AND:b="&&";break;case ami.twig.expr.tokens.BITWISE_OR:b="|";break;case ami.twig.expr.tokens.BITWISE_XOR:b="^";break;case ami.twig.expr.tokens.BITWISE_AND:b="&";break;default:b=f.nodeValue;break}g=this._getJS(f.nodeLeft);c=this._getJS(f.nodeRight);return"("+g+b+c+")"}},getJS:function(a){return"(function() { return "+this._getJS(a.rootNode)+"; }())"},eval:function(expr,_){if(!_){_={}}return eval(this.getJS(expr))}};