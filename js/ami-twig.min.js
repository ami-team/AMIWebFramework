/*!
 * AMI TWIG Engine
 *
 * Version: 0.2.0
 *
 * Copyright (c) 2014-![VALUE YEAR] The AMI Team
 *
 * This file must be used under the terms of the CeCILL-C:
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-fr.html
 *
 */
;"use strict";var amiTwig={};if(typeof exports!=="undefined"){amiTwig.fs=require("fs");exports.amiTwig=amiTwig}amiTwig.tokenizer={tokenize:function(d,t,k,j,h,p){if(j.length!==h.length){throw"`tokenDefs.length != tokenTypes.length`"}var r=[];var m=[];var b=[];var g=0;var f=d.length;var a="",o;var s;var e;var n;var q;while(g<f){o=d.charAt(0);if(o==="\n"){t++}if(k.indexOf(o)>=0){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}d=d.substring(1);g+=1;continue}s=false;for(q in j){e=this._match(d,j[q]);if(e){if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}n=h[q];r.push(e);m.push(n);b.push(t);d=d.substring(e.length);g+=e.length;s=true;break}}if(s){continue}a+=o;d=d.substring(1);g+=1}if(a){if(p){throw"invalid token `"+a+"`"}r.push(a);m.push((-1));b.push(t);a=""}return{tokens:r,types:m,lines:b}},_match:function(b,c){var a;if(c instanceof RegExp){a=b.match(c);return a!==null&&this._checkNextChar(b,(((((a[0]))))))?(((((a[0]))))):null}else{a=b.indexOf(c);return a===0&&this._checkNextChar(b,c)?c:null}},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(b,a){var c=a.length;var d=b.charCodeAt(c-0);var e=b.charCodeAt(c-1);return isNaN(d)||this._alnum[d]===0||this._alnum[e]===0}};amiTwig.expr={};amiTwig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD];this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH];this.PLUS_MINUS=[this.CONCAT,this.PLUS,this.MINUS];this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD];this.PLUS_MINUS=[this.PLUS,this.MINUS];this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,NOT:105,IS:106,DEFINED:107,NULL:108,EMPTY:109,ITERABLE:110,EVEN:111,ODD:112,CMP_OP:113,STARTS_WITH:114,ENDS_WITH:115,MATCHES:116,IN:117,RANGE:118,CONCAT:119,PLUS:120,MINUS:121,POWER:122,MUL:123,FLDIV:124,DIV:125,MOD:126,COLON:127,DOT:128,COMMA:129,PIPE:130,LP:131,RP:132,LB1:133,RB1:134,LB2:135,RB2:136,SID:137,TERMINAL:138,LST:200,DIC:201,FUN:202,VAR:203};amiTwig.expr.tokens.$init();amiTwig.expr.Tokenizer=function(b,a){this._spaces=[" ","\t","\n","\r"];this._tokenDefs=["or","and","b-or","b-xor","b-and","not","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","~","+","-","**","*","//","/","%",":",".",",","|","(",")","[","]","{","}","true","false",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^\'])*'/,/^"(\\"|[^\"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/];this._tokenTypes=[amiTwig.expr.tokens.LOGICAL_OR,amiTwig.expr.tokens.LOGICAL_AND,amiTwig.expr.tokens.BITWISE_OR,amiTwig.expr.tokens.BITWISE_XOR,amiTwig.expr.tokens.BITWISE_AND,amiTwig.expr.tokens.NOT,amiTwig.expr.tokens.IS,amiTwig.expr.tokens.DEFINED,amiTwig.expr.tokens.NULL,amiTwig.expr.tokens.EMPTY,amiTwig.expr.tokens.ITERABLE,amiTwig.expr.tokens.EVEN,amiTwig.expr.tokens.ODD,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.STARTS_WITH,amiTwig.expr.tokens.ENDS_WITH,amiTwig.expr.tokens.MATCHES,amiTwig.expr.tokens.IN,amiTwig.expr.tokens.RANGE,amiTwig.expr.tokens.CONCAT,amiTwig.expr.tokens.PLUS,amiTwig.expr.tokens.MINUS,amiTwig.expr.tokens.POWER,amiTwig.expr.tokens.MUL,amiTwig.expr.tokens.FLDIV,amiTwig.expr.tokens.DIV,amiTwig.expr.tokens.MOD,amiTwig.expr.tokens.COLON,amiTwig.expr.tokens.DOT,amiTwig.expr.tokens.COMMA,amiTwig.expr.tokens.PIPE,amiTwig.expr.tokens.LP,amiTwig.expr.tokens.RP,amiTwig.expr.tokens.LB1,amiTwig.expr.tokens.RB1,amiTwig.expr.tokens.LB2,amiTwig.expr.tokens.RB2,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.SID];this.$init=function(e,d){var c=amiTwig.tokenizer.tokenize(e,d,this._spaces,this._tokenDefs,this._tokenTypes,true);this.tokens=c.tokens;this.types=c.types;this.i=0};this.next=function(c){this.i+=c||1};this.isEmpty=function(){return this.i>=this.tokens.length};this.peekToken=function(){return this.tokens[this.i]};this.peekType=function(){return this.types[this.i]};this.checkType=function(c){if(this.i<this.tokens.length){var d=this.types[this.i];return(c instanceof Array)?(c.indexOf(d)>=0):(c===d)}return false};this.$init(b,a)};amiTwig.expr.Compiler=function(b,a){this.$init=function(d,c){this.tokenizer=new amiTwig.expr.Tokenizer(this.code=d,this.line=c);this.rootNode=this.parseFilter();if(!this.tokenizer.isEmpty()){throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"}};this.dump=function(){return this.rootNode.dump()};this.parseFilter=function(){var e=this.parseLogicalOr(),d,c;while(this.tokenizer.checkType(amiTwig.expr.tokens.PIPE)){this.tokenizer.next();d=this.parseDot1(true);for(c=d;c.nodeType===amiTwig.expr.tokens.DOT;c=c.nodeLeft){}c.list.unshift(e);e=d}return e},this.parseLogicalOr=function(){var e=this.parseLogicalAnd(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_OR)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseLogicalAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseLogicalAnd=function(){var e=this.parseBitwiseOr(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_AND)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseOr();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseOr=function(){var e=this.parseBitwiseXor(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_OR)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseXor();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseXor=function(){var e=this.parseBitwiseAnd(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_XOR)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseBitwiseAnd();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseBitwiseAnd=function(){var e=this.parseNot(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_AND)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseNot();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseNot=function(){var c,d;if(this.tokenizer.checkType(amiTwig.expr.tokens.NOT)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseComp();d.nodeLeft=null;d.nodeRight=c;return d}return this.parseComp()};this.parseComp=function(){var f=this.parseAddSub(),c,d,e;if(this.tokenizer.checkType(amiTwig.expr.tokens.IS)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e=d;if(this.tokenizer.checkType(amiTwig.expr.tokens.NOT)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=null;d.nodeRight=e}if(this.tokenizer.checkType(amiTwig.expr.tokens.IS_XXX)){c=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();e.nodeLeft=f;e.nodeRight=c}else{throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected"}f=d}else{if(this.tokenizer.checkType(amiTwig.expr.tokens.CMP_OP)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(amiTwig.expr.tokens.XXX_WITH)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(amiTwig.expr.tokens.MATCHES)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}else{if(this.tokenizer.checkType(amiTwig.expr.tokens.IN)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseAddSub();d.nodeLeft=f;d.nodeRight=c;f=d}}}}}return f};this.parseAddSub=function(){var e=this.parseMulDiv(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseMulDiv();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseMulDiv=function(){var e=this.parsePlusMinus(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.MUL_FLDIV_DIV_MOD)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parsePlusMinus();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parsePlusMinus=function(){var c,d;if(this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parsePower();d.nodeLeft=null;d.nodeRight=c;return d}return this.parsePower()};this.parsePower=function(){var e=this.parseDot1(),c,d;while(this.tokenizer.checkType(amiTwig.expr.tokens.POWER)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c=this.parseDot1();d.nodeLeft=e;d.nodeRight=c;e=d}return e};this.parseDot1=function(d){var e=this.parseDot2(d),c;if(e){for(c=e;c.nodeType===amiTwig.expr.tokens.DOT;c=c.nodeLeft){}if(c.q){if(c.nodeType===amiTwig.expr.tokens.FUN){if(c.nodeValue in amiTwig.stdlib){c.nodeValue="amiTwig.stdlib."+c.nodeValue}else{c.nodeValue=((((((("_.")))))))+c.nodeValue}}else{if(c.nodeType===amiTwig.expr.tokens.VAR){c.nodeValue=((((((("_.")))))))+c.nodeValue}}c.q=false}}return e};this.parseDot2=function(c){var f=this.parseDot3(c),d,e;while(this.tokenizer.checkType(amiTwig.expr.tokens.DOT)){e=new amiTwig.expr.Node(this.tokenizer.peekType(),".");this.tokenizer.next();d=this.parseDot3(c);e.nodeLeft=f;e.nodeRight=d;f=e}return f};this.parseDot3=function(c){var f=this.parseX(c),d,e;while(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){this.tokenizer.next();d=this.parseFilter();if(this.tokenizer.checkType(amiTwig.expr.tokens.RB1)){this.tokenizer.next();e=new amiTwig.expr.Node(amiTwig.expr.tokens.DOT,"[]");e.nodeLeft=f;e.nodeRight=d;f=e}else{throw"syntax error, line `"+this.line+"`, `]` expected"}}return f};this.parseX=function(c){var d;if((d=this.parseGroup())){return d}if((d=this.parseArray())){return d}if((d=this.parseObject())){return d}if((d=this.parseFunVar(c))){return d}if((d=this.parseTerminal())){return d}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"};this.parseGroup=function(){var c;if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){this.tokenizer.next();c=this.parseFilter();if(this.tokenizer.checkType(amiTwig.expr.tokens.RP)){this.tokenizer.next();return c}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}return null};this.parseArray=function(){var c,d;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){this.tokenizer.next();d=this._parseSinglets();if(this.tokenizer.checkType(amiTwig.expr.tokens.RB1)){this.tokenizer.next();c=new amiTwig.expr.Node(amiTwig.expr.tokens.LST,"Array");c.list=d;return c}else{throw"syntax error, line `"+this.line+"`, `]` expected"}}return null};this.parseObject=function(){var c,d;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB2)){this.tokenizer.next();d=this._parseDoublets();if(this.tokenizer.checkType(amiTwig.expr.tokens.RB2)){this.tokenizer.next();c=new amiTwig.expr.Node(amiTwig.expr.tokens.DIC,"Object");c.dict=d;return c}else{throw"syntax error, line `"+this.line+"`, `}` expected"}}return null};this.parseFunVar=function(c){var d;if(this.tokenizer.checkType(amiTwig.expr.tokens.SID)){d=new amiTwig.expr.Node(0,c?"filter_"+this.tokenizer.peekToken():this.tokenizer.peekToken());d.q=true;this.tokenizer.next();if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){this.tokenizer.next();d.list=this._parseSinglets();if(this.tokenizer.checkType(amiTwig.expr.tokens.RP)){this.tokenizer.next();d.nodeType=amiTwig.expr.tokens.FUN}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}else{d.nodeType=c?amiTwig.expr.tokens.FUN:amiTwig.expr.tokens.VAR;d.list=[]}return d}return null},this._parseSinglets=function(){var c=[];while(this.tokenizer.checkType(amiTwig.expr.tokens.RX)===false){this._parseSinglet(c);if(this.tokenizer.checkType(amiTwig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{break}}return c};this._parseDoublets=function(){var c={};while(this.tokenizer.checkType(amiTwig.expr.tokens.RB2)===false){this._parseDoublet(c);if(this.tokenizer.checkType(amiTwig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{break}}return c};this._parseSinglet=function(c){c.push(this.parseFilter())},this._parseDoublet=function(c){if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){var d=this.tokenizer.peekToken();this.tokenizer.next();if(this.tokenizer.checkType(amiTwig.expr.tokens.COLON)){this.tokenizer.next();c[d]=this.parseFilter()}else{throw"syntax error, line `"+this.line+"`, `:` expected"}}else{throw"syntax error, line `"+this.line+"`, terminal expected"}},this.parseTerminal=function(){var e,c,d;if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(amiTwig.expr.tokens.RANGE)){d=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){c=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();d.nodeLeft=e;d.nodeRight=c;return d}}else{return e}}return null};this.$init(b,a)};amiTwig.expr.Node=function(a,b){this.$init=function(c,d){this.nodeType=c;this.nodeValue=d;this.nodeLeft=null;this.nodeRight=null;this.list=null;this.dict=null};this._dump=function(e,d,h){var g,f=h[0],c;e.push("\tnode"+f+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];');if(this.nodeLeft){c=++h[0];d.push("\tnode"+f+" -> node"+c+";");this.nodeLeft._dump(e,d,h)}if(this.nodeRight){c=++h[0];d.push("\tnode"+f+" -> node"+c+";");this.nodeRight._dump(e,d,h)}if(this.list){for(g in this.list){c=++h[0];d.push("\tnode"+f+" -> node"+c+' [label="['+g.replace(/"/g,'\\"')+']"];');this.list[g]._dump(e,d,h)}}if(this.dict){for(g in this.dict){c=++h[0];d.push("\tnode"+f+" -> node"+c+' [label="['+g.replace(/"/g,'\\"')+']"];');this.dict[g]._dump(e,d,h)}}};this.dump=function(){var d=[];var c=[];this._dump(d,c,[0]);return"digraph ast {\n\trankdir=TB;\n"+d.join("\n")+"\n"+c.join("\n")+"\n}"};this.$init(a,b)};amiTwig.ajax={get:function(f,c,b){if(typeof exports!=="undefined"){try{var a=amiTwig.fs.readFileSync(f,"utf8");if(c){c(a)}}catch(d){if(b){b(d)}}}else{var e=new XMLHttpRequest();e.open("GET",f,false);e.send();if(e.status===200){if(c){c(e.responseText)}}else{if(b){b(e.responseText)}}}}};amiTwig.engine={STATEMENT_RE:/\{\%\s*([a-zA-Z]+)\s+(.*?)\s*\%\}/m,VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,COMMENT_RE:/\{\#\s*(.*?)\s*\#\}/g,compile:function(j){var g={line:h,keyword:"@root",expression:"",blocks:[{expression:"@else",list:[]}],value:""};var d=[g];var c=[0];var r;var l=0;var a=0;var h=1;var p;for(j=j.replace(this.COMMENT_RE,"");;j=j.substr(a)){var q=d[d.length-1];var u=c[c.length-1];var o=j.match(this.STATEMENT_RE);if(o===null){for(p in j){if(j[p]==="\n"){h++}}q.blocks[u].list.push({line:h,keyword:"@text",expression:"",blocks:(([])),value:j});var f=[];for(p=d.length-1;p>0;p--){if(d[p].keyword==="if"){f.push("missing keyword `endif`")}else{if(d[p].keyword==="for"){f.push("missing keyword `endfor`")}}}if(f.length>0){throw"syntax error, line `"+h+"`, "+f.join(", ")}return g}var e=o[0];var t=o[1];var k=o[2];l=o.index+0;a=o.index+e.length;var n=j.substr(0,l);var b=j.substr(0,a);for(p in b){if(b[p]==="\n"){h++}}if(n){r={line:h,keyword:"@text",expression:"",blocks:[],value:n};q.blocks[u].list.push(r)}switch(t){case"flush":case"autoescape":case"spaceless":case"verbatim":break;case"do":case"set":case"include":r={line:h,keyword:t,expression:k,blocks:[],value:""};q.blocks[u].list.push(r);break;case"if":case"for":r={line:h,keyword:t,blocks:[{expression:k,list:[]}],value:""};q.blocks[u].list.push(r);d.push(r);c.push(0);break;case"elseif":if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, unexpected keyword `elseif`"}u=q.blocks.length;q.blocks.push({expression:k,list:[]});c[c.length-1]=u;break;case"else":if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, unexpected keyword `else`"}u=q.blocks.length;q.blocks.push({expression:"@else",list:[]});c[c.length-1]=u;break;case"endif":if(q.keyword!=="if"){throw"syntax error, line `"+h+"`, unexpected keyword `endif`"}d.pop();c.pop();break;case"endfor":if(q.keyword!=="for"){throw"syntax error, line `"+h+"`, unexpected keyword `endfor`"}d.pop();c.pop();break;default:throw"syntax error, line `"+h+"`, unknown keyword `"+t+"`"}}},_render:function(result,item,dict){var i,j,k,l;var expression,list;var m,symb,expr,value;switch(item.keyword){case"do":amiTwig.expr.cache.eval(item.expression,item.line,dict);break;case"set":m=item.expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)/);if(!m){throw"syntax error, line `"+item.line+"`, invalid `set` statement"}dict[m[1]]=amiTwig.expr.cache.eval(m[2],item.line,dict);break;case"@text":result.push(item.value.replace(this.VARIABLE_RE,function(match,expression){value=amiTwig.expr.cache.eval(expression,item.line,dict);return(value!==undefined&&value!==null)?value:""}));break;case"if":case"@root":for(i in item.blocks){expression=item.blocks[i].expression;if(expression==="@else"||amiTwig.expr.cache.eval(expression,item.line,dict)){list=item.blocks[i].list;for(j in list){this._render(result,list[j],dict)}break}}break;case"for":m=item.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/);if(!m){throw"syntax error, line `"+item.line+"`, invalid `for` statement"}symb=m[1];expr=m[2];value=amiTwig.expr.cache.eval(expr,item.line,dict);var typeName=Object.prototype.toString.call(value);if(typeName!=="[object Array]"&&typeName!=="[object Object]"&&typeName!=="[object String]"){throw"syntax error, line `"+item.line+"`, right operande not iterable"}if(typeName==="[object Object]"){value=Object.keys(value)}var old1=dict[(symb)];var old2=dict.loop;k=0;l=value.length;dict.loop={length:l};list=item.blocks[0].list;for(i in value){dict[symb]=value[i];dict.loop.first=(k===(0-0));dict.loop.last=(k===(l-1));dict.loop.index0=k;k++;dict.loop.index=k;for(j in list){this._render(result,list[j],dict)}}if(old2){dict.loop=old2}if(old1){dict[(symb)]=old1}break;case"include":expression=item.expression;var with_context=true;expression=expression.trim();if((m=expression.match(/only$/))){expression=expression.substr(expression,expression.length-m[0].length-1);with_context=false}var with_subexpr="{}";expression=expression.trim();if((m=expression.match(/with\s+(([a-zA-Z_$]|{).*)$/))){expression=expression.substr(expression,expression.length-m[0].length-1);with_subexpr=m[1]}var FILENAME=amiTwig.expr.cache.eval(expression,item.line,dict)||"";if(Object.prototype.toString.call(FILENAME)!=="[object String]"){throw"runtime error, line `"+item.line+"`, string expected"}var VARIABLES=amiTwig.expr.cache.eval(with_subexpr,item.line,dict)||{};if(Object.prototype.toString.call(VARIABLES)!=="[object Object]"){throw"runtime error, line `"+item.line+"`, object expected"}result.push(amiTwig.stdlib.include(FILENAME,VARIABLES,with_context,false));break}},render:function(b,c){var a=[];this._render(a,Object.prototype.toString.call(b)==="[object String]"?this.compile(b):b,c||{});return a.join("")}};amiTwig.expr.cache={dict:{},eval:function(expression,line,_){var f;if(expression in this.dict){f=this.dict[expression]}else{f=this.dict[expression]=eval(amiTwig.expr.interpreter.getJS(new amiTwig.expr.Compiler(expression,line)))}if(!_){_={}}return f.call(_,_)}};amiTwig.stdlib={isDefined:function(a){return a!==undefined},isNull:function(a){return a===null},isEmpty:function(a){if(a===null||a===false||a===((""))){return true}else{var b=Object.prototype.toString.call(a);return(b==="[object Array]"&&a.length===0)||(b==="[object Object]"&&Object.keys(a).length===0)}},isNumber:function(a){return Object.prototype.toString.call(a)==="[object Number]"},isString:function(a){return Object.prototype.toString.call(a)==="[object String]"},isArray:function(a){return Object.prototype.toString.call(a)==="[object Array]"},isObject:function(a){return Object.prototype.toString.call(a)==="[object Object]"},isIterable:function(a){var b=Object.prototype.toString.call(a);return b==="[object String]"||b==="[object Array]"||b==="[object Object]"},isEven:function(a){return this.isNumber(a)&&(a&1)===0},isOdd:function(a){return this.isNumber(a)&&(a&1)===1},isInObject:function(a,b){if(this.isArray(b)||this.isString(b)){return b.indexOf(a)>=0}if(this.isObject(b)){return a in b}return false},isInRange:function(a,c,b){if(this.isNumber(c)&&this.isNumber(b)){return((((((((a)))))))>=(((((((c))))))))&&((((((((a)))))))<=(((((((b))))))))}if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){return(a.charCodeAt(0)>=c.charCodeAt(0))&&(a.charCodeAt(0)<=b.charCodeAt(0))}return false},range:function(c,b,e){var d;var a=[];if(!e){e=1}if(this.isNumber(c)&&this.isNumber(b)){for(d=(((((((c)))))));d<=(((((((b)))))));d+=e){a.push((d))}}else{if(this.isString(c)&&c.length===1&&this.isString(b)&&b.length===1){for(d=c.charCodeAt(0);d<=b.charCodeAt(0);d+=e){a.push(String.fromCharCode(d))}}}return a},filter_length:function(a){if(this.isString(a)||this.isArray(a)){return a.length}if(this.isObject(a)){return Object.keys(a).length}return 0},filter_first:function(a){return(this.isString(a)||this.isArray(a))&&a.length>0?a[0]:""},filter_last:function(a){return(this.isString(a)||this.isArray(a))&&a.length>0?a[a.length-1]:""},filter_slice:function(a,c,b){return(this.isString(a)||this.isArray(a))?a.slice(c,b):null},filter_merge:function(){var c,b;if(arguments.length>1){if(this.isString(arguments[0])){var d="";for(c in arguments){d+=arguments[c]}return d}if(this.isArray(arguments[0])){var a=[];for(c in arguments){for(b in arguments[c]){a.push(arguments[c][b])}}return a}if(this.isObject(arguments[0])){var e={};for(c in arguments){for(b in arguments[c]){e[b]=arguments[c][b]}}return e}}return null},filter_sort:function(a){return this.isArray(a)?a.sort():[]},filter_reverse:function(a){return this.isArray(a)?a.reverse():[]},filter_join:function(a,b){return this.isArray(a)?a.join(b):""},filter_keys:function(a){return this.isObject(a)?Object.keys(a):[]},startsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=0;return b.indexOf(a,c)===c}return false},endsWith:function(b,a){if(this.isString(b)&&this.isString(a)){var c=b.length-a.length;return b.indexOf(a,c)===c}return false},match:function(c,e){if(this.isString(((c)))&&this.isString(e)){var b=e.indexOf("/");var a=e.lastIndexOf("/");if(b===0||b<a){try{return new RegExp(e.substring(b+1,a),e.substring(a+1)).test(c)}catch(d){}}}return false},filter_default:function(b,a){if(b){return b}else{if(a){return a}}return""},filter_lower:function(a){return this.isString(a)?a.toLowerCase():""},filter_upper:function(a){return this.isString(a)?a.toUpperCase():""},filter_capitalize:function(a){if(this.isString(a)){return a.trim().toLowerCase().replace(/^\S/g,function(b){return b.toUpperCase()})}return""},filter_title:function(a){if(this.isString(a)){return a.trim().toLowerCase().replace(/(?:^|\s)\S/g,function(b){return b.toUpperCase()})}return""},filter_trim:function(a){return this.isString(a)?a.trim():""},_internal_escape_map1:{"<":"&lt;",">":"&gt;",'"':"&quot;","&":"&amp;"},_internal_escape_map2:{"\\":"\\\\","\n":"\\n",'"':'\\"',"'":"\\'"},filter_escape:function(a,c){if(this.isString(a)){var b;if(!c||c==="html"||c==="html_attr"){b=this._internal_escape_map1;return a.replace(/[<>"&]/g,function(d){return b[d]})}else{if(c==="js"){b=this._internal_escape_map2;return a.replace(/[\\\n"']/g,function(d){return b[d]})}else{if(c==="url"){return encodeURIComponent(a)}}}}return""},filter_url_encode:function(a){return this.isString(a)?encodeURIComponent(a):""},filter_nl2br:function(a){return this.isString(a)?a.replace(/\n/g,"<br/>"):""},filter_raw:function(a){return this.isString(a)?a:""},filter_replace:function(e,g){if(this.isString(e)&&this.isObject(g)){var f;var d="";var c=0;var a=e.length;while(c<a){f=true;for(var b in g){if(e.substring(c).indexOf(b)===0){d+=g[b];c+=b.length;f=false;break}}if(f){d+=e.charAt(c++)}}return d}return""},filter_split:function(c,b,a){return this.isString(c)?c.split(b,a):[]},filter_abs:function(a){return Math.abs(a)},filter_round:function(a,b){if(b==="ceil"){return Math.ceil(a)}else{if(b==="floor"){return Math.floor(a)}else{return Math.round(a)}}},min:function(){var c=(arguments.length===1)&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;var b=Number.POSITIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b>a){b=a}}return b},max:function(){var c=(arguments.length===1)&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;var b=Number.NEGATIVE_INFINITY;for(var d in c){var a=c[d];if(this.isNumber(a)==false){return Number.NaN}if(b<a){b=a}}return b},random:function(a){var b=Math.random();if(a){if(this.isString(a)){return a[Math.floor(a.length*b)]}else{if(this.isArray(a)){return a[Math.floor(a.length*b)]}else{if(this.isNumber(a)){return Math.floor(a*b)}}}}a=Number.MAX_SAFE_INTEGER;return Math.floor(a*b)},filter_json_encode:function(a){return JSON.stringify(a,null,2)},filter_json_jspath:function(a,b){return typeof JSPath!=="undefined"?JSPath.apply(b,a):[]},include:function(d,c,a,b){c=c||{};if(a){}amiTwig.ajax.get(d,function(e){return amiTwig.engine.render(e,c)},function(){if(b){return""}});throw"runtime error, could not open `"+d+"`"}};amiTwig.stdlib.filter_e=amiTwig.stdlib.filter_escape;amiTwig.expr.interpreter={_getJS:function(f){var b;var e;var a;var g;var d;var c;switch(f.nodeType){case amiTwig.expr.tokens.LST:b=[];for(e in f.list){b.push(this._getJS(f.list[e]))}return"["+b.join(",")+"]";case amiTwig.expr.tokens.DIC:b=[];for(e in f.dict){b.push(e+":"+this._getJS(f.dict[e]))}return"{"+b.join(",")+"}";case amiTwig.expr.tokens.FUN:b=[];for(e in f.list){b.push(this._getJS(f.list[e]))}return f.nodeValue+"("+b.join(",")+")";case amiTwig.expr.tokens.VAR:b=[];for(e in f.list){b.push("["+this._getJS(f.list[e])+"]")}return b.length>0?f.nodeValue+b.join(""):f.nodeValue;case amiTwig.expr.tokens.TERMINAL:return f.nodeValue;case amiTwig.expr.tokens.IS:g=this._getJS(f.nodeLeft);switch(f.nodeRight.nodeType){case amiTwig.expr.tokens.DEFINED:return"amiTwig.stdlib.isDefined("+g+")";case amiTwig.expr.tokens.NULL:return"amiTwig.stdlib.isNull("+g+")";case amiTwig.expr.tokens.EMPTY:return"amiTwig.stdlib.isEmpty("+g+")";case amiTwig.expr.tokens.ITERABLE:return"amiTwig.stdlib.isIterable("+g+")";case amiTwig.expr.tokens.EVEN:return"amiTwig.stdlib.isEven("+g+")";case amiTwig.expr.tokens.ODD:return"amiTwig.stdlib.isOdd("+g+")";default:throw"internal error"}case amiTwig.expr.tokens.IN:if(f.nodeRight.nodeType!==amiTwig.expr.tokens.RANGE){g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"amiTwig.stdlib.isInObject("+g+","+d+")"}else{a=this._getJS(f.nodeLeft);g=f.nodeRight.nodeLeft.nodeValue;d=f.nodeRight.nodeRight.nodeValue;return"amiTwig.stdlib.isInRange("+a+","+g+","+d+")"}case amiTwig.expr.tokens.STARTS_WITH:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"amiTwig.stdlib.startsWith("+g+","+d+")";case amiTwig.expr.tokens.ENDS_WITH:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"amiTwig.stdlib.endsWith("+g+","+d+")";case amiTwig.expr.tokens.MATCHES:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"amiTwig.stdlib.match("+g+","+d+")";case amiTwig.expr.tokens.RANGE:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"amiTwig.stdlib.range("+g+","+d+")";case amiTwig.expr.tokens.DOT:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);if(f.nodeValue[0]==="."){return g+"."+d}else{return g+"["+d+"]"}case amiTwig.expr.tokens.FLDIV:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"Math.floor("+g+"/"+d+")";case amiTwig.expr.tokens.POWER:g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"Math.pow("+g+","+d+")";default:if(f.nodeLeft!==null&&f.nodeRight===null){c=(f.nodeType!==amiTwig.expr.tokens.NOT)?f.nodeValue:"!";return c+"("+this._getJS(f.nodeLeft)+")"}if(f.nodeLeft===null&&f.nodeRight!==null){c=(f.nodeType!==amiTwig.expr.tokens.NOT)?f.nodeValue:"!";return c+"("+this._getJS(f.nodeRight)+")"}if(f.nodeLeft!==null&&f.nodeRight!==null){switch(f.nodeType){case amiTwig.expr.tokens.LOGICAL_OR:c="||";break;case amiTwig.expr.tokens.LOGICAL_AND:c="&&";break;case amiTwig.expr.tokens.BITWISE_OR:c="|";break;case amiTwig.expr.tokens.BITWISE_XOR:c="^";break;case amiTwig.expr.tokens.BITWISE_AND:c="&";break;case amiTwig.expr.tokens.CONCAT:c="+";break;default:c=f.nodeValue;break}g=this._getJS(f.nodeLeft);d=this._getJS(f.nodeRight);return"("+g+c+d+")"}}},getJS:function(a){return"(function(_) { return "+this._getJS(a.rootNode)+"; })"},eval:function(expr,_){if(!_){_={}}return eval(this.getJS(expr)).call(_,_)}};