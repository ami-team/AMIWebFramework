/*!
 * JSPath
 *
 * Copyright (c) 2012 Filatov Dmitry (dfilatov@yandex-team.ru)
 * With parts by Marat Dulin (mdevils@gmail.com)
 * Dual licensed under the MIT and GPL licenses:
 * http://www.opensource.org/licenses/mit-license.php
 * http://www.gnu.org/licenses/gpl.html
 *
 * @version 0.2.10
 *
 * Attention : cette version est modifiée pour supporter
 * le caractère '@' dans les noms d'attributs :
 *
 * function isIdStart(ch) {
 *     return (ch === '@') || (ch === '$') || (ch === '_') || (ch >= 'a' && ch <= 'z') || (ch >= 'A' && ch <= 'Z');
 * }
 *
 */

(function(){function b(a){return Function("data,subst",d(k(a)))}var g={PATH:1,SELECTOR:2,OBJ_PRED:3,POS_PRED:4,LOGICAL_EXPR:5,COMPARISON_EXPR:6,MATH_EXPR:7,CONCAT_EXPR:8,UNARY_EXPR:9,POS_EXPR:10,LITERAL:11,SUBST:12},k=function(){function ag(i){aj=i.split(""),at=0,ai=null,am=aj.length;var m=aA(),a=J();return a.type!==ah.EOP&&U(a),m}function aA(){K()||U(J());var a=!1;e("^")&&(J(),a=!0);var m=[],i;while(i=aw()){m.push(i)}return{type:g.PATH,fromRoot:a,parts:m}}function aw(){if(Z()){return ap()}if(e("[")){return ay()}if(e("{")){return au()}if(e("(")){return ad()}}function ap(){var o=J().val,m=R(),a;if(e("*")||m.type===ah.ID||m.type===ah.STR){a=J().val}return{type:g.SELECTOR,selector:o,prop:a}}function ay(){aq("[");var a=az();return aq("]"),{type:g.POS_PRED,arg:a}}function au(){aq("{");var a=al();return aq("}"),{type:g.OBJ_PRED,arg:a}}function al(){var a=ax(),i;while(e("||")){J(),(i||(i=[a])).push(ax())}return i?{type:g.LOGICAL_EXPR,op:"||",args:i}:a}function ax(){var a=af(),i;while(e("&&")){J(),(i||(i=[a])).push(af())}return i?{type:g.LOGICAL_EXPR,op:"&&",args:i}:a}function af(){var a=ao();while(e("==")||e("!=")||e("===")||e("!==")||e("^=")||e("^==")||e("$==")||e("$=")||e("*==")||e("*=")){a={type:g.COMPARISON_EXPR,op:J().val,args:[a,af()]}}return a}function ao(){var a=av();while(e("<")||e(">")||e("<=")||e(">=")){a={type:g.COMPARISON_EXPR,op:J().val,args:[a,ao()]}}return a}function av(){var a=ac();while(e("+")||e("-")){a={type:g.MATH_EXPR,op:J().val,args:[a,av()]}}return a}function ac(){var a=ae();while(e("*")||e("/")||e("%")){a={type:g.MATH_EXPR,op:J().val,args:[a,ac()]}}return a}function az(){if(e(":")){return J(),{type:g.POS_EXPR,toIdx:ae()}}var a=ae();return e(":")?(J(),e("]")?{type:g.POS_EXPR,fromIdx:a}:{type:g.POS_EXPR,fromIdx:a,toIdx:ae()}):{type:g.POS_EXPR,idx:a}}function ae(){return e("!")||e("-")?{type:g.UNARY_EXPR,op:J().val,arg:ae()}:X()}function X(){var i=R(),a=i.type;return a===ah.STR||a===ah.NUM||a===ah.BOOL?{type:g.LITERAL,val:J().val}:a===ah.ID&&i.val[0]==="$"?{type:g.SUBST,name:J().val.substr(1)}:K()?aA():e("(")?z():U(J())}function z(){aq("(");var a=al();return aq(")"),a}function ad(){aq("(");var a=aA(),i;while(e("|")){J(),(i||(i=[a])).push(aA())}return aq(")"),i?{type:g.CONCAT_EXPR,op:"|",args:i}:a}function e(a){var i=R();return i.type===ah.PUNCT&&i.val===a}function K(){return Z()||e("^")}function Z(){var a=R();if(a.type===ah.PUNCT){var i=a.val;return i==="."||i===".."}return !1}function aq(a){var i=J();(i.type!==ah.PUNCT||i.val!==a)&&U(i)}function R(){if(ai!==null){return ai}var a=at;return ai=ab(),at=a,ai}function ab(){while(aB(aj[at])){++at}if(at>=am){return{type:ah.EOP,range:[at,at]}}var a=W();if(a||(a=V())||(a=aa())||(a=ar())){return a}U({val:aj[at],range:[at,at]})}function J(){var a;return ai?(at=ai.range[1],a=ai,ai=null,a):ab()}function Q(a){return"0123456789".indexOf(a)>=0}function aB(a){return a===" "}function Y(a){return a==="@"||a==="$"||a==="_"||a>="a"&&a<="z"||a>="A"&&a<="Z"}function G(a){return Y(a)||a>="0"&&a<="9"}function V(){var i=aj[at];if(!Y(i)){return}var m=at,a=i;while(++at<am){i=aj[at];if(!G(i)){break}a+=i}return a==="true"||a==="false"?{type:ah.BOOL,val:a==="true",range:[m,at]}:{type:ah.ID,val:a,range:[m,at]}}function aa(){if(aj[at]!=='"'){return}var i=++at,m="",a;while(at<am){a=aj[at++];if(a==='"'){break}m+=a}return{type:ah.STR,val:m,range:[i,at]}}function ar(){var m=at,o=aj[at],i=o===".";if(i||Q(o)){var a=o;while(++at<am){o=aj[at];if(o==="."){if(i){return}i=!0}else{if(!Q(o)){break}}a+=o}return{type:ah.NUM,val:i?parseFloat(a):parseInt(a,10),range:[m,at]}}}function W(){var i=at,p=aj[at],a=aj[at+1];if(p==="."){if(Q(a)){return}return aj[++at]==="."?{type:ah.PUNCT,val:"..",range:[i,++at]}:{type:ah.PUNCT,val:".",range:[i,at]}}if(a==="="){var m=aj[at+2];if(m==="="){if("=!^$*".indexOf(p)>=0){return{type:ah.PUNCT,val:p+a+m,range:[i,at+=3]}}}else{if("=!^$*><".indexOf(p)>=0){return{type:ah.PUNCT,val:p+a,range:[i,at+=2]}}}}if(p===a&&(p==="|"||p==="&")){return{type:ah.PUNCT,val:p+a,range:[i,at+=2]}}if(":{}()[]^+-*/%!><|".indexOf(p)>=0){return{type:ah.PUNCT,val:p,range:[i,++at]}}}function U(a){a.type===ah.EOP&&ak(a,an.UNEXP_EOP),ak(a,an.UNEXP_TOKEN,a.val)}function ak(p,m){var q=Array.prototype.slice.call(arguments,2),o=m.replace(/%(\d)/g,function(n,i){return q[i]||""}),a=new Error(o);throw a.column=p.range[0],a}var ah={ID:1,NUM:2,STR:3,BOOL:4,PUNCT:5,EOP:6},an={UNEXP_TOKEN:'Unexpected token "%0"',UNEXP_EOP:"Unexpected end of path"},aj,at,ai,am;return ag}(),d=function(){function I(){if(Q.length){return Q.shift()}var a="v"+ ++J;return M.push(a),a}function L(){var i=arguments,a=i.length;while(a--){Q.push(i[a])}}function F(a){return G=[],M=["res"],J=0,Q=[],Z(a,"res","data",!0),G.unshift("var ",Array.isArray?"isArr = Array.isArray":'toStr = Object.prototype.toString, isArr = function(o) { return toStr.call(o) === "[object Array]"; }',",",M.join(","),";","isArr(data) || (data = [data]);"),G.push("return res;"),G.join("")}function Z(w,m,x,S){var v=w.parts,N=0,E=v.length,t=!0;G.push(m,"=",w.fromRoot?"data":x,";");while(N<E){var y=v[N++];switch(y.type){case g.SELECTOR:y.selector===".."?P(y,m,m):V(y,m,m),t=!0;break;case g.OBJ_PRED:X(y,m,m);break;case g.POS_PRED:t=R(y,m,m)!==!1||!S;break;case g.CONCAT_EXPR:Y(y,m,m),t=!0}}t||G.push(m,"=",m,"[0];")}function V(y,s,m){if(y.prop){var v=C(y.prop),S=I(),N=I(),x=I(),t=I(),E=I(),w=I(),o=I();G.push(S,"= [],",N,"= 0,",x,"=",m,".length,",o,"= [];","while(",N,"<",x,") {",t,"=",m,"[",N,"++];","if(",t,"!= null) {"),y.prop==="*"?(G.push("if(typeof ",t,'=== "object") {',"if(isArr(",t,")) {",S,"=",S,".concat(",t,");","}","else {","for(",E," in ",t,") {","if(",t,".hasOwnProperty(",E,")) {",w,"=",t,"[",E,"];"),H(S,w),G.push("}","}","}","}")):(G.push(w,"=",t,"[",v,"];"),H(S,w,o,x)),G.push("}","}",s,"=",x,"> 1 &&",o,".length?",o,".length > 1?",S,".concat.apply(",S,",",o,") :",S,".concat(",o,"[0]) :",S,";"),L(S,N,x,t,E,w,o)}}function P(y,s,m){var v=y.prop,T=I(),S=I(),x=I(),t=I(),N=I(),w=I(),o=I(),E=I();G.push(T,"=",m,".slice(),",E,"= [];","while(",T,".length) {",S,"=",T,".shift();"),v?G.push("if(typeof ",S,'=== "object" &&',S,") {"):G.push("if(typeof ",S,"!= null) {"),G.push(x,"= [];","if(isArr(",S,")) {",t,"= 0,",o,"=",S,".length;","while(",t,"<",o,") {",w,"=",S,"[",t,"++];"),v&&G.push("if(typeof ",w,'=== "object") {'),H(x,w),v&&G.push("}"),G.push("}","}","else {"),v?v!=="*"&&(G.push(w,"=",S,'["'+v+'"];'),H(E,w)):(H(E,S),G.push("if(typeof ",S,'=== "object") {')),G.push("for(",N," in ",S,") {","if(",S,".hasOwnProperty(",N,")) {",w,"=",S,"[",N,"];"),H(x,w),v==="*"&&H(E,w),G.push("}","}"),v||G.push("}"),G.push("}",x,".length &&",T,".unshift.apply(",T,",",x,");","}","}",s,"=",E,";"),L(T,S,x,t,N,w,o,E)}function X(w,x,t){var s=I(),p=I(),o=I(),v=I(),m=I();G.push(s,"= [];",p,"= 0;",o,"=",t,".length;","while(",p,"<",o,") {",m,"=",t,"[",p,"++];"),K(w.arg,v,m),G.push(B(w.arg,v),"&&",s,".push(",m,");","}",x,"=",s,";"),L(s,p,o,m,v)}function R(v,w,s){var p=v.arg,o,m;if(p.idx){var t=I();return K(p.idx,t,s),G.push(t,"< 0 && (",t,"=",s,".length +",t,");",w,"=",s,"[",t,"] == null? [] : [",s,"[",t,"]];"),L(t),!1}p.fromIdx?p.toIdx?(K(p.fromIdx,o=I(),s),K(p.toIdx,m=I(),s),G.push(w,"=",s,".slice(",o,",",m,");"),L(o,m)):(K(p.fromIdx,o=I(),s),G.push(w,"=",s,".slice(",o,");"),L(o)):(K(p.toIdx,m=I(),s),G.push(w,"=",s,".slice(0,",m,");"),L(m))}function K(p,o,a){switch(p.type){case g.PATH:Z(p,o,"["+a+"]");break;case g.COMPARISON_EXPR:W(p,o,a);break;case g.MATH_EXPR:U(p,o,a);break;case g.LOGICAL_EXPR:O(p,o,a);break;case g.UNARY_EXPR:A(p,o,a);break;case g.LITERAL:var m=p.val;G.push(o,"=",typeof m=="string"?C(m):m,";");break;case g.SUBST:G.push(o,"= subst.",p.name,";")}}function W(p,o,v){var ae=I(),ac=I(),N=I(),t=I(),T=I(),x=I(),S=I(),s=I(),E=p.args[0],ab=p.args[1];G.push(o,"= false;"),K(E,ae,v),K(ab,ac,v);var aa=E.type===g.PATH,ad=ab.type===g.LITERAL;G.push(N,"="),aa?G.push("true;"):G.push("isArr(",ae,");"),G.push(t,"="),ad?G.push("false;"):G.push("isArr(",ac,");"),G.push("if("),aa||G.push(N,"&&"),G.push(ae,".length === 1) {",ae,"=",ae,"[0];",N,"= false;","}"),ad||G.push("if(",t,"&&",ac,".length === 1) {",ac,"=",ac,"[0];",t,"= false;","}"),G.push(T,"= 0;","if(",N,") {",S,"=",ae,".length;"),ad||(G.push("if(",t,") {",s,"=",ac,".length;","while(",T,"<",S,"&& !",o,") {",x,"= 0;","while(",x,"<",s,") {"),D(p.op,[ae,"[",T,"]"].join(""),[ac,"[",x,"]"].join("")),G.push(o,"= true;","break;","}","++",x,";","}","++",T,";","}","}","else {")),G.push("while(",T,"<",S,") {"),D(p.op,[ae,"[",T,"]"].join(""),ac),G.push(o,"= true;","break;","}","++",T,";","}"),ad||G.push("}"),G.push("}"),ad||(G.push("else if(",t,") {",s,"=",ac,".length;","while(",T,"<",s,") {"),D(p.op,ae,[ac,"[",T,"]"].join("")),G.push(o,"= true;","break;","}","++",T,";","}","}")),G.push("else {",o,"=",z[p.op](ae,ac),";","}"),L(ae,ac,N,t,T,x,S,s)}function D(i,m,a){G.push("if(",z[i](m,a),") {")}function O(w,x,t){var s=[],p=w.args,o=p.length,v=0,m;G.push(x,"= false;");switch(w.op){case"&&":while(v<o){s.push(m=I()),K(p[v],m,t),G.push("if(",B(p[v++],m),") {")}G.push(x,"= true;");break;case"||":while(v<o){s.push(m=I()),K(p[v],m,t),G.push("if(",B(p[v],m),") {",x,"= true;","}"),v+++1<o&&G.push("else {")}--o}while(o--){G.push("}")}L.apply(null,s)}function U(t,v,s){var p=I(),o=I(),m=t.args;K(m[0],p,s),K(m[1],o,s),G.push(v,"=",z[t.op](e(m[0],p),e(m[1],o)),";"),L(p,o)}function A(p,s,o){var m=I(),a=p.arg;K(a,m,o);switch(p.op){case"!":G.push(s,"= !",B(a,m)+";");break;case"-":G.push(s,"= -",e(a,m)+";")}L(m)}function Y(t,v,p){var o=[],m=t.args,s=m.length,a=0;while(a<s){o.push(I()),Z(m[a],o[a++],p)}G.push(v,"= (",v,"= []).concat.call(",v,",",o.join(","),");"),L.apply(null,o)}function C(a){return"'"+a.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function H(o,p,m,a){G.push("if(",p,"!= null) {","if(isArr(",p,")) {"),m&&(G.push(a,"> 1?"),q(m,p),G.push(":")),G.push(o,"=",o,".concat(",p,");","}","else {"),m&&G.push("if(",m,".length) {",o,"=",o,".concat.apply(",o,",",m,");",m,"= [];","}"),q(o,p),G.push("}","}")}function q(a,i){G.push(a,".length?",a,".push(",i,") :",a,"[0] =",i)}function B(a,i){switch(a.type){case g.LOGICAL_EXPR:return i;case g.LITERAL:return"!!"+i;case g.PATH:return i+".length > 0";default:return["(typeof ",i,'=== "boolean"?',i,":","isArr(",i,")?",i,".length > 0 : !!",i,")"].join("")}}function e(a,i){switch(a.type){case g.LITERAL:return i;case g.PATH:return i+"[0]";default:return["(isArr(",i,")?",i,"[0] : ",i,")"].join("")}}var G,M,J,Q,z={"===":function(i,a){return i+"==="+a},"==":function(i,a){return["typeof ",i,'=== "string" && typeof ',a,'=== "string"?',i,".toLowerCase() ===",a,".toLowerCase() :"+i,"==",a].join("")},">=":function(i,a){return i+">="+a},">":function(i,a){return i+">"+a},"<=":function(i,a){return i+"<="+a},"<":function(i,a){return i+"<"+a},"!==":function(i,a){return i+"!=="+a},"!=":function(i,a){return i+"!="+a},"^==":function(i,a){return["typeof ",i,'=== "string" && typeof ',a,'=== "string" &&',i,".indexOf(",a,") === 0"].join("")},"^=":function(i,a){return[i,"!= null &&",a,"!= null &&",i,".toString().toLowerCase().indexOf(",a,".toString().toLowerCase()) === 0"].join("")},"$==":function(i,a){return["typeof ",i,'=== "string" && typeof ',a,'=== "string" &&',i,".lastIndexOf(",a,") ===",i,".length -",a,".length"].join("")},"$=":function(i,a){return[i,"!= null &&",a,"!= null &&","(",i,"=",i,".toLowerCase().toString()).indexOf(","(",a,"=",a,".toLowerCase().toLowerCase())) ===",i,".length -",a,".length"].join("")},"*==":function(i,a){return["typeof ",i,'=== "string" && typeof ',a,'=== "string" &&',i,".indexOf(",a,") > -1"].join("")},"*=":function(i,a){return[i,"!= null && ",a,"!= null &&",i,".toString().toLowerCase().indexOf(",a,".toString().toLowerCase()) > -1"].join("")},"+":function(i,a){return i+"+"+a},"-":function(i,a){return i+"-"+a},"*":function(i,a){return i+"*"+a},"/":function(i,a){return i+"/"+a},"%":function(i,a){return i+"%"+a}};return F}(),f={},l=[],c={cacheSize:100},j={cacheSize:function(m,a){if(a<m&&l.length>a){var o=l.splice(0,l.length-a),i=o.length;while(i--){delete f[o[i]]}}}},h=function(i,a,m){return f[i]||(f[i]=b(i),l.push(i)>c.cacheSize&&delete f[l.shift()]),f[i](a,m||{})};h.version="0.2.10",h.params=function(i){if(!arguments.length){return c}for(var a in i){i.hasOwnProperty(a)&&(j[a]&&j[a](c[a],i[a]),c[a]=i[a])}},h.compile=b,h.apply=h,typeof exports=="object"?module.exports=h:typeof modules=="object"?modules.define("jspath",function(a){a(h)}):typeof define=="function"?define(function(i,a,m){m.exports=h}):JSPath=h})();
