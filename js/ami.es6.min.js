/*!
 * AMI Web Framework
 *
 * Copyright (c) 2014-2018 The AMI Team / LPSC / IN2P3
 *
 * This file must be used under the terms of the CeCILL-C:
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-fr.html
 *
 */

"use strict";var amiTwig={};"undefined"!=typeof exports&&(amiTwig.fs=require("fs"),module.exports.amiTwig=amiTwig),amiTwig.tokenizer={tokenize:function(e,t,n,i,s,r){if(i.length!==s.length)throw"`tokenDefs.length != tokenTypes.length`";const a=[],o=[],l=[];let c=0;const p=e.length;let u,h,d="";e:for(;c<p;)if("\n"===(h=e.charAt(0))&&t++,n.indexOf(h)>=0){if(d){if(r)throw"invalid token `"+d+"`";a.push(d),o.push(-1),l.push(t),d=""}e=e.substring(1),c+=1}else{for(const n in i)if(u=this._match(e,i[n])){if(d){if(r)throw"invalid token `"+d+"`";a.push(d),o.push(-1),l.push(t),d=""}a.push(u),o.push(s[n]),l.push(t),e=e.substring(u.length),c+=u.length;continue e}d+=h,e=e.substring(1),c+=1}if(d){if(r)throw"invalid token `"+d+"`";a.push(d),o.push(-1),l.push(t)}return{tokens:a,types:o,lines:l}},_match:function(e,t){let n;return t instanceof RegExp?null!==(n=e.match(t))&&this._checkNextChar(e,n[0])?n[0]:null:0===(n=e.indexOf(t))&&this._checkNextChar(e,t)?t:null},_alnum:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,1,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],_checkNextChar:function(e,t){const n=t.length,i=e.charCodeAt(n-0),s=e.charCodeAt(n-1);return isNaN(i)||0===this._alnum[i]||0===this._alnum[s]}},amiTwig.expr={},amiTwig.expr.tokens={$init:function(){this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD],this.XXX_WITH=[this.STARTS_WITH,this.ENDS_WITH],this.PLUS_MINUS=[this.CONCAT,this.PLUS,this.MINUS],this.MUL_FLDIV_DIV_MOD=[this.MUL,this.FLDIV,this.DIV,this.MOD],this.RX=[this.RP,this.RB1]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,NOT:105,IS:106,DEFINED:107,NULL:108,EMPTY:109,ITERABLE:110,EVEN:111,ODD:112,CMP_OP:113,STARTS_WITH:114,ENDS_WITH:115,MATCHES:116,IN:117,RANGE:118,CONCAT:119,PLUS:120,MINUS:121,POWER:122,MUL:123,FLDIV:124,DIV:125,MOD:126,COLON:127,DOT:128,COMMA:129,PIPE:130,LP:131,RP:132,LB1:133,RB1:134,LB2:135,RB2:136,SID:137,TERMINAL:138,LST:200,DIC:201,FUN:202,VAR:203},amiTwig.expr.tokens.$init(),amiTwig.expr.Tokenizer=function(e,t){this._spaces=[" ","\t","\n","\r"],this._tokenDefs=["or","and","b-or","b-xor","b-and","not","is","defined","null","empty","iterable","even","odd","===","==","!==","!=","<=",">=","<",">",/^starts\s+with/,/^ends\s+with/,"matches","in","..","~","+","-","**","*","//","/","%",":",".",",","|","(",")","[","]","{","}","true","false",/^[0-9]+\.[0-9]+/,/^[0-9]+/,/^'(\\'|[^'])*'/,/^"(\\"|[^"])*"/,/^[a-zA-Z_$][a-zA-Z0-9_$]*/],this._tokenTypes=[amiTwig.expr.tokens.LOGICAL_OR,amiTwig.expr.tokens.LOGICAL_AND,amiTwig.expr.tokens.BITWISE_OR,amiTwig.expr.tokens.BITWISE_XOR,amiTwig.expr.tokens.BITWISE_AND,amiTwig.expr.tokens.NOT,amiTwig.expr.tokens.IS,amiTwig.expr.tokens.DEFINED,amiTwig.expr.tokens.NULL,amiTwig.expr.tokens.EMPTY,amiTwig.expr.tokens.ITERABLE,amiTwig.expr.tokens.EVEN,amiTwig.expr.tokens.ODD,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.CMP_OP,amiTwig.expr.tokens.STARTS_WITH,amiTwig.expr.tokens.ENDS_WITH,amiTwig.expr.tokens.MATCHES,amiTwig.expr.tokens.IN,amiTwig.expr.tokens.RANGE,amiTwig.expr.tokens.CONCAT,amiTwig.expr.tokens.PLUS,amiTwig.expr.tokens.MINUS,amiTwig.expr.tokens.POWER,amiTwig.expr.tokens.MUL,amiTwig.expr.tokens.FLDIV,amiTwig.expr.tokens.DIV,amiTwig.expr.tokens.MOD,amiTwig.expr.tokens.COLON,amiTwig.expr.tokens.DOT,amiTwig.expr.tokens.COMMA,amiTwig.expr.tokens.PIPE,amiTwig.expr.tokens.LP,amiTwig.expr.tokens.RP,amiTwig.expr.tokens.LB1,amiTwig.expr.tokens.RB1,amiTwig.expr.tokens.LB2,amiTwig.expr.tokens.RB2,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.TERMINAL,amiTwig.expr.tokens.SID],this.$init=function(e,t){const n=amiTwig.tokenizer.tokenize(e,t,this._spaces,this._tokenDefs,this._tokenTypes,!0);this.tokens=n.tokens,this.types=n.types,this.i=0},this.next=function(e=1){this.i+=e},this.isEmpty=function(){return this.i>=this.tokens.length},this.peekToken=function(){return this.tokens[this.i]},this.peekType=function(){return this.types[this.i]},this.checkType=function(e){if(this.i<this.tokens.length){const t=this.types[this.i];return e instanceof Array?e.indexOf(t)>=0:e===t}return!1},this.$init(e,t)},amiTwig.expr.Compiler=function(e,t){this.$init(e,t)},amiTwig.expr.Compiler.prototype={$init:function(e,t){if(this.tokenizer=new amiTwig.expr.Tokenizer(this.code=e,this.line=t),this.rootNode=this.parseFilter(),!1===this.tokenizer.isEmpty())throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"},dump:function(){return this.rootNode.dump()},parseFilter:function(){let e,t,n=this.parseLogicalOr();for(;this.tokenizer.checkType(amiTwig.expr.tokens.PIPE);){for(this.tokenizer.next(),t=e=this.parseDot1(!0);t.nodeType===amiTwig.expr.tokens.DOT;t=t.nodeLeft);t.list.unshift(n),n=e}return n},parseLogicalOr:function(){let e,t,n=this.parseLogicalAnd();for(;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_OR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseLogicalAnd(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseLogicalAnd:function(){let e,t,n=this.parseBitwiseOr();for(;this.tokenizer.checkType(amiTwig.expr.tokens.LOGICAL_AND);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseOr(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseBitwiseOr:function(){let e,t,n=this.parseBitwiseXor();for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_OR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseXor(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseBitwiseXor:function(){let e,t,n=this.parseBitwiseAnd();for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_XOR);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseBitwiseAnd(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseBitwiseAnd:function(){let e,t,n=this.parseNot();for(;this.tokenizer.checkType(amiTwig.expr.tokens.BITWISE_AND);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseNot(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseNot:function(){let e,t;return this.tokenizer.checkType(amiTwig.expr.tokens.NOT)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseComp(),t.nodeLeft=null,t.nodeRight=e,t):this.parseComp()},parseComp:function(){let e,t,n,i=this.parseAddSub();if(this.tokenizer.checkType(amiTwig.expr.tokens.IS)){if(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),n=t,this.tokenizer.checkType(amiTwig.expr.tokens.NOT)&&(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),t.nodeLeft=null,t.nodeRight=n),!this.tokenizer.checkType(amiTwig.expr.tokens.IS_XXX))throw"syntax error, line `"+this.line+"`, keyword `defined`, `null`, `empty`, `iterable`, `even` or `odd` expected";e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),n.nodeLeft=i,n.nodeRight=e,i=t}else this.tokenizer.checkType(amiTwig.expr.tokens.CMP_OP)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseAddSub(),t.nodeLeft=i,t.nodeRight=e,i=t):this.tokenizer.checkType(amiTwig.expr.tokens.XXX_WITH)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseAddSub(),t.nodeLeft=i,t.nodeRight=e,i=t):this.tokenizer.checkType(amiTwig.expr.tokens.MATCHES)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseAddSub(),t.nodeLeft=i,t.nodeRight=e,i=t):this.tokenizer.checkType(amiTwig.expr.tokens.IN)&&(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseAddSub(),t.nodeLeft=i,t.nodeRight=e,i=t);return i},parseAddSub:function(){let e,t,n=this.parseMulDiv();for(;this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseMulDiv(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseMulDiv:function(){let e,t,n=this.parsePlusMinus();for(;this.tokenizer.checkType(amiTwig.expr.tokens.MUL_FLDIV_DIV_MOD);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePlusMinus(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parsePlusMinus:function(){let e,t;return this.tokenizer.checkType(amiTwig.expr.tokens.PLUS_MINUS)?(t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parsePower(),t.nodeLeft=null,t.nodeRight=e,t):this.parsePower()},parsePower:function(){let e,t,n=this.parseDot1();for(;this.tokenizer.checkType(amiTwig.expr.tokens.POWER);)t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),e=this.parseDot1(),t.nodeLeft=n,t.nodeRight=e,n=t;return n},parseDot1:function(e){const t=this.parseDot2(e);if(t){let e=t;for(;e.nodeType===amiTwig.expr.tokens.DOT;e=e.nodeLeft);e.q&&(e.nodeType===amiTwig.expr.tokens.FUN?e.nodeValue in amiTwig.stdlib?e.nodeValue="amiTwig.stdlib."+e.nodeValue:e.nodeValue="_."+e.nodeValue:e.nodeType===amiTwig.expr.tokens.VAR&&(e.nodeValue="_."+e.nodeValue),e.q=!1)}return t},parseDot2:function(e){let t,n,i=this.parseDot3(e);for(;this.tokenizer.checkType(amiTwig.expr.tokens.DOT);)n=new amiTwig.expr.Node(this.tokenizer.peekType(),"."),this.tokenizer.next(),t=this.parseDot3(e),n.nodeLeft=i,n.nodeRight=t,i=n;return i},parseDot3:function(e){let t,n,i=this.parseX(e);for(;this.tokenizer.checkType(amiTwig.expr.tokens.LB1);){if(this.tokenizer.next(),t=this.parseFilter(),!this.tokenizer.checkType(amiTwig.expr.tokens.RB1))throw"syntax error, line `"+this.line+"`, `]` expected";this.tokenizer.next(),(n=new amiTwig.expr.Node(amiTwig.expr.tokens.DOT,"[]")).nodeLeft=i,n.nodeRight=t,i=n}return i},parseX:function(e){let t;if(t=this.parseGroup())return t;if(t=this.parseArray())return t;if(t=this.parseObject())return t;if(t=this.parseFunVar(e))return t;if(t=this.parseTerminal())return t;throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"},parseGroup:function(){let e;if(this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),e=this.parseFilter(),this.tokenizer.checkType(amiTwig.expr.tokens.RP))return this.tokenizer.next(),e;throw"syntax error, line `"+this.line+"`, `)` expected"}return null},parseArray:function(){let e,t;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB1)){if(this.tokenizer.next(),t=this._parseSinglets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB1))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.LST,"Array")).list=t,e;throw"syntax error, line `"+this.line+"`, `]` expected"}return null},parseObject:function(){let e,t;if(this.tokenizer.checkType(amiTwig.expr.tokens.LB2)){if(this.tokenizer.next(),t=this._parseDoublets(),this.tokenizer.checkType(amiTwig.expr.tokens.RB2))return this.tokenizer.next(),(e=new amiTwig.expr.Node(amiTwig.expr.tokens.DIC,"Object")).dict=t,e;throw"syntax error, line `"+this.line+"`, `}` expected"}return null},parseFunVar:function(e){let t;if(this.tokenizer.checkType(amiTwig.expr.tokens.SID)){if((t=new amiTwig.expr.Node(0,e?"filter_"+this.tokenizer.peekToken():this.tokenizer.peekToken())).q=!0,this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.LP)){if(this.tokenizer.next(),t.list=this._parseSinglets(),!this.tokenizer.checkType(amiTwig.expr.tokens.RP))throw"syntax error, line `"+this.line+"`, `)` expected";this.tokenizer.next(),t.nodeType=amiTwig.expr.tokens.FUN}else t.nodeType=e?amiTwig.expr.tokens.FUN:amiTwig.expr.tokens.VAR,t.list=[];return t}return null},_parseSinglets:function(){const e=[];for(;!1===this.tokenizer.checkType(amiTwig.expr.tokens.RX)&&(this._parseSinglet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseDoublets:function(){const e={};for(;!1===this.tokenizer.checkType(amiTwig.expr.tokens.RB2)&&(this._parseDoublet(e),!0===this.tokenizer.checkType(amiTwig.expr.tokens.COMMA));)this.tokenizer.next();return e},_parseSinglet:function(e){e.push(this.parseFilter())},_parseDoublet:function(e){if(!this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))throw"syntax error, line `"+this.line+"`, terminal expected";{const t=this.tokenizer.peekToken();if(this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.COLON))throw"syntax error, line `"+this.line+"`, `:` expected";this.tokenizer.next(),e[t]=this.parseFilter()}},parseTerminal:function(){let e,t,n;if(this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL)){if(e=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),!this.tokenizer.checkType(amiTwig.expr.tokens.RANGE))return e;if(n=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),this.tokenizer.checkType(amiTwig.expr.tokens.TERMINAL))return t=new amiTwig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()),this.tokenizer.next(),n.nodeLeft=e,n.nodeRight=t,n}return null}},amiTwig.expr.Node=function(e,t){this.$init(e,t)},amiTwig.expr.Node.prototype={$init:function(e,t){this.nodeType=e,this.nodeValue=t,this.nodeLeft=null,this.nodeRight=null,this.list=null,this.dict=null},_dump:function(e,t,n){let i;const s=n[0];if(e.push("\tnode"+s+' [label="'+this.nodeValue.replace(/"/g,'\\"')+'"];'),this.nodeLeft&&(i=++n[0],t.push("\tnode"+s+" -> node"+i+";"),this.nodeLeft._dump(e,t,n)),this.nodeRight&&(i=++n[0],t.push("\tnode"+s+" -> node"+i+";"),this.nodeRight._dump(e,t,n)),this.list)for(const r in this.list)i=++n[0],t.push("\tnode"+s+" -> node"+i+' [label="['+r.replace(/"/g,'\\"')+']"];'),this.list[r]._dump(e,t,n);if(this.dict)for(const r in this.dict)i=++n[0],t.push("\tnode"+s+" -> node"+i+' [label="['+r.replace(/"/g,'\\"')+']"];'),this.dict[r]._dump(e,t,n)},dump:function(){const e=[],t=[];return this._dump(e,t,[0]),"digraph ast {\n\trankdir=TB;\n"+e.join("\n")+"\n"+t.join("\n")+"\n}"}},amiTwig.tmpl={},amiTwig.tmpl.Compiler=function(e){this.$init(e)},amiTwig.tmpl.Compiler.prototype={STATEMENT_RE:/\{%\s*([a-zA-Z]+)\s+(.*?)\s*%\}/m,COMMENT_RE:/\{#\s*(.*?)\s*#\}/g,_count:function(e){let t=0;const n=e.length;for(let i=0;i<n;i++)"\n"===e[i]&&t++;return t},$init:function(e){let t,n,i=1;this.rootNode={line:i,keyword:"@root",expression:"",blocks:[{expression:"@true",list:[]}],value:""};const s=[this.rootNode],r=[0];let a;for(e=e.replace(this.COMMENT_RE,"");;e=e.substr(n)){const o=s[s.length-1];let l=r[r.length-1];const c=e.match(this.STATEMENT_RE);if(null===c){i+=this._count(e),o.blocks[l].list.push({line:i,keyword:"@text",expression:"",blocks:[],value:e});const t=[];for(let e=s.length-1;e>0;e--)"if"===s[e].keyword?t.push("missing keyword `endif`"):"for"===s[e].keyword&&t.push("missing keyword `endfor`");if(t.length>0)throw"syntax error, line `"+i+"`, "+t.join(", ");break}const p=c[0],u=c[1],h=c[2];t=c.index+0,n=c.index+p.length;const d=e.substr(0,t),f=e.substr(0,n);switch(i+=this._count(f),d&&(a={line:i,keyword:"@text",expression:"",blocks:[],value:d},o.blocks[l].list.push(a)),u){case"flush":case"autoescape":case"spaceless":case"verbatim":break;case"do":case"set":case"include":a={line:i,keyword:u,expression:h,blocks:[],value:""},o.blocks[l].list.push(a);break;case"if":case"for":a={line:i,keyword:u,blocks:[{expression:h,list:[]}],value:""},o.blocks[l].list.push(a),s.push(a),r.push(0);break;case"elseif":if("if"!==o.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `elseif`";l=o.blocks.length,o.blocks.push({expression:h,list:[]}),r[r.length-1]=l;break;case"else":if("if"!==o.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `else`";l=o.blocks.length,o.blocks.push({expression:"@true",list:[]}),r[r.length-1]=l;break;case"endif":if("if"!==o.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endif`";s.pop(),r.pop();break;case"endfor":if("for"!==o.keyword)throw"syntax error, line `"+i+"`, unexpected keyword `endfor`";s.pop(),r.pop();break;default:throw"syntax error, line `"+i+"`, unknown keyword `"+u+"`"}}},dump:function(){return JSON.stringify(this.rootNode,null,2)}},amiTwig.engine={VARIABLE_RE:/\{\{\s*(.*?)\s*\}\}/g,_render:function(e,t,n={}){let i,s;switch(this.dict=n,t.keyword){case"do":amiTwig.expr.cache.eval(t.expression,t.line,n);break;case"set":if(!(i=t.expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s*=\s*(.+)/)))throw"syntax error, line `"+t.line+"`, invalid `set` statement";n[i[1]]=amiTwig.expr.cache.eval(i[2],t.line,n);break;case"@text":e.push(t.value.replace(this.VARIABLE_RE,function(e,i){let s=amiTwig.expr.cache.eval(i,t.line,n);return null!==s&&void 0!==s?s:""}));break;case"if":case"@root":t.blocks.every(i=>"@true"!==(s=i.expression)&&!amiTwig.expr.cache.eval(s,t.line,n)||(i.list.forEach(t=>{this._render(e,t,n)}),!1));break;case"for":{if(!(i=t.blocks[0].expression.match(/([a-zA-Z_$][a-zA-Z0-9_$]*)\s+in\s+(.+)/)))throw"syntax error, line `"+t.line+"`, invalid `for` statement";const s=i[1],r=i[2];let a=amiTwig.expr.cache.eval(r,t.line,n);const o=Object.prototype.toString.call(a);if("[object Object]"===o)a=Object.keys(a);else if("[object Array]"!==o&&"[object String]"!==o)throw"syntax error, line `"+t.line+"`, right operande not iterable";const l=n[s],c=n.loop;let p=0;const u=a.length;n.loop={length:u};const h=t.blocks[0].list;for(const t in a){n[s]=a[t],n.loop.first=0===p,n.loop.last=p===u-1,n.loop.index0=p,p++,n.loop.index=p;for(const t in h)this._render(e,h[t],n)}n.loop=c,n[s]=l;break}case"include":{let r,a,o=t.expression;(i=o.match(/(.+)\s+with\s+(.+)\s+only$/))?(s=i[1],r=i[2],a=!1):(i=o.match(/(.+)\s+with\s+(.+)$/))?(s=i[1],r=i[2],a=!0):(i=o.match(/(.+)\s+only$/))?(s=i[1],r="{}",a=!1):(s=o,r="{}",a=!0);const l=amiTwig.expr.cache.eval(s,t.line,n)||"";if("[object String]"!==Object.prototype.toString.call(l))throw"runtime error, line `"+t.line+"`, string expected";const c=amiTwig.expr.cache.eval(r,t.line,n)||{};if("[object Object]"!==Object.prototype.toString.call(c))throw"runtime error, line `"+t.line+"`, object expected";e.push(amiTwig.stdlib.include(l,c,a,!1));break}}},render:function(e,t={}){const n=[];switch(Object.prototype.toString.call(e)){case"[object String]":this._render(n,new amiTwig.tmpl.Compiler(e).rootNode,t);break;case"[object Object]":this._render(n,e,t)}return n.join("")}},amiTwig.expr.cache={dict:{},eval:function(expression,line,_){let f;return f=expression in this.dict?this.dict[expression]:this.dict[expression]=eval(amiTwig.expr.interpreter.getJS(new amiTwig.expr.Compiler(expression,line))),_||(_={}),f.call(_,_)}},amiTwig.ajax={dict:{},get:function(e,t,n){let i;if(e in this.dict)t&&t(this.dict[e]);else if(amiTwig.fs)try{i=this.dict[e]=amiTwig.fs.readFileSync(e,"utf8"),t&&t(i)}catch(e){n&&n(e)}else{const s=new XMLHttpRequest;s.open("GET",e,!1),s.send(),200===s.status?(i=this.dict[e]=s.responseText,t&&t(i)):(i=s.responseText,n&&n(i))}}},amiTwig.stdlib={isUndefined:function(e){return void 0===e},isDefined:function(e){return void 0!==e},isNull:function(e){return null===e},isNotNull:function(e){return null!==e},isEmpty:function(e){if(null===e||!1===e||""===e)return!0;const t=Object.prototype.toString.call(e);return"[object Array]"===t&&0===e.length||"[object Object]"===t&&0===Object.keys(e).length},isNumber:function(e){return"[object Number]"===Object.prototype.toString.call(e)},isString:function(e){return"[object String]"===Object.prototype.toString.call(e)},isArray:function(e){return"[object Array]"===Object.prototype.toString.call(e)},isObject:function(e){return"[object Object]"===Object.prototype.toString.call(e)},isIterable:function(e){const t=Object.prototype.toString.call(e);return"[object String]"===t||"[object Array]"===t||"[object Object]"===t},isEven:function(e){return this.isNumber(e)&&0==(1&e)},isOdd:function(e){return this.isNumber(e)&&1==(1&e)},isInObject:function(e,t){return this.isArray(t)||this.isString(t)?t.indexOf(e)>=0:!!this.isObject(t)&&e in t},isInRange:function(e,t,n){return this.isNumber(t)&&this.isNumber(n)?e>=t&&e<=n:!(!this.isString(t)||1!==t.length||!this.isString(n)||1!==n.length)&&(e.charCodeAt(0)>=t.charCodeAt(0)&&e.charCodeAt(0)<=n.charCodeAt(0))},range:function(e,t,n=1){const i=[];if(this.isNumber(e)&&this.isNumber(t))for(let s=e;s<=t;s+=n)i.push(s);else if(this.isString(e)&&1===e.length&&this.isString(t)&&1===t.length)for(let s=e.charCodeAt(0);s<=t.charCodeAt(0);s+=n)i.push(String.fromCharCode(s));return i},filter_length:function(e){return this.isString(e)||this.isArray(e)?e.length:this.isObject(e)?Object.keys(e).length:0},filter_first:function(e){return(this.isString(e)||this.isArray(e))&&e.length>0?e[0]:""},filter_last:function(e){return(this.isString(e)||this.isArray(e))&&e.length>0?e[e.length-1]:""},filter_slice:function(e,t,n){return this.isString(e)||this.isArray(e)?e.slice(t,n):null},filter_merge:function(){if(arguments.length>1){if(this.isString(arguments[0])){const e=[];for(const t in arguments){const n=arguments[t];if(!this.isString(n))return null;e.push(arguments[t])}return e.join("")}if(this.isArray(arguments[0])){const e=[];for(const t in arguments){const n=arguments[t];if(!this.isArray(n))return null;for(const t in n)e.push(n[t])}return e}if(this.isObject(arguments[0])){const e={};for(const t in arguments){const n=arguments[t];if(!this.isObject(n))return null;for(const t in n)e[t]=n[t]}return e}}return null},filter_sort:function(e){return this.isArray(e)?e.sort():[]},filter_reverse:function(e){return this.isArray(e)?e.reverse():[]},filter_join:function(e,t){return this.isArray(e)?e.join(t):""},filter_keys:function(e){return this.isObject(e)?Object.keys(e):[]},startsWith:function(e,t){if(this.isString(e)&&this.isString(t)){const n=0;return e.indexOf(t,n)===n}return!1},endsWith:function(e,t){if(this.isString(e)&&this.isString(t)){const n=e.length-t.length;return e.indexOf(t,n)===n}return!1},match:function(e,t){if(this.isString(e)&&this.isString(t)){const n=t.indexOf("/"),i=t.lastIndexOf("/");if(0===n||n<i)try{return new RegExp(t.substring(n+1,i),t.substring(i+1)).test(e)}catch(e){}}return!1},filter_default:function(e,t){return e||t||""},filter_lower:function(e){return this.isString(e)?e.toLowerCase():""},filter_upper:function(e){return this.isString(e)?e.toUpperCase():""},filter_capitalize:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/^\S/g,function(e){return e.toUpperCase()}):""},filter_title:function(e){return this.isString(e)?e.trim().toLowerCase().replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()}):""},filter_trim:function(e){return this.isString(e)?e.trim():""},_replace:function(e,t,n){const i=[],s=e.length,r=t.length;if(r!=n.length)throw"internal error";e:for(let a=0;a<s;a+=0){const s=e.substring(a);for(let e=0;e<r;e+=1)if(0===s.indexOf(t[e])){i.push(n[e]),a+=t[e].length;continue e}i.push(e.charAt(a++))}return i.join("")},_textToHtmlX:["&",'"',"<",">"],_textToHtmlY:["&amp;","&quot;","&lt;","&gt;"],_textToStringX:["\\","\n",'"',"'"],_textToStringY:["\\\\","\\n",'\\"',"\\'"],filter_escape:function(e,t){if(this.isString(e))switch(t||"html"){case"html":case"html_attr":return this._replace(e,this._textToHtmlX,this._textToHtmlY);case"js":case"string":return this._replace(e,this._textToStringX,this._textToStringY);case"url":return encodeURIComponent(e);default:return e}return""},filter_url_encode:function(e){return this.isString(e)?encodeURIComponent(e):""},filter_nl2br:function(e){return this.isString(e)?e.replace(/\n/g,"<br/>"):""},filter_raw:function(e){return this.isString(e)?e:""},filter_replace:function(e,t){return this.isString(e)&&this.isObject(t)?this._replace(e,Object.keys(t),Object.values(t)):""},filter_split:function(e,t,n){return this.isString(e)?e.split(t,n):[]},filter_abs:function(e){return Math.abs(e)},filter_round:function(e,t){switch(t){case"ceil":return Math.ceil(e);case"floor":return Math.floor(e);default:return Math.round(e)}},min:function(){const e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;let t=Number.POSITIVE_INFINITY;for(const n in e){if(!this.isNumber(e[n]))return Number.NaN;t>e[n]&&(t=e[n])}return t},max:function(){const e=1===arguments.length&&(this.isArray(arguments[0])||this.isObject(arguments[0]))?arguments[0]:arguments;let t=Number.NEGATIVE_INFINITY;for(const n in e){if(!this.isNumber(e[n]))return Number.NaN;t<e[n]&&(t=e[n])}return t},random:function(e){const t=Math.random();if(e){if(this.isArray(e)||this.isObject(e)){const n=Object.keys(e);return e[n[Math.floor(n.length*t)]]}if(this.isString(e))return e[Math.floor(e.length*t)];if(this.isNumber(e))return Math.floor(e*t)}return e=Number.MAX_SAFE_INTEGER,Math.floor(e*t)},filter_json_encode:function(e,t){return JSON.stringify(e,null,this.isNumber(t)?t:2)},filter_json_jspath:function(e,t){return"undefined"!=typeof JSPath?JSPath.apply(t,e):[]},include:function(e,t={},n=!0,i=!1){const s={};if(n)for(const e in amiTwig.engine.dict)s[e]=amiTwig.engine.dict[e];if(t)for(const e in t)s[e]=t[e];let r="";return amiTwig.ajax.get(e,function(e){r=amiTwig.engine.render(e,s)},function(){if(!i)throw"runtime error, could not open `"+e+"`"}),r}},amiTwig.stdlib.filter_e=amiTwig.stdlib.filter_escape,amiTwig.expr.interpreter={_getJS:function(e){let t,n,i,s,r;switch(e.nodeType){case amiTwig.expr.tokens.LST:t=[];for(const n in e.list)t.push(this._getJS(e.list[n]));return"["+t.join(",")+"]";case amiTwig.expr.tokens.DIC:t=[];for(const n in e.dict)t.push(n+":"+this._getJS(e.dict[n]));return"{"+t.join(",")+"}";case amiTwig.expr.tokens.FUN:t=[];for(const n in e.list)t.push(this._getJS(e.list[n]));return e.nodeValue+"("+t.join(",")+")";case amiTwig.expr.tokens.VAR:t=[];for(const n in e.list)t.push("["+this._getJS(e.list[n])+"]");return t.length>0?e.nodeValue+t.join(""):e.nodeValue;case amiTwig.expr.tokens.TERMINAL:return e.nodeValue;case amiTwig.expr.tokens.IS:switch(i=this._getJS(e.nodeLeft),e.nodeRight.nodeType){case amiTwig.expr.tokens.DEFINED:return"amiTwig.stdlib.isDefined("+i+")";case amiTwig.expr.tokens.NULL:return"amiTwig.stdlib.isNull("+i+")";case amiTwig.expr.tokens.EMPTY:return"amiTwig.stdlib.isEmpty("+i+")";case amiTwig.expr.tokens.ITERABLE:return"amiTwig.stdlib.isIterable("+i+")";case amiTwig.expr.tokens.EVEN:return"amiTwig.stdlib.isEven("+i+")";case amiTwig.expr.tokens.ODD:return"amiTwig.stdlib.isOdd("+i+")";default:throw"internal error"}case amiTwig.expr.tokens.IN:return e.nodeRight.nodeType!==amiTwig.expr.tokens.RANGE?"amiTwig.stdlib.isInObject("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")":"amiTwig.stdlib.isInRange("+(n=this._getJS(e.nodeLeft))+","+(i=e.nodeRight.nodeLeft.nodeValue)+","+(s=e.nodeRight.nodeRight.nodeValue)+")";case amiTwig.expr.tokens.STARTS_WITH:return"amiTwig.stdlib.startsWith("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.ENDS_WITH:return"amiTwig.stdlib.endsWith("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.MATCHES:return"amiTwig.stdlib.match("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.RANGE:return"amiTwig.stdlib.range("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.DOT:return i=this._getJS(e.nodeLeft),s=this._getJS(e.nodeRight),"."===e.nodeValue[0]?i+"."+s:i+"["+s+"]";case amiTwig.expr.tokens.FLDIV:return"Math.floor("+(i=this._getJS(e.nodeLeft))+"/"+(s=this._getJS(e.nodeRight))+")";case amiTwig.expr.tokens.POWER:return"Math.pow("+(i=this._getJS(e.nodeLeft))+","+(s=this._getJS(e.nodeRight))+")";default:if(null===e.nodeLeft&&null!==e.nodeRight)return(r=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!")+"("+this._getJS(e.nodeRight)+")";if(null!==e.nodeLeft&&null===e.nodeRight)return r=e.nodeType!==amiTwig.expr.tokens.NOT?e.nodeValue:"!","("+this._getJS(e.nodeLeft)+")"+r;if(null!==e.nodeLeft&&null!==e.nodeRight){switch(e.nodeType){case amiTwig.expr.tokens.LOGICAL_OR:r="||";break;case amiTwig.expr.tokens.LOGICAL_AND:r="&&";break;case amiTwig.expr.tokens.BITWISE_OR:r="|";break;case amiTwig.expr.tokens.BITWISE_XOR:r="^";break;case amiTwig.expr.tokens.BITWISE_AND:r="&";break;case amiTwig.expr.tokens.CONCAT:r="+";break;default:r=e.nodeValue}return"("+(i=this._getJS(e.nodeLeft))+r+(s=this._getJS(e.nodeRight))+")"}}},getJS:function(e){return"(function(_) { return "+this._getJS(e.rootNode)+"; })"},eval:function(expr,_){return _||(_={}),eval(this.getJS(expr)).call(_,_)}},function(){var e={PATH:1,SELECTOR:2,OBJ_PRED:3,POS_PRED:4,LOGICAL_EXPR:5,COMPARISON_EXPR:6,MATH_EXPR:7,CONCAT_EXPR:8,UNARY_EXPR:9,POS_EXPR:10,LITERAL:11},t=function(){var t,n,i,s,r={ID:1,NUM:2,STR:3,BOOL:4,PUNCT:5,EOP:6},a={UNEXP_TOKEN:'Unexpected token "%0"',UNEXP_EOP:"Unexpected end of path"};function o(){for(var t,n=l();y("|");)k(),(t||(t=[n])).push(l());return t?{type:e.CONCAT_EXPR,args:t}:n}function l(){return y("(")?c():u()}function c(){w("(");var t=o();w(")");for(var n,i=[];n=p();)i.push(n);return i.length?t.type===e.PATH?(t.parts=t.parts.concat(i),t):(i.unshift(t),{type:e.PATH,parts:i}):t}function p(){return y("[")?function(){w("[");var t=function(){if(y(":"))return k(),{type:e.POS_EXPR,toIdx:g()};var t=g();if(y(":"))return k(),y("]")?{type:e.POS_EXPR,fromIdx:t}:{type:e.POS_EXPR,fromIdx:t,toIdx:g()};return{type:e.POS_EXPR,idx:t}}();return w("]"),{type:e.POS_PRED,arg:t}}():y("{")?function(){w("{");var t=h();return w("}"),{type:e.OBJ_PRED,arg:t}}():y("(")?c():void 0}function u(){_()||I(k());var t,n=!1;y("^")?(k(),n=!0):T()&&(t=k().val.substr(1));for(var i,s=[];i=b()?function(){var t,n=k().val,i=A();(y("*")||i.type===r.ID||i.type===r.STR)&&(t=k().val);return{type:e.SELECTOR,selector:n,prop:t}}():p();)s.push(i);return{type:e.PATH,fromRoot:n,subst:t,parts:s}}function h(){for(var t,n=d();y("||");)k(),(t||(t=[n])).push(d());return t?{type:e.LOGICAL_EXPR,op:"||",args:t}:n}function d(){for(var t,n=f();y("&&");)k(),(t||(t=[n])).push(f());return t?{type:e.LOGICAL_EXPR,op:"&&",args:t}:n}function f(){for(var t=function t(){var n=function(){var t=m();for(;y("+")||y("-");)t={type:e.MATH_EXPR,op:k().val,args:[t,m()]};return t}();for(;y("<")||y(">")||y("<=")||y(">=");)n={type:e.COMPARISON_EXPR,op:k().val,args:[n,t()]};return n}();y("==")||y("!=")||y("===")||y("!==")||y("^=")||y("^==")||y("$==")||y("$=")||y("*==")||y("*=");)t={type:e.COMPARISON_EXPR,op:k().val,args:[t,f()]};return t}function m(){for(var t=g();y("*")||y("/")||y("%");)t={type:e.MATH_EXPR,op:k().val,args:[t,m()]};return t}function g(){return y("!")||y("-")?{type:e.UNARY_EXPR,op:k().val,arg:g()}:function(){var t=A().type;if(t===r.STR||t===r.NUM||t===r.BOOL)return{type:e.LITERAL,val:k().val};if(_())return u();if(y("("))return function(){w("(");var e=h();return w(")"),e}();return I(k())}()}function y(e){var t=A();return t.type===r.PUNCT&&t.val===e}function _(){return b()||T()||y("^")}function b(){var e=A();if(e.type===r.PUNCT){var t=e.val;return"."===t||".."===t}return!1}function T(){var e=A();return e.type===r.ID&&"$"===e.val[0]}function w(e){var t=k();t.type===r.PUNCT&&t.val===e||I(t)}function A(){if(null!==i)return i;var e=n;return i=x(),n=e,i}function x(){for(;" "===t[n];)++n;if(n>=s)return{type:r.EOP,range:[n,n]};var e=function(){var e=n,i=t[n],s=t[n+1];if("."===i){if(S(s))return;return"."===t[++n]?{type:r.PUNCT,val:"..",range:[e,++n]}:{type:r.PUNCT,val:".",range:[e,n]}}if("="===s){var a=t[n+2];if("="===a){if("=!^$*".indexOf(i)>=0)return{type:r.PUNCT,val:i+s+a,range:[e,n+=3]}}else if("=!^$*><".indexOf(i)>=0)return{type:r.PUNCT,val:i+s,range:[e,n+=2]}}if(i===s&&("|"===i||"&"===i))return{type:r.PUNCT,val:i+s,range:[e,n+=2]};if(":{}()[]^+-*/%!><|".indexOf(i)>=0)return{type:r.PUNCT,val:i,range:[e,++n]}}();if(e||(e=function(){var e=t[n];if(!E(e))return;var i=n,a=e;for(;++n<s&&L(e=t[n]);)a+=e;return"true"===a||"false"===a?{type:r.BOOL,val:"true"===a,range:[i,n]}:{type:r.ID,val:a,range:[i,n]}}())||(e=function(){if('"'!==t[n]&&"'"!==t[n])return;var e,i=t[n],a=++n,o="",l=!1;for(;n<s;){if("\\"===(e=t[n++]))e=t[n++];else if(('"'===e||"'"===e)&&e===i){l=!0;break}o+=e}if(l)return{type:r.STR,val:o,range:[a,n]}}())||(e=function(){var e=n,i=t[n],a="."===i;if(a||S(i)){for(var o=i;++n<s;){if("."===(i=t[n])){if(a)return;a=!0}else if(!S(i))break;o+=i}return{type:r.NUM,val:a?parseFloat(o):parseInt(o,10),range:[e,n]}}}()))return e;e={range:[n,n]},n>=s?e.type=r.EOP:e.val=t[n],I(e)}function k(){var e;return i?(n=i.range[1],e=i,i=null,e):x()}function S(e){return"0123456789".indexOf(e)>=0}function E(e){return"$"===e||"@"===e||"_"===e||e>="a"&&e<="z"||e>="A"&&e<="Z"}function L(e){return E(e)||e>="0"&&e<="9"}function I(e){e.type===r.EOP&&C(e,a.UNEXP_EOP),C(e,a.UNEXP_TOKEN,e.val)}function C(e,t){var n=Array.prototype.slice.call(arguments,2),i=t.replace(/%(\d)/g,function(e,t){return n[t]||""}),s=new Error(i);throw s.column=e.range[0],s}return function(e){t=e.split(""),n=0,i=null,s=t.length;var a=o(),l=k();return l.type!==r.EOP&&I(l),a}}(),n=function(){var t,n,i,s;function r(){if(s.length)return s.shift();var e="v"+ ++i;return n.push(e),e}function a(){for(var e=arguments,t=e.length;t--;)s.push(e[t])}function o(e,n,i){if(e.prop){var s=f(e.prop),o=r(),l=r(),c=r(),p=r(),u=r(),h=r(),d=r();t.push(o,"= [];",l,"= 0;",c,"=",i,".length;",d,"= [];","while(",l,"<",c,") {",p,"=",i,"[",l,"++];","if(",p,"!= null) {"),"*"===e.prop?(t.push("if(typeof ",p,'=== "object") {',"if(isArr(",p,")) {",o,"=",o,".concat(",p,");","}","else {","for(",u," in ",p,") {","if(",p,".hasOwnProperty(",u,")) {",h,"=",p,"[",u,"];"),m(o,h),t.push("}","}","}","}")):(t.push(h,"=",p,"[",s,"];"),m(o,h,d,c)),t.push("}","}",n,"=",c,"> 1 &&",d,".length?",d,".length > 1?","concat.apply(",o,",",d,") :",o,".concat(",d,"[0]) :",o,";"),a(o,l,c,p,u,h,d)}}function l(e,n,i){var s=e.prop,o=r(),l=r(),c=r(),p=r(),u=r(),h=r(),d=r(),f=r();t.push(o,"=",i,".slice(),",f,"= [];","while(",o,".length) {",l,"=",o,".shift();"),s?t.push("if(typeof ",l,'=== "object" &&',l,") {"):t.push("if(typeof ",l,"!= null) {"),t.push(c,"= [];","if(isArr(",l,")) {",p,"= 0,",d,"=",l,".length;","while(",p,"<",d,") {",h,"=",l,"[",p,"++];"),s&&t.push("if(typeof ",h,'=== "object") {'),m(c,h),s&&t.push("}"),t.push("}","}","else {"),s?"*"!==s&&(t.push(h,"=",l,'["'+s+'"];'),m(f,h)):(m(f,l),t.push("if(typeof ",l,'=== "object") {')),t.push("for(",u," in ",l,") {","if(",l,".hasOwnProperty(",u,")) {",h,"=",l,"[",u,"];"),m(c,h),"*"===s&&m(f,h),t.push("}","}"),s||t.push("}"),t.push("}",c,".length &&",o,".unshift.apply(",o,",",c,");","}","}",n,"=",f,";"),a(o,l,c,p,u,h,d,f)}function c(e,n,i){var s=r(),o=r(),l=r(),c=r(),p=r();t.push(s,"= [];",o,"= 0;",l,"=",i,".length;","while(",o,"<",l,") {",p,"=",i,"[",o,"++];"),u(e.arg,c,p),t.push(y(e.arg,c),"&&",s,".push(",p,");","}",n,"=",s,";"),a(s,o,l,p,c)}function p(e,n,i){var s,o,l=e.arg;if(l.idx){var c=r();return u(l.idx,c,i),t.push(c,"< 0 && (",c,"=",i,".length +",c,");",n,"=",i,"[",c,"] == null? [] : [",i,"[",c,"]];"),a(c),!1}l.fromIdx?l.toIdx?(u(l.fromIdx,s=r(),i),u(l.toIdx,o=r(),i),t.push(n,"=",i,".slice(",s,",",o,");"),a(s,o)):(u(l.fromIdx,s=r(),i),t.push(n,"=",i,".slice(",s,");"),a(s)):(u(l.toIdx,o=r(),i),t.push(n,"=",i,".slice(0,",o,");"),a(o))}function u(n,i,s){switch(n.type){case e.PATH:!function(n,i,s){var r=n.parts,a=0,u=r.length;for(t.push(i,"=",n.fromRoot?"data":n.subst?"subst."+n.subst:s,";","isArr("+i+") || ("+i+" = ["+i+"]);");a<u;){var h=r[a++];switch(h.type){case e.SELECTOR:".."===h.selector?l(h,i,i):o(h,i,i);break;case e.OBJ_PRED:c(h,i,i);break;case e.POS_PRED:p(h,i,i);break;case e.CONCAT_EXPR:d(h,i,i)}}}(n,i,s);break;case e.CONCAT_EXPR:d(n,i,s);break;case e.COMPARISON_EXPR:!function(n,i,s){var o=r(),l=r(),c=r(),p=r(),d=r(),f=r(),m=r(),g=r(),y=n.args[0],_=n.args[1];t.push(i,"= false;"),u(y,o,s),u(_,l,s);var T=y.type===e.PATH,w=_.type===e.LITERAL;t.push(c,"="),T?t.push("true;"):t.push("isArr(",o,");"),t.push(p,"="),w?t.push("false;"):t.push("isArr(",l,");"),t.push("if("),T||t.push(c,"&&"),t.push(o,".length === 1) {",o,"=",o,"[0];",c,"= false;","}"),w||t.push("if(",p,"&&",l,".length === 1) {",l,"=",l,"[0];",p,"= false;","}"),t.push(d,"= 0;","if(",c,") {",m,"=",o,".length;"),w||(t.push("if(",p,") {",g,"=",l,".length;","while(",d,"<",m,"&& !",i,") {",f,"= 0;","while(",f,"<",g,") {"),h(n.op,[o,"[",d,"]"].join(""),[l,"[",f,"]"].join("")),t.push(i,"= true;","break;","}","++",f,";","}","++",d,";","}","}","else {"));t.push("while(",d,"<",m,") {"),h(n.op,[o,"[",d,"]"].join(""),l),t.push(i,"= true;","break;","}","++",d,";","}"),w||t.push("}"),t.push("}"),w||(t.push("else if(",p,") {",g,"=",l,".length;","while(",d,"<",g,") {"),h(n.op,o,[l,"[",d,"]"].join("")),t.push(i,"= true;","break;","}","++",d,";","}","}"));t.push("else {",i,"=",b[n.op](o,l),";","}"),a(o,l,c,p,d,f,m,g)}(n,i,s);break;case e.MATH_EXPR:!function(e,n,i){var s=r(),o=r(),l=e.args;u(l[0],s,i),u(l[1],o,i),t.push(n,"=",b[e.op](_(l[0],s),_(l[1],o)),";"),a(s,o)}(n,i,s);break;case e.LOGICAL_EXPR:!function(e,n,i){var s,o=[],l=e.args,c=l.length,p=0;switch(t.push(n,"= false;"),e.op){case"&&":for(;p<c;)o.push(s=r()),u(l[p],s,i),t.push("if(",y(l[p++],s),") {");t.push(n,"= true;");break;case"||":for(;p<c;)o.push(s=r()),u(l[p],s,i),t.push("if(",y(l[p],s),") {",n,"= true;","}"),1+p++<c&&t.push("else {");--c}for(;c--;)t.push("}");a.apply(null,o)}(n,i,s);break;case e.UNARY_EXPR:!function(e,n,i){var s=r(),o=e.arg;switch(u(o,s,i),e.op){case"!":t.push(n,"= !",y(o,s)+";");break;case"-":t.push(n,"= -",_(o,s)+";")}a(s)}(n,i,s);break;case e.LITERAL:var m=n.val;t.push(i,"=","string"==typeof m?f(m):m,";")}}function h(e,n,i){t.push("if(",b[e](n,i),") {")}function d(e,n,i){for(var s=[],o=e.args,l=o.length,c=0;c<l;)s.push(r()),u(o[c],s[c++],i);t.push(n,"= concat.call(",s.join(","),");"),a.apply(null,s)}function f(e){return"'"+e.replace(/\\/g,"\\\\").replace(/'/g,"\\'")+"'"}function m(e,n,i,s){t.push("if(",n,"!= null) {","if(isArr(",n,")) {"),i&&(t.push(s,"> 1?"),g(i,n),t.push(":")),t.push(e,"=",e,".length?",e,".concat(",n,") :",n,".slice()",";","}","else {"),i&&t.push("if(",i,".length) {",e,"= concat.apply(",e,",",i,");",i,"= [];","}"),g(e,n),t.push(";","}","}")}function g(e,n){t.push(e,".length?",e,".push(",n,") :",e,"[0] =",n)}function y(t,n){switch(t.type){case e.LOGICAL_EXPR:return n;case e.LITERAL:return"!!"+n;case e.PATH:return n+".length > 0";default:return["(typeof ",n,'=== "boolean"?',n,":","isArr(",n,")?",n,".length > 0 : !!",n,")"].join("")}}function _(t,n){switch(t.type){case e.LITERAL:return n;case e.PATH:return n+"[0]";default:return["(isArr(",n,")?",n,"[0] : ",n,")"].join("")}}var b={"===":function(e,t){return e+"==="+t},"==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string"?',e,".toLowerCase() ===",t,".toLowerCase() :"+e,"==",t].join("")},">=":function(e,t){return e+">="+t},">":function(e,t){return e+">"+t},"<=":function(e,t){return e+"<="+t},"<":function(e,t){return e+"<"+t},"!==":function(e,t){return e+"!=="+t},"!=":function(e,t){return e+"!="+t},"^==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".indexOf(",t,") === 0"].join("")},"^=":function(e,t){return[e,"!= null &&",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) === 0"].join("")},"$==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".length >=",t,".length &&",e,".lastIndexOf(",t,") ===",e,".length -",t,".length"].join("")},"$=":function(e,t){return[e,"!= null &&",t,"!= null &&","(",e,"=",e,".toString()).length >=","(",t,"=",t,".toString()).length &&","(",e,".toLowerCase()).lastIndexOf(","(",t,".toLowerCase())) ===",e,".length -",t,".length"].join("")},"*==":function(e,t){return["typeof ",e,'=== "string" && typeof ',t,'=== "string" &&',e,".indexOf(",t,") > -1"].join("")},"*=":function(e,t){return[e,"!= null && ",t,"!= null &&",e,".toString().toLowerCase().indexOf(",t,".toString().toLowerCase()) > -1"].join("")},"+":function(e,t){return e+"+"+t},"-":function(e,t){return e+"-"+t},"*":function(e,t){return e+"*"+t},"/":function(e,t){return e+"/"+t},"%":function(e,t){return e+"%"+t}};return function(r){if(t=[],n=["res"],i=0,s=[],u(r,"res","data"),t.unshift("var ",Array.isArray?"isArr = Array.isArray":'toStr = Object.prototype.toString, isArr = function(o) { return toStr.call(o) === "[object Array]"; }',", concat = Array.prototype.concat",",",n.join(","),";"),r.type===e.PATH){var a=r.parts[r.parts.length-1];a&&a.type===e.POS_PRED&&"idx"in a.arg&&t.push("res = res[0];")}return t.push("return res;"),t.join("")}}();function i(e){return Function("data,subst",n(t(e)))}var s={},r=[],a={cacheSize:100},o={cacheSize:function(e,t){if(t<e&&r.length>t)for(var n=r.splice(0,r.length-t),i=n.length;i--;)delete s[n[i]]}},l=function(e,t,n){return s[e]||(s[e]=i(e),r.push(e)>a.cacheSize&&delete s[r.shift()]),s[e](t,n||{})};l.version="0.3.4",l.params=function(e){if(!arguments.length)return a;for(var t in e)e.hasOwnProperty(t)&&(o[t]&&o[t](a[t],e[t]),a[t]=e[t])},l.compile=i,l.apply=l,"object"==typeof module&&"object"==typeof module.exports?module.exports=l:"object"==typeof modules?modules.define("jspath",function(e){e(l)}):"function"==typeof define?define(function(e,t,n){n.exports=l}):window.JSPath=l}(),String.prototype.startsWith||(String.prototype.startsWith=function(e){return 0===this.indexOf(e,0)}),String.prototype.endsWith||(String.prototype.endsWith=function(e){const t=this.length-e.length;return this.indexOf(e,t)===t});var _ami_internal_jQueryEach=jQuery.each,_ami_internal_jQueryAjax=jQuery.ajax;jQuery.each=function(e,t,n){return _ami_internal_jQueryEach(e,n?(e,i)=>t.call(n,e,i):t)},jQuery.ajax=function(e){if("object"==typeof e&&"sheet"===e.dataType){const t=$.Deferred(),[n,i]=amiWebApp.setup(["context","url"],[t,""],e);return i?$("head").append('<link rel="stylesheet" type="text/css" href="'+i+'"></link>').promise().done(()=>{t.resolveWith(n)}):t.rejectWith(n),t.promise()}return _ami_internal_jQueryAjax.apply(this,arguments)};var _ami_internal_modalZIndex=1050;function _$createNamespace(e,t){let n=window;const i=e.split(/\s*\.\s*/g),s=i.length-1;for(var r=0;r<s;r++)n=n[i[r]]?n[i[r]]:n[i[r]]={};n[i[r]]=t}function _$addToNamespace(e,t){let n=window;const i=e.split(/\s*\.\s*/g),s=i.length-1;for(var r=0;r<s;r++){if(!n[i[r]])throw"`"+e+"` (`"+i[r]+"`) not declared";n=n[i[r]]}n[i[r]]=t}function $AMINamespace(e,t){t||(t={}),t.$name=e,_$createNamespace(e,t),t.$&&t.$.apply(t)}function $AMIInterface(e,t){t||(t={});const n=function(){throw"could nor instantiate interface"};if(t.$extends)throw"`$extends` not allowed for interface";if(t.$implements)throw"`$implements` not allowed for interface";if(t.$)throw"`$` not allowed for interface";if(t.$init)throw"`$init` not allowed for interface";n.$name=e,n.$class=n,n.$members=t,_$addToNamespace(e,n)}function $AMIClass(e,t){t||(t={});const n=t.$extends instanceof Function?t.$extends.prototype:{},i=n.$implements instanceof Array?n.$implements:[],s=t.$implements instanceof Array?t.$implements:[],r=function(){for(const e in this.$implements)if(this.$implements.hasOwnProperty(e)){const t=this.$implements[e];for(const e in t.$members)if(t.$members.hasOwnProperty(e)){const n=t.$members[e];if(typeof this[e]!=typeof n)throw"class `"+this.$name+"` with must implement `"+t.$name+"."+e+"`"}}const e=this.$class._internal_super,t=this.$class._internal_added;this.$super={};for(const t in e)e.hasOwnProperty(t)&&(this.$super[t]=((e,t,n)=>(function(){return e[t].apply(n,arguments)}))(e,t,this));this.$added={};for(const e in t)t.hasOwnProperty(e)&&(this.$added[e]=((e,t,n)=>(function(){return e[t].apply(n,arguments)}))(t,e,this));this.$init&&this.$init.apply(this,arguments)};r._internal_super={},r._internal_added={};for(const e in n)("$init"===e||"$"!==e.charAt(0)||n.hasOwnProperty(e))&&(r._internal_super[e]=n[e],r.prototype[e]=n[e]);for(const e in t)("$init"===e||"$"!==e.charAt(0)||t.hasOwnProperty(e))&&(r._internal_added[e]=t[e],r.prototype[e]=t[e]);r.prototype.$name=e,r.prototype.$class=r,r.prototype.$implements=i.concat(s),_$addToNamespace(e,r),t.$&&t.$.apply(r)}function _ami_internal_then(e,t,n){e&&e.then?e.then(t,n):t()}function _ami_internal_always(e,t){e&&e.always?e.always(t):t()}$(document).on("show.bs.modal",".modal",function(){const e=$(this);setTimeout(()=>{$("body > .modal-backdrop:last").css("z-index",_ami_internal_modalZIndex++),e.css("z-index",_ami_internal_modalZIndex++)},10)}),"undefined"!=typeof exports&&(module.exports.Namespace=$AMINamespace,module.exports.Interface=$AMIInterface,module.exports.Class=$AMIClass),"undefined"!=typeof jQuery&&(jQuery.Namespace=$AMINamespace,jQuery.Interface=$AMIInterface,jQuery.Class=$AMIClass),$AMINamespace("amiRouter",{_scriptURL:"",_originURL:"",_webAppURL:"",_hash:"",_args:[],_routes:[],_eatSlashes:function(e){for(e=e.trim();"/"===e[e.length-1];)e=e.substring(0,e.length-1);return e},$:function(){this._args.length=0,this._routes.length=0;const e=window.location.href.trim(),t=window.location.hash.trim(),n=window.location.search.trim(),i=document.getElementsByTagName("script");for(let e,t=0;t<i.length;t++)if((e=i[t].src.indexOf("js/ami."))>0){this._scriptURL=i[t].src,this._originURL=this._eatSlashes(this._scriptURL.substring(0,e));break}this._webAppURL=this._eatSlashes(e.replace(/(?:\#|\?).*$/,"")),this._hash=this._eatSlashes(t.substring(1).replace(/\?.*$/,"")),n&&n.substring(1).split("&").forEach(e=>{const t=e.split("=");1===t.length?this._args[decodeURIComponent(t[0])]="":2===t.length&&(this._args[decodeURIComponent(t[0])]=decodeURIComponent(t[1]))})},getScriptURL:function(){return this._scriptURL},getOriginURL:function(){return this._originURL},getWebAppURL:function(){return this._webAppURL},getHash:function(){return this._hash},getArgs:function(){return this._args},append:function(e,t){return this._routes.unshift({regExp:e,handler:t}),this},remove:function(e){return this._routes=this._routes.filter(t=>t.regExp.toString()!==e.toString()),this},check:function(){let e;for(let t=0;t<this._routes.length;t++)if(e=this._hash.match(this._routes[t].regExp))return this._routes[t].handler.apply(amiRouter,e),!0;return!1},appendHistoryEntry:function(e,t=null){return!!history.pushState&&(history.pushState(t,null,this._webAppURL+this._eatSlashes(e)),!0)},replaceHistoryEntry:function(e,t=null){return!!history.replaceState&&(history.replaceState(t,null,this._webAppURL+this._eatSlashes(e)),!0)}}),$AMINamespace("ami"),$AMINamespace("amiWebApp",{_idRegExp:new RegExp("[a-zA-Z][a-zA-Z0-9]{7}_[a-zA-Z0-9]{4}_[a-zA-Z0-9]{4}_[a-zA-Z0-9]{4}_[a-zA-Z0-9]{12}","g"),_linkExp:new RegExp("\\[([^\\]]*)\\]\\(([^\\)]*)\\)","g"),_embedded:!1,_noBootstrap:!1,_sheets:[],_scripts:[],_controls:{},_subapps:{},_isReady:!1,_canLeave:!0,_currentSubAppInstance:new function(){this.onReady=function(){},this.onExit=function(){},this.onLogin=function(){},this.onLogout=function(){}},originURL:"/",webAppURL:"/",hash:"",args:{},$:function(){const e=amiRouter.getScriptURL(),t=e.indexOf("?");if(t>0){const n=e.substring(t).toLowerCase();this._embedded=n.indexOf("embedded")>=0,this._noBootstrap=n.indexOf("nobootstrap")>=0}this.originURL=amiRouter.getOriginURL(),this.webAppURL=amiRouter.getWebAppURL(),this.hash=amiRouter.getHash(),this.args=amiRouter.getArgs(),!1===this._noBootstrap&&"function"!=typeof jQuery.fn.modal&&(this.loadSheets([this.originURL+"/css/bootstrap.min.css",this.originURL+"/css/bootstrap-toggle.min.css",this.originURL+"/css/bootstrap-vertical-tabs.min.css",this.originURL+"/css/select2.min.css"]),this.loadScripts([this.originURL+"/js/popper.min.js",this.originURL+"/js/bootstrap.min.js",this.originURL+"/js/bootstrap-toggle.min.js",this.originURL+"/js/bootstrap-typeahead.min.js",this.originURL+"/js/select2.min.js"])),this.loadSheets([this.originURL+"/css/font-awesome.min.css",this.originURL+"/css/ami.min.css"])},isEmbedded:function(){return this._embedded},isLocal:function(){return"file:"===document.location.protocol||"localhost"===document.location.hostname||"127.0.0.1"===document.location.hostname},typeOf:function(e){const t=Object.prototype.toString.call(e);return t.startsWith("[object ")?t.substring(8,t.length-1):""},asArray:function(e){return"Array"===this.typeOf(e)?e:[e]},setup:function(e,t,n){const i=[],s=e.length;if(s!==t.length)throw"internal error";if(n)for(let r=0;r<s;r++)i.push(e[r]in n?n[e[r]]:t[r]);else for(let e=0;e<s;e++)i.push(t[e]);return i},replace:amiTwig.stdlib._replace,_textToHtmlX:["&",'"',"<",">"],_textToHtmlY:["&amp;","&quot;","&lt;","&gt;"],textToHtml:function(e){return this.replace(e||"",this._textToHtmlX,this._textToHtmlY)},htmlToText:function(e){return this.replace(e||"",this._textToHtmlY,this._textToHtmlX)},_textToStringX:["\\","\n",'"',"'"],_textToStringY:["\\\\","\\n",'\\"',"\\'"],textToString:function(e){return this.replace(e||"",this._textToStringX,this._textToStringY)},stringToText:function(e){return this.replace(e||"",this._textToStringY,this._textToStringX)},_htmlToStringX:["\\","\n","&quot;","'"],_htmlToStringY:["\\\\","\\n","\\&quot;","\\'"],htmlToString:function(e){return this.replace(e||"",this._htmlToStringX,this._htmlToStringY)},stringToHtml:function(e){return this.replace(e||"",this._htmlToStringY,this._htmlToStringX)},_base64:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-_",base64Encode:function(e){let t;const n=[],i=e.length,s=i%3,r=this._base64;for(let s=0;s<i;)t=e.charCodeAt(s++)<<16|e.charCodeAt(s++)<<8|e.charCodeAt(s++)<<0,n.push(r.charAt(t>>18&63)),n.push(r.charAt(t>>12&63)),n.push(r.charAt(t>>6&63)),n.push(r.charAt(t>>0&63));return 1===s?n.splice(-2,2):2===s&&n.splice(-1,1),n.join("")},base64Decode:function(e){let t;const n=[],i=e.length,s=i%4,r=this._base64;for(let s=0;s<i;)t=r.indexOf(e.charAt(s++))<<18|r.indexOf(e.charAt(s++))<<12|r.indexOf(e.charAt(s++))<<6|r.indexOf(e.charAt(s++))<<0,n.push(String.fromCharCode(t>>>16&255)),n.push(String.fromCharCode(t>>>8&255)),n.push(String.fromCharCode(t>>>0&255));return 2===s?n.splice(-2,2):3===s&&n.splice(-1,1),n.join("")},_getExtension:function(e){const t=e.lastIndexOf(".");return t>0?e.substring(t):""},_getDataType:function(e,t){let n;if("auto"===t)if(0===e.indexOf("ctrl:"))n="control";else if(0===e.indexOf("subapp:"))n="subapp";else switch(this._getExtension(e).toLowerCase()){case".css":n="sheet";break;case".js":n="script";break;case".json":n="json";break;case".xml":n="xml";break;default:n="text"}else n=t;return n},__loadXXX:function(e,t,n,i,s){if(0===n.length)return e.resolveWith(s,[t]);const r=n.shift().trim(),a=this._getDataType(r,i);switch(a){case"control":this.loadControl(r).then(r=>{t.push(r),this.__loadXXX(e,t,n,i,s)},t=>{e.rejectWith(s,[t])});break;case"subapp":this.loadSubApp(r).then(r=>{t.push(r),this.__loadXXX(e,t,n,i,s)},t=>{e.rejectWith(s,[t])});break;case"sheet":this._sheets.indexOf(r)>=0?(t.push(!1),this.__loadXXX(e,t,n,i,s)):$.ajax({url:r,async:!1,cache:!1,crossDomain:!0,dataType:a}).then(()=>{t.push(!0),this._sheets.push(r),this.__loadXXX(e,t,n,i,s)},()=>{e.rejectWith(s,["could not load `"+r+"`"])});break;case"script":this._scripts.indexOf(r)>=0?(t.push(!1),this.__loadXXX(e,t,n,i,s)):$.ajax({url:r,async:!1,cache:!1,crossDomain:!0,dataType:a}).then(()=>{t.push(!0),this._scripts.push(r),this.__loadXXX(e,t,n,i,s)},()=>{e.rejectWith(s,["could not load `"+r+"`"])});break;default:$.ajax({url:r,async:!0,cache:!1,crossDomain:!0,dataType:a}).then(r=>{t.push(r),this.__loadXXX(e,t,n,i,s)},()=>{e.rejectWith(s,["could not load `"+r+"`"])})}},_loadXXX:function(e,t,n){const i=$.Deferred(),[s]=this.setup(["context"],[i],n);return this.__loadXXX(i,[],this.asArray(e),t,s),i.promise()},loadResources:function(e,t){return this._loadXXX(e,"auto",t)},loadSheets:function(e,t){return this._loadXXX(e,"sheet",t)},loadScripts:function(e,t){return this._loadXXX(e,"script",t)},loadJSONs:function(e,t){return this._loadXXX(e,"json",t)},loadXMLs:function(e,t){return this._loadXXX(e,"xml",t)},loadHTMLs:function(e,t){return this._loadXXX(e,"text",t)},loadTWIGs:function(e,t){return this._loadXXX(e,"text",t)},loadTexts:function(e,t){return this._loadXXX(e,"text",t)},_xxxHTML:function(e,t,n,i){const s=$.Deferred(),[r,a,o]=this.setup(["context","suffix","dict"],[s,null,null],i);a&&(t=t.replace(this._idRegExp,function(e){return e+"_instance"+a}));let l=this.formatTWIG(t,o);const c=$(e);let p;switch(n){case 0:p=c.html(l).promise();break;case 1:p=c.prepend(l).promise();break;case 2:p=c.append(l).promise();break;default:throw"internal error"}return p.done(()=>{jQuery.fn.tooltip&&c.find('[data-toggle="tooltip"]').tooltip({container:"body",html:!1,delay:{show:500,hide:100}}),jQuery.fn.popover&&c.find('[data-toggle="popover"]').popover({container:"body",html:!0,delay:{show:500,hide:100}}),jQuery.fn.bootstrapToggle&&c.find('input[type="checkbox"][data-toggle="toggle"]').bootstrapToggle(),s.resolveWith(r,[l])}),s.promise()},replaceHTML:function(e,t,n){return this._xxxHTML(e,t,0,n)},prependHTML:function(e,t,n){return this._xxxHTML(e,t,1,n)},appendHTML:function(e,t,n){return this._xxxHTML(e,t,2,n)},formatTWIG:function(e,t){const n=[],i=(e,t)=>("Object"!==this.typeOf(t)&&(t={}),t.ORIGIN_URL=this.originURL,t.WEBAPP_URL=this.webAppURL,amiTwig.engine.render(e,t));try{"Array"===this.typeOf(t)?t.forEach(t=>{n.push(i(e,t))}):n.push(i(e,t))}catch(e){n.length=0,this.error(e)}return n.join("")},jspath:function(e,t){return JSPath.apply(e,t)},getStack:function(){try{throw Error()}catch(e){try{return e.stack}catch(e){return""}}},lock:function(){$("#ami_locker").css("display","block");let e=this.getStack().split("\n");e.length>2&&console.log("lock@"+e[2])},unlock:function(){$("#ami_locker").css("display","none");let e=this.getStack().split("\n");e.length>2&&console.log("unlock@"+e[2])},canLeave:function(){this._canLeave=!0},cannotLeave:function(){this._canLeave=!1},_publishAlert:function(e,t,n){const i=$(n||"#ami_alert_content");i.html(e.replace(this._linkExp,'<a href="$1" target="_blank">$2</a>')).promise().done(()=>{$(document).scrollTop(0),this.unlock(),t&&i.find(".alert").fadeOut(6e4)})},info:function(e,t,n){"Array"===this.typeOf(e)&&(e=e.join(". ")),console.log("AMI INFO: "+e+"\n"+this.getStack()),this._publishAlert('<div class="alert alert-info alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span>&times;</span><span class="sr-only">Close</span></button><strong>Info!</strong> '+this.textToHtml(e)+"</div>",t,n)},success:function(e,t,n){"Array"===this.typeOf(e)&&(e=e.join(". ")),console.log("AMI SUCCESS: "+e+"\n"+this.getStack()),this._publishAlert('<div class="alert alert-success alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span>&times;</span><span class="sr-only">Close</span></button><strong>Success!</strong> '+this.textToHtml(e)+"</div>",t,n)},warning:function(e,t,n){"Array"===this.typeOf(e)&&(e=e.join(". ")),console.log("AMI WARNING: "+e+"\n"+this.getStack()),this._publishAlert('<div class="alert alert-warning alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span>&times;</span><span class="sr-only">Close</span></button><strong>Warning!</strong> '+this.textToHtml(e)+"</div>",t,n)},error:function(e,t,n){"Array"===this.typeOf(e)&&(e=e.join(". ")),console.log("AMI ERROR: "+e+"\n"+this.getStack()),this._publishAlert('<div class="alert alert-danger alert-dismissible" role="alert"><button type="button" class="close" data-dismiss="alert"><span>&times;</span><span class="sr-only">Close</span></button><strong>Error!</strong> '+this.textToHtml(e)+"</div>",t,n)},flush:function(){$("#ami_alert_content").empty()},fillBreadcrumb:function(e){var t="Array"===this.typeOf(e)?e.map(e=>'<li class="breadcrumb-item">'+e.replace(/{{WEBAPP_URL}}/g,this.webAppURL)+"</li>").join(""):"";$("#ami_breadcrumb_content").html(t)},onReady:function(){this._embedded||alert("error: `amiWebApp.onReady()` must be overloaded!")},onRefresh:function(){this._embedded||alert("error: `amiWebApp.onRefresh()` must be overloaded!")},start:function(e){const[t,n,i,s,r,a,o]=this.setup(["logo_url","home_url","contact_email","about_url","theme_url","locker_url","endpoint_url"],[this.originURL+"/images/logo.png",this.webAppURL,"ami@lpsc.in2p3.fr","http://cern.ch/ami/",this.originURL+"/twig/AMI/Theme/blue.twig",this.originURL+"/twig/AMI/Fragment/locker.twig",this.originURL+"/AMI/FrontEnd"],e);amiCommand.endpoint=o,window.onbeforeunload=(e=>{if(!this._canLeave){const t=e||window.event;return t&&(t.returnValue="Confirm that you want to leave this page?"),"Confirm that you want to leave this page?"}});const l=this.originURL+"/controls/CONTROLS.json",c=this.originURL+"/subapps/SUBAPPS.json";$.ajax({url:l,cache:!1,crossDomain:!0,dataType:"json"}).then(e=>{$.ajax({url:c,cache:!1,crossDomain:!0,dataType:"json"}).then(o=>{for(const t in e)this._controls[t.toLowerCase()]=e[t];for(const e in o)this._subapps[e.toLowerCase()]=o[e];if(this._embedded)$.ajax({url:a,cache:!0,crossDomain:!0,dataType:"text"}).done(e=>{$("body").append(e).promise().done(()=>{amiLogin._start().fail(e=>{this.error(e)})})});else{const e={LOGO_URL:t,HOME_URL:n,CONTACT_EMAIL:i,ABOUT_URL:s};$.ajax({url:r,cache:!0,crossDomain:!0,dataType:"text"}).then(t=>{$.ajax({url:a,cache:!0,crossDomain:!0,dataType:"text"}).then(n=>{$("body").append(this.formatTWIG(t,e)+n).promise().done(()=>{amiLogin._start().fail(e=>{this.error(e)})})},()=>{alert("could not open `"+a+"`, please reload the page...")})},()=>{alert("could not open `"+r+"`, please reload the page...")})}},()=>{alert("could not open `"+c+"`, please reload the page...")})},()=>{alert("could not open `"+l+"`, please reload the page...")})},loadControl:function(e,t){const n=$.Deferred(),[i]=this.setup(["context"],[n],t);0===e.indexOf("ctrl:")&&(e=e.substring(5));const s=this._controls[e.toLowerCase()];return s?this.loadScripts(this.originURL+"/"+s.file).then(t=>{try{const r=window[s.clazz];_ami_internal_then(t[0]?r.prototype.onReady.apply(r.prototype):null,()=>{n.resolveWith(i,[r])},t=>{n.rejectWith(i,["could not load control `"+e+"`: "+t])})}catch(t){n.rejectWith(i,["could not load control `"+e+"`: "+t])}},t=>{n.rejectWith(i,["could not load control `"+e+"`: "+t])}):n.rejectWith(i,["could not find control `"+e+"`"]),n.promise()},createControl:function(e,t,n,i,s){const r=$.Deferred(),[a]=this.setup(["context"],[r],s);return this.loadControl(n,s).done(n=>{let s=new n(e,t);n.prototype.render.apply(s,i).done(()=>{r.resolveWith(a,[s])}).fail(e=>{r.rejectWith(a,[e])})}).fail(e=>{r.rejectWith(a,[e])}),r.promise()},triggerLogin:function(){const e=$.Deferred();return this._isReady?_ami_internal_then(this._currentSubAppInstance.onLogin(this.args.userdata),()=>{_ami_internal_always(this.onRefresh(!0),()=>{e.resolve()})},t=>{e.reject(t)}):e.resolve(),e.promise()},triggerLogout:function(){const e=$.Deferred();return this._isReady?_ami_internal_then(this._currentSubAppInstance.onLogout(this.args.userdata),()=>{_ami_internal_always(this.onRefresh(!1),()=>{e.resolve()})},t=>{e.reject(t)}):e.resolve(),e.promise()},loadSubApp:function(e,t,n){const i=$.Deferred(),[s]=this.setup(["context"],[i],n);this.lock(),i.always(()=>{this.unlock()}),0===e.indexOf("subapp:")&&(e=e.substring(7));const r=this._subapps[e.toLowerCase()];return r?this.loadScripts(this.originURL+"/"+r.file).then(n=>{try{this._currentSubAppInstance.onExit(t);const a=window[r.instance];this._currentSubAppInstance=a,this.fillBreadcrumb(r.breadcrumb),_ami_internal_then(n[0]?a.onReady(t):null,()=>{(amiLogin.isAuthenticated()?this.triggerLogin():this.triggerLogout()).then(()=>{i.resolveWith(s,[a])},t=>{i.rejectWith(s,["could not load subapp `"+e+"`: "+t])})},t=>{i.rejectWith(s,["could not load subapp `"+e+"`: "+t])})}catch(t){i.rejectWith(s,["could not load subapp `"+e+"`: "+t])}},t=>{i.rejectWith(s,["could not load subapp `"+e+"`: "+t])}):i.rejectWith(s,["could not find subapp `"+e+"`"]),i.promise()},loadSubAppByURL:function(e,t){const n=$.Deferred();if(this.args.v)amiCommand.execute('GetHashInfo -hash="'+this.textToString(this.args.v)+'"').fail(e=>{n.reject(this.jspath("..error.$",e))}).done(i=>{var s;try{s=JSON.parse(this.jspath('..field{.@name==="json"}.$',i)[0]||"{}")}catch(e){s={}}const r=s.subapp||e,a=s.userdata||t;this.loadSubApp(r,a).then(()=>{n.resolve()},e=>{n.reject(e)})});else if(!amiRouter.check()){const i=this.args.subapp||e,s=this.args.userdata||t;this.loadSubApp(i,s).then(()=>{n.resolve()},e=>{n.reject(e)})}return n.promise()}}),$AMIInterface("ami.IControl",{patchId:function(){},replaceHTML:function(){},prependHTML:function(){},appendHTML:function(){},onReady:function(){}}),$AMIInterface("ami.ISubApp",{onReady:function(){},onExit:function(){},onLogin:function(){},onLogout:function(){}}),$AMIClass("ami.Control",{$implements:[ami.IControl],$:function(){ami.Control.instanceCnt=1},$init:function(e,t){this._parent=e||this,this._owner=t||this,this.instanceSuffix=ami.Control.instanceCnt++},getParent:function(){return this._parent},getOwner:function(){return this._owner},patchId:function(e){return e+"_instance"+this.instanceSuffix},replaceHTML:function(e,t,n){return n||(n={}),n.suffix=this.instanceSuffix,amiWebApp.replaceHTML(e,t,n)},prependHTML:function(e,t,n){return n||(n={}),n.suffix=this.instanceSuffix,amiWebApp.prependHTML(e,t,n)},appendHTML:function(e,t,n){return n||(n={}),n.suffix=this.instanceSuffix,amiWebApp.appendHTML(e,t,n)}}),$AMIClass("ami.SubApp",{$implements:[ami.ISubApp],onExit:function(){},onLogin:function(){},onLogout:function(){}}),$AMINamespace("amiCommand",{endpoint:"http://xxyy.zz",converter:"AMIXmlToJson.xsl",execute:function(e,t){const n=$.Deferred(),[i,s,r,a,o,l]=amiWebApp.setup(["endpoint","converter","context","timeout","extraParam","extraValue"],[this.endpoint,this.converter,n,0,null,null],t),c=i.trim(),p=e.trim(),u=s.trim(),h={Command:p,Converter:u};o&&(h[o]=l||null);const d=c+"?"+$.param(h);return"AMIXmlToJson.xsl"===u?$.ajax({url:c,data:h,type:"POST",timeout:a,dataType:"json",xhrFields:{withCredentials:!0},success:e=>{0===JSPath.apply(".AMIMessage.error",e).length?n.resolveWith(r,[e,d]):n.rejectWith(r,[e,d])},error:(e,t)=>{"error"===t&&(t="service temporarily unreachable");const i={AMIMessage:[{error:[{$:t}]}]};n.rejectWith(r,[i,d])}}):$.ajax({url:c,data:h,type:"POST",timeout:a,dataType:"text",xhrFields:{withCredentials:!0},success:e=>{n.resolveWith(r,[e,d])},error:(e,t)=>{"error"===t&&(t="service temporarily unreachable"),n.rejectWith(r,[t,d])}}),n.promise()},passLogin:function(e,t,n){const i=$.Deferred(),[s]=amiWebApp.setup(["context"],[i],n);return this.execute('GetSessionInfo -AMIUser="'+amiWebApp.textToString(e)+'" -AMIPass="'+amiWebApp.textToString(t)+'"',{extraParam:"NoCert"}).then(e=>{const t={},n={},r={};JSPath.apply('..rowset{.@type==="user"}.row.field',e).forEach(e=>{t[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="sso"}.row.field',e).forEach(e=>{r[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="role"}.row',e).forEach(e=>{let t="";const i={};e.field.forEach(e=>{i[e["@name"]]=e.$,"name"===e["@name"]&&(t=e.$)}),n[t]=i}),i.resolveWith(s,[e,t,n,r])},e=>{i.rejectWith(s,[e,{AMIUser:"guest",guestUser:"guest"},{},""])}),i.promise()},certLogin:function(e){const t=$.Deferred(),[n]=amiWebApp.setup(["context"],[t],e);return this.execute("GetSessionInfo").then(e=>{const i={},s={},r={};JSPath.apply('..rowset{.@type==="user"}.row.field',e).forEach(e=>{i[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="sso"}.row.field',e).forEach(e=>{r[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="role"}.row',e).forEach(e=>{let t="";const n={};e.field.forEach(e=>{n[e["@name"]]=e.$,"name"===e["@name"]&&(t=e.$)}),s[t]=n}),t.resolveWith(n,[e,i,s,r])},e=>{t.rejectWith(n,[e,{AMIUser:"guest",guestUser:"guest"},{},""])}),t.promise()},logout:function(e){const t=$.Deferred(),[n]=amiWebApp.setup(["context"],[t],e);return this.execute('GetSessionInfo -AMIUser="" -AMIPass=""',{extraParam:"NoCert"}).then(e=>{const i={},s={},r={};JSPath.apply('..rowset{.@type==="user"}.row.field',e).forEach(e=>{i[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="sso"}.row.field',e).forEach(e=>{r[e["@name"]]=e.$}),JSPath.apply('..rowset{.@type==="role"}.row',e).forEach(e=>{let t="";const n={};e.field.forEach(e=>{n[e["@name"]]=e.$,"name"===e["@name"]&&(t=e.$)}),s[t]=n}),t.resolveWith(n,[e,i,s,r])},e=>{t.rejectWith(n,[e,{AMIUser:"guest",guestUser:"guest"},{},""])}),t.promise()},attachCert:function(e,t,n){return this.execute('GetSessionInfo -attachCert -amiLogin="'+amiWebApp.textToString(e)+'" -amiPassword="'+amiWebApp.textToString(t)+'"',n)},detachCert:function(e,t,n){return this.execute('GetSessionInfo -detachCert -amiLogin="'+amiWebApp.textToString(e)+'" -amiPassword="'+amiWebApp.textToString(t)+'"',n)},addUser:function(e,t,n,i,s,r,a){return this.execute('AddUser -amiLogin="'+amiWebApp.textToString(e)+'" -amiPassword="'+amiWebApp.textToString(t)+'" -firstName="'+amiWebApp.textToString(n)+'" -lastName="'+amiWebApp.textToString(i)+'" -email="'+amiWebApp.textToString(s)+'"'+(r?" -attach":""),a)},changeInfo:function(e,t,n,i){return this.execute('SetUserInfo -firstName="'+amiWebApp.textToString(e)+'" -lastName="'+amiWebApp.textToString(t)+'" -email="'+amiWebApp.textToString(n)+'"',i)},changePass:function(e,t,n){return this.execute('ChangePassword -amiPasswordOld="'+amiWebApp.textToString(e)+'" -amiPasswordNew="'+amiWebApp.textToString(t)+'"',n)},resetPass:function(e,t){return this.execute('ResetPassword -amiLogin="'+amiWebApp.textToString(e)+'"',t)}}),$AMINamespace("amiLogin",{user:"guest",guest:"guest",clientDN:"",issuerDN:"",roleInfo:{},ssoInfo:{},_start:function(){const e=$.Deferred();return amiWebApp.lock(),amiWebApp.loadTWIGs([amiWebApp.originURL+"/twig/AMI/Fragment/login_button.twig",amiWebApp.originURL+"/twig/AMI/Fragment/logout_button.twig",amiWebApp.originURL+"/twig/AMI/Modal/login.twig"]).done(t=>{this.fragmentLoginButton=t[0],this.fragmentLogoutButton=t[1],amiWebApp.appendHTML("body",t[2]),$("#B7894CC1_1DAA_4A7E_B7D1_DBDF6F06AC73").submit(e=>{this.form_login(e)}),$("#EE055CD4_E58F_4834_8020_986AE3F8D67D").submit(e=>{this.form_addUser(e)}),$("#DA2047A2_9E5D_420D_B6E7_FA261D2EF10F").submit(e=>{this.form_remindPass(e)}),$("#D9EAF998_ED8E_44D2_A0BE_8C5CF5E438BD").submit(e=>{this.form_changeInfo(e)}),$("#E92A1097_983B_4857_875F_07E4659B41B0").submit(e=>{this.form_changePass(e)}),$("#E6E30EEC_15EE_4FCF_9809_2B8EC2FEF388,#CCD8E6F1_6DF8_4BDD_A0EC_C3C380830187").change(()=>{const e=$("#E6E30EEC_15EE_4FCF_9809_2B8EC2FEF388").val(),t=$("#CCD8E6F1_6DF8_4BDD_A0EC_C3C380830187").val();$("#CCD8E6F1_6DF8_4BDD_A0EC_C3C380830187").get(0).setCustomValidity(e.length>0&&t.length>0&&e!==t?"Passwords don't match.":"")}),$("#D487FE72_8D95_4048_BEA3_252274862AF4,#EE1DA58C_3761_4734_A9C2_E808CDD7EE77").change(()=>{const e=$("#D487FE72_8D95_4048_BEA3_252274862AF4").val(),t=$("#EE1DA58C_3761_4734_A9C2_E808CDD7EE77").val();$("#EE1DA58C_3761_4734_A9C2_E808CDD7EE77").get(0).setCustomValidity(e.length>0&&t.length>0&&e!==t?"Passwords don't match.":"")}),$(window).on("message",e=>{const t=e.originalEvent.data.user,n=e.originalEvent.data.pass;t&&n&&(this.form_login2(t,n),e.originalEvent.source.close())});var n=amiWebApp.args.userdata||"";_ami_internal_then(amiWebApp.onReady(n),()=>{amiWebApp._isReady=!0,amiWebApp.lock(),amiCommand.certLogin().always((t,n,i,s)=>{this._update(n,i,s).always(()=>{amiWebApp.unlock(),e.resolve()})})},t=>{amiWebApp.unlock(),e.reject(t)})}).fail(t=>{e.reject(t)}),e.promise()},_showSuccessMessage1:function(e){amiWebApp.success(e,!0,"#C0D13C0C_BA64_4A79_BF48_1A35F26D19AC"),this._clean()},_showErrorMessage1:function(e){amiWebApp.error(e,!0,"#C0D13C0C_BA64_4A79_BF48_1A35F26D19AC"),this._clean()},_showSuccessMessage2:function(e){amiWebApp.success(e,!0,"#C76F40DA_0480_4D3F_A74B_65735465EA25"),this._clean()},_showErrorMessage2:function(e){amiWebApp.error(e,!0,"#C76F40DA_0480_4D3F_A74B_65735465EA25"),this._clean()},_showSuccessMessage3:function(e){amiWebApp.success(e,!0,"#F14D98EC_5751_4C15_B4A1_927BA76AFCA6"),this._clean()},_showErrorMessage3:function(e){amiWebApp.error(e,!0,"#F14D98EC_5751_4C15_B4A1_927BA76AFCA6"),this._clean()},_flush:function(){$("#C0D13C0C_BA64_4A79_BF48_1A35F26D19AC").empty(),$("#C76F40DA_0480_4D3F_A74B_65735465EA25").empty(),$("#F14D98EC_5751_4C15_B4A1_927BA76AFCA6").empty()},_clean:function(){$("#B7894CC1_1DAA_4A7E_B7D1_DBDF6F06AC73").trigger("reset"),$("#EE055CD4_E58F_4834_8020_986AE3F8D67D").trigger("reset"),$("#DA2047A2_9E5D_420D_B6E7_FA261D2EF10F").trigger("reset"),$("#E92A1097_983B_4857_875F_07E4659B41B0").trigger("reset")},_update:function(e,t,n){const i=$.Deferred(),s=this.user=e.AMIUser||"",r=this.guest=e.guestUser||"",a=this.clientDN=e.clientDNInSession||"",o=this.issuerDN=e.issuerDNInSession||"";$("#A09AE316_7068_4BC1_96A9_6B87D28863FE").prop("disabled",!a||!o),this.roleInfo=t,this.ssoInfo=n;const l={sso_name:n.name||"SSO",sso_url:n.url||"N/A"};if(s!==r){const t=e.valid||"false",n=e.certEnabled||"false",r=e.vomsEnabled||"false",c=e.firstName||"",p=e.lastName||"",u=e.email||"",h=e.clientDNInAMI||"",d=e.issuerDNInAMI||"";$("#E513F27D_5521_4B08_BF61_52AFB81356F7").val(c),$("#AFF0B5C0_BEEC_4842_916D_DCBA7F589195").val(p),$("#C587486B_62C0_4B6E_9288_D8F9F89D157B").val(u),$("#ABEB0291_40B0_414A_A42B_E7EABB9B487E").val(c),$("#A5AFDB62_1034_4F66_A3E6_9341B31FA290").val(p),$("#D730A774_05EA_47AB_A0C8_D92753802E3E").val(u),$("#D1BEE3BF_9161_41DC_BC53_C44FFE4D2522").val(h),$("#C76805D7_1E86_4231_9071_1D04783423BB").val(a),$("#F42FAF6B_2C8D_4142_8BD9_E5BCDCAA05AA").val(d),$("#FE2F6232_C256_4B80_939C_EBEC90320308").val(o),$("#C587486B_62C0_4B6E_9288_D8F9F89D157B").prop("disabled","false"!==r);let f="",m="";"false"!==t?("false"!==n&&h&&d&&(a&&o?h===a&&d===o||(m="The certificate in your session is not the one registered in AMI."):m="You should provide a certificate to use this AMI web application."),$("#D944B01D_2E8D_4EE9_9DCC_2691438BBA16").html(m?'<span class="fa fa-exclamation-triangle" style="color: orange;"></span> '+m:""),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").parent().css("background",'url("images/account-green.png") center center'),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").css("color","#006400"),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").text(" valid "),f="orange"):(m="false"!==r?h&&d?"Check your VOMS roles.":"Register a valid GRID certificate.":"Contact the AMI team.",$("#D944B01D_2E8D_4EE9_9DCC_2691438BBA16").html(m?'<span class="fa fa-exclamation-triangle" style="color: red;"></span> '+m:""),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").parent().css("background",'url("images/account-pink.png") center center'),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").css("color","#8B0000"),$("#F3FF9F43_DE72_40BB_B1BA_B7B3C9002671").text(" invalid "),f="red");const g=m?'<a class="nav-link" href="javascript:amiLogin.accountStatus();" style="color: '+f+';"><i class="fa fa-exclamation-triangle"></i></a>':"";l.user=s,l.icon=g,amiWebApp.triggerLogin().always(()=>{amiWebApp.replaceHTML("#ami_login_content",this.fragmentLogoutButton,{dict:l}),i.resolve()})}else amiWebApp.triggerLogout().always(()=>{i.resolve(),amiWebApp.replaceHTML("#ami_login_content",this.fragmentLoginButton,{dict:l})});return i.promise()},getUser:function(){return this.user},getGuest:function(){return this.guest},getClientDN:function(){return this.clientDN},getIssuerDN:function(){return this.issuerDN},isAuthenticated:function(){return this.user!==this.guest},hasRole:function(e){return e in this.roleInfo},sso:function(){this._flush(),this._clean(),window.open(this.ssoInfo.url+"?originURL="+encodeURIComponent(amiWebApp.originURL),"Single Sign-On","menubar=no, status=no, scrollbars=no, width=800, height=450")},signIn:function(){this._flush(),this._clean(),$("#D2B5FADE_97A3_4B8C_8561_7A9AEACDBE5B").modal("show")},changeInfo:function(){this._flush(),this._clean(),$("#D9EAF998_ED8E_44D2_A0BE_8C5CF5E438BD").modal("show")},changePass:function(){this._flush(),this._clean(),$("#E92A1097_983B_4857_875F_07E4659B41B0").modal("show")},accountStatus:function(){this._flush(),this._clean(),$("#AB1CB183_96EB_4116_8A9E_4409BE058F34").modal("show")},signOut:function(){return amiWebApp.lock(),amiCommand.logout().always((e,t,n,i)=>{this._update(t,n,i).done(()=>{this._clean(),amiWebApp.unlock()})})},_serializeForm:function(e){const t={};return e.serializeArray().forEach(e=>{t[e.name.trim()]=e.value.trim()}),t},form_login:function(e){e.preventDefault();const t=this._serializeForm($(e.target));return this.form_login2(t.user,t.pass)},form_login2:function(e,t){const n=e&&t?amiCommand.passLogin(e,t):amiCommand.certLogin();amiWebApp.lock(),n.then((e,t,n,i)=>{this._update(t,n,i).done(()=>{if(t.AMIUser!==t.guestUser)$("#D2B5FADE_97A3_4B8C_8561_7A9AEACDBE5B").modal("hide"),this._clean(),amiWebApp.unlock();else{let e="Authentication failed.";(t.clientDNInSession||t.issuerDNInSession)&&(e+=" Client DN in session: "+amiWebApp.textToHtml(t.clientDNInSession)+". Issuer DN in session: "+amiWebApp.textToHtml(t.issuerDNInSession)+"."),this._showErrorMessage1(e)}})},(e,t,n,i)=>{this._update(t,n,i).done(()=>{this._showErrorMessage1(amiWebApp.jspath("..error.$",e))})})},form_attachCert:function(){const e=$("#E64F24B2_33E6_4DED_9B24_28BE04219613").val(),t=$("#A4DFD039_034F_4D10_9668_385AEF4FBBB9").val();e&&t?(amiWebApp.lock(),amiCommand.attachCert(e,t).then(e=>{this._showSuccessMessage1(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage1(amiWebApp.jspath("..error.$",e))})):this._showErrorMessage1("Please, fill all fields with a red star.")},form_detachCert:function(){const e=$("#E64F24B2_33E6_4DED_9B24_28BE04219613").val(),t=$("#A4DFD039_034F_4D10_9668_385AEF4FBBB9").val();e&&t?(amiWebApp.lock(),amiCommand.detachCert(e,t).then(e=>{this._showSuccessMessage1(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage1(amiWebApp.jspath("..error.$",e))})):this._showErrorMessage1("Please, fill all fields with a red star.")},form_addUser:function(e){e.preventDefault();const t=this._serializeForm($(e.target));amiWebApp.lock(),amiCommand.addUser(t.login,t.pass,t.first_name,t.last_name,t.email,"attach"in t).then(e=>{this._showSuccessMessage1(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage1(amiWebApp.jspath("..error.$",e))})},form_remindPass:function(e){e.preventDefault();const t=this._serializeForm($(e.target));amiWebApp.lock(),amiCommand.resetPass(t.user).then(e=>{this._showSuccessMessage1(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage1(amiWebApp.jspath("..error.$",e))})},form_changeInfo:function(e){e.preventDefault();const t=this._serializeForm($(e.target));amiWebApp.lock(),amiCommand.changeInfo(t.first_name,t.last_name,t.email).then(e=>{this._showSuccessMessage2(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage2(amiWebApp.jspath("..error.$",e))})},form_changePass:function(e){e.preventDefault();const t=this._serializeForm($(e.target));amiWebApp.lock(),amiCommand.changePass(t.old_pass,t.new_pass).then(e=>{this._showSuccessMessage3(amiWebApp.jspath("..info.$",e))},e=>{this._showErrorMessage3(amiWebApp.jspath("..error.$",e))})}});var amiDoc={functions:[{name:"$AMINamespace",desc:"Create a new namespace",params:[{name:"$name",type:"String",desc:"the namespace name",default:"",optional:"",nullable:""},{name:"$descr",type:"Object",desc:"the namespace body",default:"",optional:!0,nullable:""}]},{name:"$AMIInterface",desc:"Create a new interface",params:[{name:"$name",type:"String",desc:"the interface name",default:"",optional:"",nullable:""},{name:"$descr",type:"Object",desc:"the interface body",default:"",optional:!0,nullable:""}]},{name:"$AMIClass",desc:"Create a new class",params:[{name:"$name",type:"String",desc:"the class name",default:"",optional:"",nullable:""},{name:"$descr",type:"Object",desc:"the class body",default:"",optional:!0,nullable:""}]}],namespaces:[{name:"amiRouter",desc:"The AMI url routing subsystem",functions:[{name:"getScriptURL",desc:"Gets the AWF's script URL",params:[],returns:[{type:"String",desc:"The AWF's script URL"}]},{name:"getOriginURL",desc:"Gets the origin URL",params:[],returns:[{type:"String",desc:"The origin URL"}]},{name:"getWebAppURL",desc:"Gets the webapp URL",params:[],returns:[{type:"String",desc:"The webapp URL"}]},{name:"getHash",desc:"Gets the anchor part of the webapp URL",params:[],returns:[{type:"String",desc:"The anchor part of the webapp URL"}]},{name:"getArgs",desc:"Gets the arguments extracted from the webapp URL",params:[],returns:[{type:"Array.<String>",desc:"The arguments extracted from the webapp URL"}]},{name:"append",desc:"Appends a routing rule",params:[{name:"regExp",type:"String",desc:"the regExp",default:"",optional:"",nullable:""},{name:"handler",type:"Object",desc:"the handler",default:"",optional:"",nullable:""}],returns:[{type:"Namespace",desc:"The amiRouter singleton"}]},{name:"remove",desc:"Removes some routing rules",params:[{name:"regExp",type:"String",desc:"the regExp",default:"",optional:"",nullable:""}],returns:[{type:"Namespace",desc:"The amiRouter singleton"}]},{name:"check",desc:"Checks whether the URL matches with a routing rule",params:[],returns:[{type:"Boolean",desc:""}]},{name:"appendHistoryEntry",desc:"Append a new history entry",params:[{name:"path",type:"String",desc:"the new path",default:"",optional:"",nullable:""},{name:"context",type:"Object",desc:"the new context",default:"",optional:!0,nullable:""}],returns:[{type:"Boolean",desc:""}]},{name:"replaceHistoryEntry",desc:"Replace the current history entry",params:[{name:"path",type:"String",desc:"the new path",default:"",optional:"",nullable:""},{name:"context",type:"Object",desc:"the new context",default:"",optional:!0,nullable:""}],returns:[{type:"Boolean",desc:""}]}]},{name:"amiWebApp",desc:"The AMI webapp subsystem",variables:[{name:"originURL",type:"String",desc:"The origin URL"},{name:"webAppURL",type:"String",desc:"The webapp URL"},{name:"hash",type:"String",desc:"The anchor part of the webapp URL"},{name:"args",type:"Array.<String>",desc:"The arguments extracted from the webapp URL"}],functions:[{name:"isEmbedded",desc:"Checks whether the WebApp is executed in embedded mode",params:[],returns:[{type:"Boolean",desc:""}]},{name:"isLocal",desc:"Checks whether the WebApp is executed locally (file://, localhost or 127.0.0.1)",params:[],returns:[{type:"Boolean",desc:""}]},{name:"textToHtml",desc:"Escapes the given string from text to HTML",params:[{name:"string",type:"String",desc:"the unescaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The escaped string"}]},{name:"htmlToText",desc:"Unescapes the given string from HTML to text",params:[{name:"string",type:"String",desc:"the escaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The unescaped string"}]},{name:"textToString",desc:"Escapes the given string from text to JavaScript string",params:[{name:"string",type:"String",desc:"the unescaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The escaped string"}]},{name:"stringToText",desc:"Unescapes the given string from JavaScript string to text",params:[{name:"string",type:"String",desc:"the escaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The unescaped string"}]},{name:"htmlToString",desc:"Escapes the given string from HTML to JavaScript string",params:[{name:"string",type:"String",desc:"the unescaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The escaped string"}]},{name:"stringToHtml",desc:"Unescapes the given string from JavaScript string to HTML",params:[{name:"string",type:"String",desc:"the escaped string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The unescaped string"}]},{name:"base64Encode",desc:"Encodes (RFC 4648) a string",params:[{name:"string",type:"String",desc:"the decoded string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The encoded string"}]},{name:"base64Decode",desc:"Decodes (RFC 4648) a string",params:[{name:"string",type:"String",desc:"the encoded string",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The decoded string"}]},{name:"loadResources",desc:"Loads resources asynchronously by extension",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadSheets",desc:"Loads CSS sheets asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadScripts",desc:"Loads JS scripts asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadJSONs",desc:"Loads JSON files asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadXMLs",desc:"Loads XML files asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadHTMLs",desc:"Loads HTML files asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadTWIGs",desc:"Loads TWIG files asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadTexts",desc:"Loads text files asynchronously",params:[{name:"urls",type:["Array","String"],desc:"the array of urls",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"replaceHTML",desc:"Puts a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"prependHTML",desc:"Prepends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"appendHTML",desc:"Appends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"formatTWIG",desc:"Interpretes the given TWIG string, see {@link http://twig.sensiolabs.org/documentation}",params:[{name:"twig",type:"String",desc:"the TWIG string",default:"",optional:"",nullable:""},{name:"dict",type:["Object","Array"],desc:"the dictionary",default:"",optional:!0,nullable:""}],returns:[{type:"String",desc:"The Interpreted TWIG string"}]},{name:"jspath",desc:"Finds data within the given JSON, see {@link https://github.com/dfilatov/jspath}",params:[{name:"path",type:"String",desc:"the path",default:"",optional:"",nullable:""},{name:"json",type:"Object",desc:"the JSON",default:"",optional:"",nullable:""}],returns:[{type:"Array",desc:"The resulting array"}]},{name:"lock",desc:"Locks the web application",params:[]},{name:"unlock",desc:"Unlocks the web application",params:[]},{name:"canLeave",desc:"Enables the message in a confirmation dialog box to inform that the user is about to leave the current page.",params:[]},{name:"cannotLeave",desc:"Disables the message in a confirmation dialog box to inform that the user is about to leave the current page.",params:[]},{name:"info",desc:"Shows an 'info' message",params:[{name:"message",type:["String","Array"],desc:"the message",default:"",optional:"",nullable:""},{name:"fadeOut",type:"Boolean",desc:"if True, the message disappears after 60s",default:"",optional:!0,nullable:""},{name:"id",type:"String",desc:"the target id",default:"",optional:!0,nullable:""}]},{name:"success",desc:"Shows a 'success' message",params:[{name:"message",type:["String","Array"],desc:"the message",default:"",optional:"",nullable:""},{name:"fadeOut",type:"Boolean",desc:"if True, the message disappears after 60s",default:"",optional:!0,nullable:""},{name:"id",type:"String",desc:"the target id",default:"",optional:!0,nullable:""}]},{name:"warning",desc:"Shows a 'warning' message",params:[{name:"message",type:["String","Array"],desc:"the message",default:"",optional:"",nullable:""},{name:"fadeOut",type:"Boolean",desc:"if True, the message disappears after 60s",default:"",optional:!0,nullable:""},{name:"id",type:"String",desc:"the target id",default:"",optional:!0,nullable:""}]},{name:"error",desc:"Shows an 'error' message",params:[{name:"message",type:["String","Array"],desc:"the message",default:"",optional:"",nullable:""},{name:"fadeOut",type:"Boolean",desc:"if True, the message disappears after 60s",default:"",optional:!0,nullable:""},{name:"id",type:"String",desc:"the target id",default:"",optional:!0,nullable:""}]},{name:"flush",desc:"Flushes messages",params:[]},{name:"fillBreadcrumb",desc:"Fill the main breadcrumb",params:[{name:"items",type:"Array",desc:"the array of items (HTML format)",default:"",optional:"",nullable:""}]},{name:"start",desc:"Starts the web application",params:[{name:"settings",type:"Object",desc:"dictionary of settings (logo_url, home_url, contact_email, about_url, theme_url, locker_url)",default:"",optional:!0,nullable:""}]},{name:"loadControl",desc:"Loads a control asynchronously",params:[{name:"control",type:"String",desc:"the array of control name",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"createControl",desc:"Create a control asynchronously",params:[{name:"parent",type:"Object",desc:"???",default:"",optional:"",nullable:""},{name:"owner",type:"Object",desc:"???",default:"",optional:!0,nullable:""},{name:"control",type:"String",desc:"???",default:"",optional:"",nullable:""},{name:"params",type:"Array.<String>",desc:"???",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadSubApp",desc:"Loads a subapp asynchronously",params:[{name:"subapp",type:"String",desc:"the subapp",default:"",optional:"",nullable:""},{name:"userdata",type:"?",desc:"the user data",default:"",optional:!0,nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"loadSubAppByURL",desc:"Loads a subapp by URL",params:[{name:"defaultSubApp",type:"String",desc:"if 'amiWebApp.args[\"subapp\"]' is null, the default subapp",default:"",optional:"",nullable:""},{name:"defaultUserData",type:"?",desc:"if 'amiWebApp.args[\"userdata\"]' is null, the default user data",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]}],events:[{name:"onReady",desc:"This method must be overloaded and is called when the web application starts",params:[{name:"userData",type:"String",desc:"",default:"",optional:"",nullable:""}]},{name:"onRefresh",desc:"This method must be overloaded and is called when the toolbar needs to be updated",params:[{name:"isAuth",type:"Boolean",desc:"",default:"",optional:"",nullable:""}]}]},{name:"amiCommand",desc:"The AMI command subsystem",variables:[{name:"endpoint",type:"String",desc:"Default endpoint"},{name:"converter",type:"String",desc:"Default converter"}],functions:[{name:"execute",desc:"Executes an AMI command",params:[{name:"command",type:"String",desc:"the command",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, endpoint, converter, extraParam, extraValue)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"passLogin",desc:"Logs in by login/password",params:[{name:"user",type:"String",desc:"the user",default:"",optional:"",nullable:""},{name:"pass",type:"String",desc:"the password",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"certLogin",desc:"Logs in by certificate",params:[{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"logout",desc:"Logs out",params:[{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"attachCert",desc:"Attaches a certificate",params:[{name:"user",type:"String",desc:"the user",default:"",optional:"",nullable:""},{name:"pass",type:"String",desc:"the password",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"detachCert",desc:"Detaches a certificate",params:[{name:"user",type:"String",desc:"the user",default:"",optional:"",nullable:""},{name:"pass",type:"String",desc:"the password",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"addUser",desc:"Adds a new user",params:[{name:"user",type:"String",desc:"the user",default:"",optional:"",nullable:""},{name:"pass",type:"String",desc:"the password",default:"",optional:"",nullable:""},{name:"firstName",type:"String",desc:"the first name",default:"",optional:"",nullable:""},{name:"lastName",type:"String",desc:"the last name",default:"",optional:"",nullable:""},{name:"email",type:"String",desc:"the email",default:"",optional:"",nullable:""},{name:"attach",type:"Boolean",desc:"attach the current certificate",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"changeInfo",desc:"Changes the account information",params:[{name:"firstName",type:"String",desc:"the first name",default:"",optional:"",nullable:""},{name:"lastName",type:"String",desc:"the last name",default:"",optional:"",nullable:""},{name:"email",type:"String",desc:"the email",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"changePass",desc:"Changes the account password",params:[{name:"oldPass",type:"String",desc:"the old password",default:"",optional:"",nullable:""},{name:"newPass",type:"String",desc:"the new password",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"resetPass",desc:"Resets the account password",params:[{name:"user",type:"String",desc:"the user",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]}]},{name:"amiLogin",desc:"The AMI authentication subsystem",functions:[{name:"getUser",desc:"Gets the current user",params:[],returns:[{type:"String",desc:"The current user"}]},{name:"getGuest",desc:"Gets the guest user",params:[],returns:[{type:"String",desc:"The guest user"}]},{name:"getClientDN",desc:"Gets the client DN",params:[],returns:[{type:"String",desc:"The client DN"}]},{name:"getIssuerDN",desc:"Gets the issuer DN",params:[],returns:[{type:"String",desc:"The issuer DN"}]},{name:"isAuthenticated",desc:"Checks whether the user is authenticated",params:[],returns:[{type:"Boolean",desc:""}]},{name:"hasRole",desc:"Checks whether the user has the given role",params:[{name:"role",type:"String",desc:"the role",default:"",optional:"",nullable:""}],returns:[{type:"Boolean",desc:""}]},{name:"sso",desc:"Opens the 'SSO' modal window",params:[]},{name:"signIn",desc:"Opens the 'SignIn' modal window",params:[]},{name:"changeInfo",desc:"Opens the 'Change Info' modal window",params:[]},{name:"changePass",desc:"Opens the 'Change Password' modal window",params:[]},{name:"accountStatus",desc:"Opens the 'Account Status' modal window",params:[]},{name:"signOut",desc:"Signs out",params:[]}]}],interfaces:[{name:"ami.IControl",desc:"The AMI control interface",implements:[],inherits:[],functions:[{name:"patchId",desc:"Patches an HTML identifier",params:[{name:"id",type:"String",desc:"the unpatched HTML identifier",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The patched HTML identifier"}]},{name:"replaceHTML",desc:"Puts a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"prependHTML",desc:"Prepends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"appendHTML",desc:"Appends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"onReady",desc:"Called when the control is ready to run",params:[]}]},{name:"ami.ISubApp",desc:"The AMI sub-application interface",implements:[],inherits:[],functions:[{name:"onReady",desc:"Called when the sub-application is ready to run",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onExit",desc:"Called when the sub-application is about to exit",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onLogin",desc:"Called when logging in",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onLogout",desc:"Called when logging out",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]}]}],classes:[{name:"ami.Control",desc:"The basic AMI control",implements:["ami.IControl"],inherits:[],konstructor:{name:"Control",params:[]},functions:[{name:"patchId",desc:"Patches an HTML identifier",params:[{name:"id",type:"String",desc:"the unpatched HTML identifier",default:"",optional:"",nullable:""}],returns:[{type:"String",desc:"The patched HTML identifier"}]},{name:"replaceHTML",desc:"Puts a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"prependHTML",desc:"Prepends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"appendHTML",desc:"Appends a HTML or TWIG fragment to the given target, see method [formatTWIG]{@link #jsdoc_method_formatTWIG}",params:[{name:"selector",type:"String",desc:"the target selector",default:"",optional:"",nullable:""},{name:"twig",type:"String",desc:"the TWIG fragment",default:"",optional:"",nullable:""},{name:"settings",type:"Object",desc:"dictionary of settings (context, dict)",default:"",optional:!0,nullable:""}],returns:[{type:"$.Deferred",desc:"A JQuery deferred object"}]},{name:"onReady",desc:"Called when the control is ready to run",params:[]}]},{name:"ami.SubApp",desc:"The basic AMI sub-application",implements:["ami.ISubApp"],inherits:[],konstructor:{name:"SubApp",params:[]},functions:[{name:"onReady",desc:"Called when the sub-application is ready to run",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onExit",desc:"Called when the sub-application is about to exit",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onLogin",desc:"Called when logging in",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]},{name:"onLogout",desc:"Called when logging out",params:[{name:"userdata",type:"?",desc:"userdata",default:"",optional:"",nullable:""}]}]}]};