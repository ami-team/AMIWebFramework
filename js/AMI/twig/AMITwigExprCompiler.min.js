/*!
 * AMI Web Framework
 *
 * Copyright (c) 2014-2015 The AMI Team
 * http://www.cecill.info/licences/Licence_CeCILL-C_V1-en.html
 *
 */
;function _ami_internal_isNum(b){for(var a in b){if(ami.tokenizer.isDigit(b[a])===false){return false}}return true}function _ami_internal_isStr(a){return a[0]==="'"||a[0]==='"'}function _ami_internal_isSId(b){if(ami.tokenizer.isAlpha(b[0])===false&&b[0]!=="_"){return false}for(var a in b){if(ami.tokenizer.isAlNum(b[a])===false&&b[a]!=="_"){return false}}return true}$AMINamespace("ami.twig.expr.tokens",{$init:function(){this.types={or:this.LOGICAL_OR,and:this.LOGICAL_AND,"b-or":this.BITWISE_OR,"b-xor":this.BITWISE_XOR,"b-and":this.BITWISE_AND,"===":this.STRICT_EQ,"==":this.LOOSE_EQ,"!==":this.STRICT_NE,"!=":this.LOOSE_NE,"<=":this.GTE,">=":this.LTE,"<":this.GT,">":this.LT,is:this.IS,defined:this.DEFINED,"null":this.NULL,empty:this.EMPTY,iterable:this.ITERABLE,even:this.EVEN,odd:this.ODD,starts:this.STARTS,ends:this.ENDS,"with":this.WITH,matches:this.MATCHES,"in":this.IN,"..":this.RANGE,"+":this.PLUS,"-":this.MINUS,"**":this.POWER,"*":this.MUL,"//":this.FLOORDIV,"/":this.DIV,"%":this.MOD,not:this.NOT,".":this.DOT,",":this.COMMA,"(":this.LP,")":this.RP,"[":this.LB,"]":this.RB};this.EQ_NE_GTE_LTE_GT_LT=[this.STRICT_EQ,this.LOOSE_EQ,this.STRICT_NE,this.LOOSE_NE,this.GTE,this.LTE,this.GT,this.LT];this.IS_XXX=[this.DEFINED,this.NULL,this.EMPTY,this.ITERABLE,this.EVEN,this.ODD];this.XXX_WITH=[this.STARTS,this.ENDS];this.PLUS_MINUS=[this.PLUS,this.MINUS];this.MUL_DIV_MOD=[this.MUL,this.FLOORDIV,this.DIV,this.MOD];this.NOT_PLUS_MINUS=[this.NOT,this.PLUS,this.MINUS];this.TERMINAL=[this.NUM,this.STR]},LOGICAL_OR:100,LOGICAL_AND:101,BITWISE_OR:102,BITWISE_XOR:103,BITWISE_AND:104,STRICT_EQ:105,LOOSE_EQ:106,STRICT_NE:107,LOOSE_NE:108,GTE:109,LTE:110,GT:111,LT:112,IS:113,DEFINED:114,NULL:115,EMPTY:116,ITERABLE:117,EVEN:118,ODD:119,STARTS:120,ENDS:121,WITH:122,MATCHES:123,IN:124,RANGE:125,PLUS:126,MINUS:127,POWER:128,MUL:129,FLOORDIV:130,DIV:131,MOD:132,NOT:133,DOT:134,COMMA:135,LP:200,RP:201,LB:202,RB:203,SID:300,FUN:301,VAR:302,NUM:303,STR:304});$AMIClass("ami.twig.expr.Tokenizer",{$init:function(e,a){this.tokens=ami.tokenizer.tokenize(e,a,[" ","\t","\n"],["b-or","b-xor","b-and","===","==","!==","!=","=","<=",">=","<",">","+","-","**","*","//","/","..",".",",","(",")","[","]"],["'",'"'],"\\");this.types=[];this.i=0;var c;var d;for(var b in this.tokens){c=this.tokens[b];d=ami.twig.expr.tokens.types[c];if(d){this.types.push(d)}else{if(_ami_internal_isNum(c)){this.types.push(ami.twig.expr.tokens.NUM)}else{if(_ami_internal_isStr(c)){this.types.push(ami.twig.expr.tokens.STR)}else{if(_ami_internal_isSId(c)){this.types.push(ami.twig.expr.tokens.SID)}else{throw"syntax error, line `"+a+"`, unknown token `"+c+"`"}}}}}},next:function(a){this.i+=a||1},isEmpty:function(){return this.i>=this.tokens.length},peekToken:function(){return this.tokens[this.i]},peekType:function(){return this.types[this.i]},checkType:function(a){if(this.i<this.tokens.length){var b=this.types[this.i];return(a instanceof Array)?(a.indexOf(b)>=0):(a===b)}return false}});$AMIClass("ami.twig.expr.Compiler",{$init:function(b,a){this.tokenizer=new ami.twig.expr.Tokenizer(this.code=b,this.line=a);this.rootNode=this.parseLogicalOr();if(!this.tokenizer.isEmpty()){throw"syntax error, line `"+this.line+"`, unexpected token `"+this.tokenizer.peekToken()+"`"}},dump:function(){return this.rootNode.dump()},parseLogicalOr:function(){var c=this.parseLogicalAnd();if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_OR)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseLogicalOr();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseLogicalAnd:function(){var c=this.parseBitwiseOr();if(this.tokenizer.checkType(ami.twig.expr.tokens.LOGICAL_AND)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseLogicalAnd();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseBitwiseOr:function(){var c=this.parseBitwiseXor();if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_OR)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseBitwiseOr();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseBitwiseXor:function(){var c=this.parseBitwiseAnd();if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_XOR)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseBitwiseXor();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseBitwiseAnd:function(){var c=this.parseComp();if(this.tokenizer.checkType(ami.twig.expr.tokens.BITWISE_AND)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseBitwiseAnd();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseComp:function(){var d=this.parseAddSub();if(this.tokenizer.checkType(ami.twig.expr.tokens.EQ_NE_GTE_LTE_GT_LT)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseAddSub();b.nodeLeft=d;b.nodeRight=a;d=b}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.IS)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var c=b;if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT)){b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();b.nodeLeft=c;b.nodeRight=null}if(this.tokenizer.checkType(ami.twig.expr.tokens.IS_XXX)){var a=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();c.nodeLeft=d;c.nodeRight=a}else{throw"syntax error, line `"+this.line+"`, `defined`, `null`, `iterable`, `empty`, `even` or `odd` expected"}d=b}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.XXX_WITH)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken()+"with");this.tokenizer.next(2);var a=this.parseAddSub();b.nodeLeft=d;b.nodeRight=a;d=b}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.MATCHES)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseAddSub();b.nodeLeft=d;b.nodeRight=a;d=b}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.IN)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseRange();b.nodeLeft=d;b.nodeRight=a;d=b}}}}}return d},parseAddSub:function(){var c=this.parseMulDiv();if(this.tokenizer.checkType(ami.twig.expr.tokens.PLUS_MINUS)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseAddSub();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseMulDiv:function(){var c=this.parsePower();if(this.tokenizer.checkType(ami.twig.expr.tokens.MUL_DIV_MOD)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parseMulDiv();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parsePower:function(){var c=this.parseNotPlusMinus();if(this.tokenizer.checkType(ami.twig.expr.tokens.POWER)){var b=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var a=this.parsePower();b.nodeLeft=c;b.nodeRight=a;c=b}return c},parseNotPlusMinus:function(){if(this.tokenizer.checkType(ami.twig.expr.tokens.NOT_PLUS_MINUS)){var a=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();var b=this.parseX();a.nodeLeft=b;a.nodeRight=null;return a}return this.parseX()},parseX:function(){var a;if((a=this.parseGroup())){return a}if((a=this.parseFunVar())){return a}if((a=this.parseTerminal())){return a}throw"syntax error, line `"+this.line+"`, syntax error or tuncated expression"},parseGroup:function(){if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();var a=this.parseLogicalOr();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next();return a}else{throw"syntax error, line `"+this.line+"`, `)` expected"}}return null},parseFunVar:function(){var c="_.";if(this.tokenizer.checkType(ami.twig.expr.tokens.SID)){c+=this.tokenizer.peekToken();this.tokenizer.next();while(this.tokenizer.checkType(ami.twig.expr.tokens.DOT)){c+=this.tokenizer.peekToken();this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.SID)){c+=this.tokenizer.peekToken();this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, id expected"}}if(this.tokenizer.checkType(ami.twig.expr.tokens.LP)){this.tokenizer.next();var b=this.parseParams();if(this.tokenizer.checkType(ami.twig.expr.tokens.RP)){this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, `)` expected"}var a=new ami.twig.expr.Node(ami.twig.expr.tokens.VAR,c);a.list=b;return a}else{if(this.tokenizer.checkType(ami.twig.expr.tokens.LB)){this.tokenizer.next();var b=this.parseParams();if(this.tokenizer.checkType(ami.twig.expr.tokens.RB)){this.tokenizer.next()}else{throw"syntax error, line `"+this.line+"`, `]` expected"}var a=new ami.twig.expr.Node(ami.twig.expr.tokens.VAR,c);a.list=b;return a}else{return new ami.twig.expr.Node(ami.twig.expr.tokens.SID,c)}}}return null},parseParams:function(){var a=[];while(this.tokenizer.checkType(ami.twig.expr.tokens.RP)===false){a.push(this.parseLogicalOr());if(this.tokenizer.checkType(ami.twig.expr.tokens.COMMA)===true){this.tokenizer.next()}else{return a}}return a},parseTerminal:function(){if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){var a=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();return a}return null},parseRange:function(){var b=this.parseFunVar();if(b!=null){return b}if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){var c=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.RANGE)){var b=new ami.twig.expr.Node(((ami.twig.expr.tokens.RANGE)),this.tokenizer.peekToken());this.tokenizer.next();if(this.tokenizer.checkType(ami.twig.expr.tokens.TERMINAL)){var a=new ami.twig.expr.Node(this.tokenizer.peekType(),this.tokenizer.peekToken());this.tokenizer.next();b.nodeLeft=c;b.nodeRight=a;return b}}}throw"syntax error, line `"+this.line+"`, invalid range"}});$AMIClass("ami.twig.expr.Node",{$init:function(a,b){this.nodeType=a;this.nodeValue=b;this.nodeLeft=null;this.nodeRight=null;this.list=[]},_dump:function(c,b,f){var e=f[0];c.push("\tnode"+e+' [label="'+this.nodeValue.replace('"','\\"')+'"];');if(this.nodeLeft){var a=++f[0];b.push("\tnode"+e+" -> node"+a+";");this.nodeLeft._dump(c,b,f)}if(this.nodeRight){var a=++f[0];b.push("\tnode"+e+" -> node"+a+";");this.nodeRight._dump(c,b,f)}for(var d in this.list){var a=++f[0];b.push("\tnode"+e+" -> node"+a+";");this.list[d]._dump(c,b,f)}},dump:function(){var b=[];var a=[];this._dump(b,a,[0]);return"digraph ast {\n\trankdir=TB;\n"+b.join("\n")+"\n"+a.join("\n")+"\n}"}});