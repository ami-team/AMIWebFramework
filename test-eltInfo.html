<script type="text/javascript" src="./js/jquery.min.js"></script>
<script type="text/javascript" src="./js/ami.js?embedded"></script>


<script type="text/javascript">

	amiWebApp.onRefresh = function(isAuth) {

		var tab = new this._tabCtor(this);

		if(isAuth)
		{

			tab.render('#myTest', {context: this, card: false}).done(function() {

				tab.appendItem('test', {context: this, active: false, closable: false}).done(function(sel) {

					var table = new this._tableCtor(tab);

						//table.render(sel, 'SearchQuery -catalog=\"mc15_001:production\" -entity=\"dataset\" -sql=\"SELECT d.identifier, d.logicalDatasetName, d.totalEvents, pp0.paramValue AS crossSection_nb,pp1.paramValue AS genFiltEff,pp2.paramValue AS kFactor, MC15a.TOTALEVENTS AS MC15a_events, MC15b.TOTALEVENTS AS MC15b_events, MC15c.TOTALEVENTS AS MC15c_events FROM dataset d LEFT JOIN PHYSICSPARAMETERVALS pp0 ON d.identifier = pp0.datasetFK AND pp0.paramName = \'crossSection\' AND pp0.physicsGroup IN (SELECT DISTINCT CASE WHEN EXISTS (SELECT ppp0.identifier FROM PHYSICSPARAMETERVALS ppp0 WHERE ppp0.paramValue IS NOT NULL AND ppp0.physicsGroup=\'PMG\' AND ppp0.paramName=\'crossSection\' AND ppp0.datasetFK=pp0.datasetFK) THEN \'PMG\' ELSE \'MCGN\' END FROM PHYSICSPARAMETERVALS) LEFT JOIN PHYSICSPARAMETERVALS pp1 ON d.identifier = pp1.datasetFK AND pp1.paramName = \'genFiltEff\' AND pp1.physicsGroup IN (SELECT DISTINCT CASE WHEN EXISTS (SELECT ppp1.identifier FROM PHYSICSPARAMETERVALS ppp1 WHERE ppp1.paramValue IS NOT NULL AND ppp1.physicsGroup=\'PMG\' AND ppp1.paramName=\'genFiltEff\' AND ppp1.datasetFK=pp1.datasetFK) THEN \'PMG\' ELSE \'MCGN\' END FROM PHYSICSPARAMETERVALS) LEFT JOIN PHYSICSPARAMETERVALS pp2 ON d.identifier = pp2.datasetFK AND pp2.paramName = \'kFactor\' AND pp2.physicsGroup IN (SELECT DISTINCT CASE WHEN EXISTS (SELECT ppp2.identifier FROM PHYSICSPARAMETERVALS ppp2 WHERE ppp2.paramValue IS NOT NULL AND ppp2.physicsGroup=\'PMG\' AND ppp2.paramName=\'kFactor\' AND ppp2.datasetFK=pp2.datasetFK) THEN \'PMG\' ELSE \'MCGN\' END FROM PHYSICSPARAMETERVALS) LEFT JOIN (SELECT p.DATASETFK AS DATASETFK, SUM(f.EVENTS) AS TOTALEVENTS FROM PRODSYS_TASK p LEFT JOIN FILES f ON f.datasetFK=p.datasetFK AND f.PRODSYSIDENTIFIER = p.PRODSYSIDENTIFIER AND f.FILESTATUS=\'VALID\' WHERE p.SUBCAMPAIGN=\'MC15a\' AND p.TIDSTATE=\'added\' GROUP BY p.DATASETFK ) MC15a ON MC15a.DATASETFK = d.IDENTIFIER LEFT JOIN (SELECT p.DATASETFK AS DATASETFK, SUM(f.EVENTS) AS TOTALEVENTS FROM PRODSYS_TASK p LEFT JOIN FILES f ON f.datasetFK=p.datasetFK AND f.PRODSYSIDENTIFIER = p.PRODSYSIDENTIFIER AND f.FILESTATUS=\'VALID\' WHERE p.SUBCAMPAIGN=\'MC15b\' AND p.TIDSTATE=\'added\' GROUP BY p.DATASETFK ) MC15b ON MC15b.DATASETFK = d.IDENTIFIER LEFT JOIN (SELECT p.DATASETFK AS DATASETFK, SUM(f.EVENTS) AS TOTALEVENTS FROM PRODSYS_TASK p LEFT JOIN FILES f ON f.datasetFK=p.datasetFK AND f.PRODSYSIDENTIFIER = p.PRODSYSIDENTIFIER AND f.FILESTATUS=\'VALID\' WHERE p.SUBCAMPAIGN=\'MC15c\' AND p.TIDSTATE=\'added\' GROUP BY p.DATASETFK ) MC15c ON MC15c.DATASETFK = d.IDENTIFIER WHERE d.amiStatus = \'VALID\' AND d.dataType != \'LOG\' AND (d.physicsShort LIKE \'Pythia8%\') AND (d.identifier IN (SELECT datasetFK FROM dataset_keywords WHERE keyword=\'ttbar\') AND d.identifier IN (SELECT datasetFK FROM dataset_keywords WHERE keyword=\'sm\')) AND (d.logicalDatasetName LIKE \'mc15%429009%\' OR d.logicalDatasetName LIKE \'mc15%301334%\') AND d.logicalDatasetName LIKE \'mc15_13TeV.429009.Pythia8EvtGen_AU2MSTW2008LO_zprime1000_tt%\' AND d.dataType=\'AOD\'\" -cached', {
						//bug prefix... in SearchQuery
						table.render(sel, 'SearchQuery -catalog=\"mc15_001:production\" -entity=\"dataset\" -sql=\"SELECT d.identifier, d.logicalDatasetName AS `ldn`, d.dataType, d.totalEvents FROM dataset d WHERE d.logicalDatasetName LIKE \'mc15_13TeV.429009.Pythia8EvtGen_AU2MSTW2008LO_zprime1000_tt%\' AND d.dataType=\'AOD\'\"', {
						//table.render(sel, 'SearchQuery -catalog=\"mc15_001:production\" -entity=\"dataset\" -sql=\"SELECT identifier, logicalDatasetName, dataType, totalEvents FROM dataset WHERE logicalDatasetName LIKE \'mc15_13TeV.429009.Pythia8EvtGen_AU2MSTW2008LO_zprime1000_tt%\' AND dataType=\'AOD\'\"', {
						enableCache: false,
						showDetails: true,
						showTools: true,
						canEdit: false,
						catalog: 'mc15_001:production',
						entity: 'dataset',
						primaryField: 'identifier',
						rowset: '',
						start: 1,
						stop: 10,
						orderBy: '',
						orderWay: '',
						expandedLinkedElements: [
							{catalog: 'mc15_001:production', entity: 'physicsParameterVals', fields: ['paramName', 'paramValue', 'units', 'physicsGroup'], keyValMode : true},
							{catalog: 'mc15_001:production', entity: 'dataset_extra', fields: ['field','value'], keyValMode : true},
						]
					});
				});
			});
		}
		else
		{
			$('#myTest').empty();
		}
	};

	amiWebApp.onReady = function() {

		return amiWebApp.loadResources(['ctrl:tab','ctrl:table'],{context:this}).done(function(ctrls) {

			this._tabCtor = ctrls[0];
			this._tableCtor = ctrls[1];
		});
	};

	amiWebApp.start({
		endpoint_url: 'https://ami.in2p3.fr/AMI/servlet/net.hep.atlas.Database.Bookkeeping.AMI.Servlet.FrontEnd'
	});

</script>

<div class="clearfix">
	<div class="nav navbar-nav" id="ami_login_content"></div>
</div>

<div id="ami_alert_content"></div>

<div id="myTest"></div>